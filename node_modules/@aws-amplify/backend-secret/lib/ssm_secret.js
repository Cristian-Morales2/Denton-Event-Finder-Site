import { SecretError } from './secret_error.js';
import { ParameterPathConversions } from '@aws-amplify/platform-core';
/**
 * This class implements Amplify Secret using SSM parameter store.
 */
export class SSMSecretClient {
    ssmClient;
    /**
     * Creates a new instance of SSMSecret.
     */
    constructor(ssmClient) {
        this.ssmClient = ssmClient;
    }
    /**
     * Get a secret from SSM parameter store.
     */
    getSecret = async (backendIdentifier, secretIdentifier) => {
        let secret;
        const name = ParameterPathConversions.toParameterFullPath(backendIdentifier, secretIdentifier.name);
        try {
            const resp = await this.ssmClient.getParameter({
                Name: secretIdentifier.version
                    ? `${name}:${secretIdentifier.version}`
                    : name,
                WithDecryption: true,
            });
            if (resp.Parameter?.Value) {
                secret = {
                    name: secretIdentifier.name,
                    version: resp.Parameter.Version,
                    value: resp.Parameter.Value,
                    lastUpdated: resp.Parameter.LastModifiedDate,
                };
            }
        }
        catch (err) {
            throw SecretError.createInstance(err);
        }
        if (!secret) {
            throw new SecretError(`The value of secret '${secretIdentifier.name}' is undefined`);
        }
        return secret;
    };
    /**
     * List secrets from SSM parameter store.
     */
    listSecrets = async (backendIdentifier) => {
        const path = ParameterPathConversions.toParameterPrefix(backendIdentifier);
        const result = [];
        try {
            const resp = await this.ssmClient.getParametersByPath({
                Path: path,
                WithDecryption: true,
            });
            resp.Parameters?.forEach((param) => {
                if (!param.Name || !param.Value) {
                    return;
                }
                const secretName = param.Name.split('/').pop();
                if (secretName) {
                    result.push({
                        name: secretName,
                        version: param.Version,
                        lastUpdated: param.LastModifiedDate,
                    });
                }
            });
            return result;
        }
        catch (err) {
            throw SecretError.createInstance(err);
        }
    };
    /**
     * Set a secret in SSM parameter store.
     */
    setSecret = async (backendIdentifier, secretName, secretValue) => {
        const name = ParameterPathConversions.toParameterFullPath(backendIdentifier, secretName);
        try {
            const resp = await this.ssmClient.putParameter({
                Name: name,
                Type: 'SecureString',
                Value: secretValue,
                Description: `Amplify Secret`,
                Overwrite: true,
            });
            return {
                name: secretName,
                version: resp.Version,
            };
        }
        catch (err) {
            throw SecretError.createInstance(err);
        }
    };
    /**
     * Remove a secret from SSM parameter store.
     */
    removeSecret = async (backendIdentifier, secretName) => {
        const name = ParameterPathConversions.toParameterFullPath(backendIdentifier, secretName);
        try {
            await this.ssmClient.deleteParameter({
                Name: name,
            });
        }
        catch (err) {
            throw SecretError.createInstance(err);
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3NtX3NlY3JldC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zc21fc2VjcmV0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQVFoRCxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUV0RTs7R0FFRztBQUNILE1BQU0sT0FBTyxlQUFlO0lBSUc7SUFIN0I7O09BRUc7SUFDSCxZQUE2QixTQUFjO1FBQWQsY0FBUyxHQUFULFNBQVMsQ0FBSztJQUFHLENBQUM7SUFFL0M7O09BRUc7SUFDSSxTQUFTLEdBQUcsS0FBSyxFQUN0QixpQkFBNEMsRUFDNUMsZ0JBQWtDLEVBQ2pCLEVBQUU7UUFDbkIsSUFBSSxNQUEwQixDQUFDO1FBQy9CLE1BQU0sSUFBSSxHQUFXLHdCQUF3QixDQUFDLG1CQUFtQixDQUMvRCxpQkFBaUIsRUFDakIsZ0JBQWdCLENBQUMsSUFBSSxDQUN0QixDQUFDO1FBQ0YsSUFBSTtZQUNGLE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUM7Z0JBQzdDLElBQUksRUFBRSxnQkFBZ0IsQ0FBQyxPQUFPO29CQUM1QixDQUFDLENBQUMsR0FBRyxJQUFJLElBQUksZ0JBQWdCLENBQUMsT0FBTyxFQUFFO29CQUN2QyxDQUFDLENBQUMsSUFBSTtnQkFDUixjQUFjLEVBQUUsSUFBSTthQUNyQixDQUFDLENBQUM7WUFDSCxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFO2dCQUN6QixNQUFNLEdBQUc7b0JBQ1AsSUFBSSxFQUFFLGdCQUFnQixDQUFDLElBQUk7b0JBQzNCLE9BQU8sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU87b0JBQy9CLEtBQUssRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUs7b0JBQzNCLFdBQVcsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLGdC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QUFDLEdBQVksQ0FBQyxDQUFDO1NBQ2hEO0lBQ0gsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTU00gfSBmcm9tICdAYXdzLXNkay9jbGllbnQtc3NtJztcbmltcG9ydCB7IFNlY3JldEVycm9yIH0gZnJvbSAnLi9zZWNyZXRfZXJyb3IuanMnO1xuaW1wb3J0IHtcbiAgU2VjcmV0LFxuICBTZWNyZXRDbGllbnQsXG4gIFNlY3JldElkZW50aWZpZXIsXG4gIFNlY3JldExpc3RJdGVtLFxufSBmcm9tICcuL3NlY3JldC5qcyc7XG5pbXBvcnQgeyBBcHBJZCwgQmFja2VuZElkZW50aWZpZXIgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IFBhcmFtZXRlclBhdGhDb252ZXJzaW9ucyB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcblxuLyoqXG4gKiBUaGlzIGNsYXNzIGltcGxlbWVudHMgQW1wbGlmeSBTZWNyZXQgdXNpbmcgU1NNIHBhcmFtZXRlciBzdG9yZS5cbiAqL1xuZXhwb3J0IGNsYXNzIFNTTVNlY3JldENsaWVudCBpbXBsZW1lbnRzIFNlY3JldENsaWVudCB7XG4gIC8qKlxuICAgKiBDcmVhdGVzIGEgbmV3IGluc3RhbmNlIG9mIFNTTVNlY3JldC5cbiAgICovXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgc3NtQ2xpZW50OiBTU00pIHt9XG5cbiAgLyoqXG4gICAqIEdldCBhIHNlY3JldCBmcm9tIFNTTSBwYXJhbWV0ZXIgc3RvcmUuXG4gICAqL1xuICBwdWJsaWMgZ2V0U2VjcmV0ID0gYXN5bmMgKFxuICAgIGJhY2tlbmRJZGVudGlmaWVyOiBCYWNrZW5kSWRlbnRpZmllciB8IEFwcElkLFxuICAgIHNlY3JldElkZW50aWZpZXI6IFNlY3JldElkZW50aWZpZXJcbiAgKTogUHJvbWlzZTxTZWNyZXQ+ID0+IHtcbiAgICBsZXQgc2VjcmV0OiBTZWNyZXQgfCB1bmRlZmluZWQ7XG4gICAgY29uc3QgbmFtZTogc3RyaW5nID0gUGFyYW1ldGVyUGF0aENvbnZlcnNpb25zLnRvUGFyYW1ldGVyRnVsbFBhdGgoXG4gICAgICBiYWNrZW5kSWRlbnRpZmllcixcbiAgICAgIHNlY3JldElkZW50aWZpZXIubmFtZVxuICAgICk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3AgPSBhd2FpdCB0aGlzLnNzbUNsaWVudC5nZXRQYXJhbWV0ZXIoe1xuICAgICAgICBOYW1lOiBzZWNyZXRJZGVudGlmaWVyLnZlcnNpb25cbiAgICAgICAgICA/IGAke25hbWV9OiR7c2VjcmV0SWRlbnRpZmllci52ZXJzaW9ufWBcbiAgICAgICAgICA6IG5hbWUsXG4gICAgICAgIFdpdGhEZWNyeXB0aW9uOiB0cnVlLFxuICAgICAgfSk7XG4gICAgICBpZiAocmVzcC5QYXJhbWV0ZXI/LlZhbHVlKSB7XG4gICAgICAgIHNlY3JldCA9IHtcbiAgICAgICAgICBuYW1lOiBzZWNyZXRJZGVudGlmaWVyLm5hbWUsXG4gICAgICAgICAgdmVyc2lvbjogcmVzcC5QYXJhbWV0ZXIuVmVyc2lvbixcbiAgICAgICAgICB2YWx1ZTogcmVzcC5QYXJhbWV0ZXIuVmFsdWUsXG4gICAgICAgICAgbGFzdFVwZGF0ZWQ6IHJlc3AuUGFyYW1ldGVyLkxhc3RNb2RpZmllZERhdGUsXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aHJvdyBTZWNyZXRFcnJvci5jcmVhdGVJbnN0YW5jZShlcnIgYXMgRXJyb3IpO1xuICAgIH1cblxuICAgIGlmICghc2VjcmV0KSB7XG4gICAgICB0aHJvdyBuZXcgU2VjcmV0RXJyb3IoXG4gICAgICAgIGBUaGUgdmFsdWUgb2Ygc2VjcmV0ICcke3NlY3JldElkZW50aWZpZXIubmFtZX0nIGlzIHVuZGVmaW5lZGBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNlY3JldDtcbiAgfTtcblxuICAvKipcbiAgICogTGlzdCBzZWNyZXRzIGZyb20gU1NNIHBhcmFtZXRlciBzdG9yZS5cbiAgICovXG4gIHB1YmxpYyBsaXN0U2VjcmV0cyA9IGFzeW5jIChcbiAgICBiYWNrZW5kSWRlbnRpZmllcjogQmFja2VuZElkZW50aWZpZXIgfCBBcHBJZFxuICApOiBQcm9taXNlPFNlY3JldExpc3RJdGVtW10+ID0+IHtcbiAgICBjb25zdCBwYXRoID0gUGFyYW1ldGVyUGF0aENvbnZlcnNpb25zLnRvUGFyYW1ldGVyUHJlZml4KGJhY2tlbmRJZGVudGlmaWVyKTtcbiAgICBjb25zdCByZXN1bHQ6IFNlY3JldExpc3RJdGVtW10gPSBbXTtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXNwID0gYXdhaXQgdGhpcy5zc21DbGllbnQuZ2V0UGFyYW1ldGVyc0J5UGF0aCh7XG4gICAgICAgIFBhdGg6IHBhdGgsXG4gICAgICAgIFdpdGhEZWNyeXB0aW9uOiB0cnVlLFxuICAgICAgfSk7XG5cbiAgICAgIHJlc3AuUGFyYW1ldGVycz8uZm9yRWFjaCgocGFyYW0pID0+IHtcbiAgICAgICAgaWYgKCFwYXJhbS5OYW1lIHx8ICFwYXJhbS5WYWx1ZSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzZWNyZXROYW1lID0gcGFyYW0uTmFtZS5zcGxpdCgnLycpLnBvcCgpO1xuICAgICAgICBpZiAoc2VjcmV0TmFtZSkge1xuICAgICAgICAgIHJlc3VsdC5wdXNoKHtcbiAgICAgICAgICAgIG5hbWU6IHNlY3JldE5hbWUsXG4gICAgICAgICAgICB2ZXJzaW9uOiBwYXJhbS5WZXJzaW9uLFxuICAgICAgICAgICAgbGFzdFVwZGF0ZWQ6IHBhcmFtLkxhc3RNb2RpZmllZERhdGUsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRocm93IFNlY3JldEVycm9yLmNyZWF0ZUluc3RhbmNlKGVyciBhcyBFcnJvcik7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBTZXQgYSBzZWNyZXQgaW4gU1NNIHBhcmFtZXRlciBzdG9yZS5cbiAgICovXG4gIHB1YmxpYyBzZXRTZWNyZXQgPSBhc3luYyAoXG4gICAgYmFja2VuZElkZW50aWZpZXI6IEJhY2tlbmRJZGVudGlmaWVyIHwgQXBwSWQsXG4gICAgc2VjcmV0TmFtZTogc3RyaW5nLFxuICAgIHNlY3JldFZhbHVlOiBzdHJpbmdcbiAgKTogUHJvbWlzZTxTZWNyZXRJZGVudGlmaWVyPiA9PiB7XG4gICAgY29uc3QgbmFtZSA9IFBhcmFtZXRlclBhdGhDb252ZXJzaW9ucy50b1BhcmFtZXRlckZ1bGxQYXRoKFxuICAgICAgYmFja2VuZElkZW50aWZpZXIsXG4gICAgICBzZWNyZXROYW1lXG4gICAgKTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcCA9IGF3YWl0IHRoaXMuc3NtQ2xpZW50LnB1dFBhcmFtZXRlcih7XG4gICAgICAgIE5hbWU6IG5hbWUsXG4gICAgICAgIFR5cGU6ICdTZWN1cmVTdHJpbmcnLFxuICAgICAgICBWYWx1ZTogc2VjcmV0VmFsdWUsXG4gICAgICAgIERlc2NyaXB0aW9uOiBgQW1wbGlmeSBTZWNyZXRgLFxuICAgICAgICBPdmVyd3JpdGU6IHRydWUsXG4gICAgICB9KTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIG5hbWU6IHNlY3JldE5hbWUsXG4gICAgICAgIHZlcnNpb246IHJlc3AuVmVyc2lvbixcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aHJvdyBTZWNyZXRFcnJvci5jcmVhdGVJbnN0YW5jZShlcnIgYXMgRXJyb3IpO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogUmVtb3ZlIGEgc2VjcmV0IGZyb20gU1NNIHBhcmFtZXRlciBzdG9yZS5cbiAgICovXG4gIHB1YmxpYyByZW1vdmVTZWNyZXQgPSBhc3luYyAoXG4gICAgYmFja2VuZElkZW50aWZpZXI6IEJhY2tlbmRJZGVudGlmaWVyIHwgQXBwSWQsXG4gICAgc2VjcmV0TmFtZTogc3RyaW5nXG4gICkgPT4ge1xuICAgIGNvbnN0IG5hbWUgPSBQYXJhbWV0ZXJQYXRoQ29udmVyc2lvbnMudG9QYXJhbWV0ZXJGdWxsUGF0aChcbiAgICAgIGJhY2tlbmRJZGVudGlmaWVyLFxuICAgICAgc2VjcmV0TmFtZVxuICAgICk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuc3NtQ2xpZW50LmRlbGV0ZVBhcmFtZXRlcih7XG4gICAgICAgIE5hbWU6IG5hbWUsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRocm93IFNlY3JldEVycm9yLmNyZWF0ZUluc3RhbmNlKGVyciBhcyBFcnJvcik7XG4gICAgfVxuICB9O1xufVxuIl19