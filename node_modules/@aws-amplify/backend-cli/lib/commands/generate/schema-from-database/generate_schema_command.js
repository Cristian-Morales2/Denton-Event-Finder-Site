import { AmplifyFault } from '@aws-amplify/platform-core';
const DEFAULT_OUTPUT = 'amplify/data/schema.sql.ts';
/**
 * Command that generates typescript data schema from sql schema.
 */
export class GenerateSchemaCommand {
    backendIdentifierResolver;
    secretClient;
    schemaGenerator;
    /**
     * @inheritDoc
     */
    command;
    /**
     * @inheritDoc
     */
    describe;
    /**
     * Creates typescript data schema generation command.
     */
    constructor(backendIdentifierResolver, secretClient, schemaGenerator) {
        this.backendIdentifierResolver = backendIdentifierResolver;
        this.secretClient = secretClient;
        this.schemaGenerator = schemaGenerator;
        this.command = 'schema-from-database';
        this.describe = 'Generates typescript data schema from a SQL database';
    }
    /**
     * @inheritDoc
     */
    handler = async (args) => {
        const backendIdentifier = await this.backendIdentifierResolver.resolve(args);
        if (!backendIdentifier) {
            throw new AmplifyFault('BackendIdentifierFault', {
                message: 'Could not resolve the backend identifier',
            });
        }
        const secretName = args.connectionUriSecret;
        const outputFile = args.out;
        const connectionUriSecret = await this.secretClient.getSecret(backendIdentifier, {
            name: secretName,
        });
        await this.schemaGenerator.generate({
            connectionUri: {
                secretName,
                value: connectionUriSecret.value,
            },
            out: outputFile,
        });
    };
    /**
     * @inheritDoc
     */
    builder = (yargs) => {
        return yargs
            .option('stack', {
            conflicts: ['app-id', 'branch'],
            describe: 'A stack name that contains an Amplify backend',
            type: 'string',
            array: false,
            group: 'Stack identifier',
        })
            .option('app-id', {
            conflicts: ['stack'],
            describe: 'The Amplify App ID of the project',
            type: 'string',
            array: false,
            implies: 'branch',
            group: 'Project identifier',
        })
            .option('branch', {
            conflicts: ['stack'],
            describe: 'A git branch of the Amplify project',
            type: 'string',
            array: false,
            group: 'Project identifier',
            implies: 'appId',
        })
            .option('out', {
            describe: 'A path to directory where generated schema is written.',
            default: DEFAULT_OUTPUT,
            type: 'string',
            array: false,
            group: 'Schema Generation',
        })
            .option('connection-uri-secret', {
            describe: 'Amplify secret name for the database connection uri',
            type: 'string',
            array: false,
            group: 'Schema Generation',
            demandOption: true,
        });
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGVfc2NoZW1hX2NvbW1hbmQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tbWFuZHMvZ2VuZXJhdGUvc2NoZW1hLWZyb20tZGF0YWJhc2UvZ2VuZXJhdGVfc2NoZW1hX2NvbW1hbmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBTUEsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRTFELE1BQU0sY0FBYyxHQUFHLDRCQUE0QixDQUFDO0FBYXBEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLHFCQUFxQjtJQWlCYjtJQUNBO0lBQ0E7SUFoQm5COztPQUVHO0lBQ00sT0FBTyxDQUFTO0lBRXpCOztPQUVHO0lBQ00sUUFBUSxDQUFTO0lBRTFCOztPQUVHO0lBQ0gsWUFDbUIseUJBQW9ELEVBQ3BELFlBQTBCLEVBQzFCLGVBQWdDO1FBRmhDLDhCQUF5QixHQUF6Qix5QkFBeUIsQ0FBMkI7UUFDcEQsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBRWpELElBQUksQ0FBQyxPQUFPLEdBQUcsc0JBQXNCLENBQUM7UUFDdEMsSUFBSSxDQUFDLFFBQVEsR0FBRyxzREFBc0QsQ0FBQztJQUN6RSxDQUFDO0lBRUQ7O09BRUc7SUFDSCxPQUFPLEdBQUcsS0FBSyxFQUNiLElBQXNELEVBQ3ZDLEVBQUU7UUFDakIsTUFBTSxpQkFBaUIsR0FBRyxNQUFNLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxPQUFPLENBQ3BFLElBQUksQ0FDTCxDQUFDO1FBRUYsSUFBSSxDQUFDLGlCQUFpQixFQUFFO1lBQ3RCLE1BQU0sSUFBSSxZQUFZLENBQUMsd0JBQXdCLEVBQUU7Z0JBQy9DLE9BQU8sRUFBRSwwQ0FBMEM7YUFDcEQsQ0FBQyxDQUFDO1NBQ0o7UUFFRCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsbUJBQTZCLENBQUM7UUFDdEQsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQWEsQ0FBQztRQUV0QyxNQUFNLG1CQUFtQixHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQzNELGlCQUFzQyxFQUN0QztZQUNFLElBQUksRUFBRSxVQUFVO1NBQ2pCLENBQ0YsQ0FBQztRQUVGLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUM7WUFDbEMsYUFBYSxFQUFFO2dCQUNiLFVBQVU7Z0JBQ1YsS0FBSyxFQUFFLG1CQUFtQixDQUFDLEtBQUs7YUFDakM7WUFDRCxHQUFHLEVBQUUsVUFBVTtTQUNoQixDQUFDLENBQUM7SUFDTCxDQUFDLENBQUM7SUFFRjs7T0FFRztJQUNILE9BQU8sR0FBRyxDQUFDLEtBQVcsRUFBc0MsRUFBRTtRQUM1RCxPQUFPLEtBQUs7YUFDVCxNQUFNLENBQUMsT0FBTyxFQUFFO1lBQ2YsU0FBUyxFQUFFLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQztZQUMvQixRQUFRLEVBQUUsK0NBQStDO1lBQ3pELElBQUksRUFBRSxRQUFRO1lBQ2QsS0FBSyxFQUFFLEtBQUs7WUFDWixLQUFLLEVBQUUsa0JBQWtCO1NBQzFCLENBQUM7YUFDRCxNQUFNLENBQUMsUUFBUSxFQUFFO1lBQ2hCLFNBQVMsRUFBRSxDQUFDLE9BQU8sQ0FBQztZQUNwQixRQUFRLEVBQUUsbUNBQW1DO1lBQzdDLElBQUksRUFBRSxRQUFRO1lBQ2QsS0FBSyxFQUFFLEtBQUs7WUFDWixPQUFPLEVBQUUsUUFBUTtZQUNqQixLQUFLLEVBQUUsb0JBQW9CO1NBQzVCLENBQUM7YUFDRCxNQUFNLENBQUMsUUFBUSxFQUFFO1lBQ2hCLFNBQVMsRUFBRSxDQUFDLE9BQU8sQ0FBQztZQUNwQixRQUFRLEVBQUUscUNBQXFDO1lBQy9DLElBQUksRUFBRSxRQUFRO1lBQ2QsS0FBSyxFQUFFLEtBQUs7WUFDWixLQUFLLEVBQUUsb0JBQW9CO1lBQzNCLE9BQU8sRUFBRSxPQUFPO1NBQ2pCLENBQUM7YUFDRCxNQUFNLENBQUMsS0FBSyxFQUFFO1lBQ2IsUUFBUSxFQUFFLHdEQUF3RDtZQUNsRSxPQUFPLEVBQUUsY0FBYztZQUN2QixJQUFJLEVBQUUsUUFBUTtZQUNkLEtBQUssRUFBRSxLQUFLO1lBQ1osS0FBSyxFQUFFLG1CQUFtQjtTQUMzQixDQUFDO2FBQ0QsTUFBTSxDQUFDLHVCQUF1QixFQUFFO1lBQy9CLFFBQVEsRUFBRSxxREFBcUQ7WUFDL0QsSUFBSSxFQUFFLFFBQVE7WUFDZCxLQUFLLEVBQUUsS0FBSztZQUNaLEtBQUssRUFBRSxtQkFBbUI7WUFDMUIsWUFBWSxFQUFFLElBQUk7U0FDbkIsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcmd1bWVudHNDYW1lbENhc2UsIEFyZ3YsIENvbW1hbmRNb2R1bGUgfSBmcm9tICd5YXJncyc7XG5pbXBvcnQgeyBCYWNrZW5kSWRlbnRpZmllclJlc29sdmVyIH0gZnJvbSAnLi4vLi4vLi4vYmFja2VuZC1pZGVudGlmaWVyL2JhY2tlbmRfaWRlbnRpZmllcl9yZXNvbHZlci5qcyc7XG5pbXBvcnQgeyBBcmd1bWVudHNLZWJhYkNhc2UgfSBmcm9tICcuLi8uLi8uLi9rZWJhYl9jYXNlLmpzJztcbmltcG9ydCB7IFNlY3JldENsaWVudCB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLXNlY3JldCc7XG5pbXBvcnQgeyBCYWNrZW5kSWRlbnRpZmllciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHsgU2NoZW1hR2VuZXJhdG9yIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3NjaGVtYS1nZW5lcmF0b3InO1xuaW1wb3J0IHsgQW1wbGlmeUZhdWx0IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuXG5jb25zdCBERUZBVUxUX09VVFBVVCA9ICdhbXBsaWZ5L2RhdGEvc2NoZW1hLnNxbC50cyc7XG5cbmV4cG9ydCB0eXBlIEdlbmVyYXRlU2NoZW1hQ29tbWFuZE9wdGlvbnMgPVxuICBBcmd1bWVudHNLZWJhYkNhc2U8R2VuZXJhdGVTY2hlbWFDb21tYW5kT3B0aW9uc0NhbWVsQ2FzZT47XG5cbnR5cGUgR2VuZXJhdGVTY2hlbWFDb21tYW5kT3B0aW9uc0NhbWVsQ2FzZSA9IHtcbiAgc3RhY2s6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgYXBwSWQ6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgYnJhbmNoOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIG91dDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBjb25uZWN0aW9uVXJpU2VjcmV0OiBzdHJpbmcgfCB1bmRlZmluZWQ7XG59O1xuXG4vKipcbiAqIENvbW1hbmQgdGhhdCBnZW5lcmF0ZXMgdHlwZXNjcmlwdCBkYXRhIHNjaGVtYSBmcm9tIHNxbCBzY2hlbWEuXG4gKi9cbmV4cG9ydCBjbGFzcyBHZW5lcmF0ZVNjaGVtYUNvbW1hbmRcbiAgaW1wbGVtZW50cyBDb21tYW5kTW9kdWxlPG9iamVjdCwgR2VuZXJhdGVTY2hlbWFDb21tYW5kT3B0aW9ucz5cbntcbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICByZWFkb25seSBjb21tYW5kOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICByZWFkb25seSBkZXNjcmliZTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBDcmVhdGVzIHR5cGVzY3JpcHQgZGF0YSBzY2hlbWEgZ2VuZXJhdGlvbiBjb21tYW5kLlxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBiYWNrZW5kSWRlbnRpZmllclJlc29sdmVyOiBCYWNrZW5kSWRlbnRpZmllclJlc29sdmVyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgc2VjcmV0Q2xpZW50OiBTZWNyZXRDbGllbnQsXG4gICAgcHJpdmF0ZSByZWFkb25seSBzY2hlbWFHZW5lcmF0b3I6IFNjaGVtYUdlbmVyYXRvclxuICApIHtcbiAgICB0aGlzLmNvbW1hbmQgPSAnc2NoZW1hLWZyb20tZGF0YWJhc2UnO1xuICAgIHRoaXMuZGVzY3JpYmUgPSAnR2VuZXJhdGVzIHR5cGVzY3JpcHQgZGF0YSBzY2hlbWEgZnJvbSBhIFNRTCBkYXRhYmFzZSc7XG4gIH1cblxuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIGhhbmRsZXIgPSBhc3luYyAoXG4gICAgYXJnczogQXJndW1lbnRzQ2FtZWxDYXNlPEdlbmVyYXRlU2NoZW1hQ29tbWFuZE9wdGlvbnM+XG4gICk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIGNvbnN0IGJhY2tlbmRJZGVudGlmaWVyID0gYXdhaXQgdGhpcy5iYWNrZW5kSWRlbnRpZmllclJlc29sdmVyLnJlc29sdmUoXG4gICAgICBhcmdzXG4gICAgKTtcblxuICAgIGlmICghYmFja2VuZElkZW50aWZpZXIpIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5RmF1bHQoJ0JhY2tlbmRJZGVudGlmaWVyRmF1bHQnLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdDb3VsZCBub3QgcmVzb2x2ZSB0aGUgYmFja2VuZCBpZGVudGlmaWVyJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHNlY3JldE5hbWUgPSBhcmdzLmNvbm5lY3Rpb25VcmlTZWNyZXQgYXMgc3RyaW5nO1xuICAgIGNvbnN0IG91dHB1dEZpbGUgPSBhcmdzLm91dCBhcyBzdHJpbmc7XG5cbiAgICBjb25zdCBjb25uZWN0aW9uVXJpU2VjcmV0ID0gYXdhaXQgdGhpcy5zZWNyZXRDbGllbnQuZ2V0U2VjcmV0KFxuICAgICAgYmFja2VuZElkZW50aWZpZXIgYXMgQmFja2VuZElkZW50aWZpZXIsXG4gICAgICB7XG4gICAgICAgIG5hbWU6IHNlY3JldE5hbWUsXG4gICAgICB9XG4gICAgKTtcblxuICAgIGF3YWl0IHRoaXMuc2NoZW1hR2VuZXJhdG9yLmdlbmVyYXRlKHtcbiAgICAgIGNvbm5lY3Rpb25Vcmk6IHtcbiAgICAgICAgc2VjcmV0TmFtZSxcbiAgICAgICAgdmFsdWU6IGNvbm5lY3Rpb25VcmlTZWNyZXQudmFsdWUsXG4gICAgICB9LFxuICAgICAgb3V0OiBvdXRwdXRGaWxlLFxuICAgIH0pO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgYnVpbGRlciA9ICh5YXJnczogQXJndik6IEFyZ3Y8R2VuZXJhdGVTY2hlbWFDb21tYW5kT3B0aW9ucz4gPT4ge1xuICAgIHJldHVybiB5YXJnc1xuICAgICAgLm9wdGlvbignc3RhY2snLCB7XG4gICAgICAgIGNvbmZsaWN0czogWydhcHAtaWQnLCAnYnJhbmNoJ10sXG4gICAgICAgIGRlc2NyaWJlOiAnQSBzdGFjayBuYW1lIHRoYXQgY29udGFpbnMgYW4gQW1wbGlmeSBiYWNrZW5kJyxcbiAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgZ3JvdXA6ICdTdGFjayBpZGVudGlmaWVyJyxcbiAgICAgIH0pXG4gICAgICAub3B0aW9uKCdhcHAtaWQnLCB7XG4gICAgICAgIGNvbmZsaWN0czogWydzdGFjayddLFxuICAgICAgICBkZXNjcmliZTogJ1RoZSBBbXBsaWZ5IEFwcCBJRCBvZiB0aGUgcHJvamVjdCcsXG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgIGltcGxpZXM6ICdicmFuY2gnLFxuICAgICAgICBncm91cDogJ1Byb2plY3QgaWRlbnRpZmllcicsXG4gICAgICB9KVxuICAgICAgLm9wdGlvbignYnJhbmNoJywge1xuICAgICAgICBjb25mbGljdHM6IFsnc3RhY2snXSxcbiAgICAgICAgZGVzY3JpYmU6ICdBIGdpdCBicmFuY2ggb2YgdGhlIEFtcGxpZnkgcHJvamVjdCcsXG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgIGdyb3VwOiAnUHJvamVjdCBpZGVudGlmaWVyJyxcbiAgICAgICAgaW1wbGllczogJ2FwcElkJyxcbiAgICAgIH0pXG4gICAgICAub3B0aW9uKCdvdXQnLCB7XG4gICAgICAgIGRlc2NyaWJlOiAnQSBwYXRoIHRvIGRpcmVjdG9yeSB3aGVyZSBnZW5lcmF0ZWQgc2NoZW1hIGlzIHdyaXR0ZW4uJyxcbiAgICAgICAgZGVmYXVsdDogREVGQVVMVF9PVVRQVVQsXG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgIGdyb3VwOiAnU2NoZW1hIEdlbmVyYXRpb24nLFxuICAgICAgfSlcbiAgICAgIC5vcHRpb24oJ2Nvbm5lY3Rpb24tdXJpLXNlY3JldCcsIHtcbiAgICAgICAgZGVzY3JpYmU6ICdBbXBsaWZ5IHNlY3JldCBuYW1lIGZvciB0aGUgZGF0YWJhc2UgY29ubmVjdGlvbiB1cmknLFxuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICBncm91cDogJ1NjaGVtYSBHZW5lcmF0aW9uJyxcbiAgICAgICAgZGVtYW5kT3B0aW9uOiB0cnVlLFxuICAgICAgfSk7XG4gIH07XG59XG4iXX0=