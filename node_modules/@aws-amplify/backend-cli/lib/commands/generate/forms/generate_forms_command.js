import path from 'path';
import { graphqlOutputKey } from '@aws-amplify/backend-output-schemas';
import { DEFAULT_UI_PATH } from '../../../form-generation/default_form_generation_output_paths.js';
/**
 * Command that generates UI forms.
 */
export class GenerateFormsCommand {
    backendIdentifierResolver;
    backendOutputClientBuilder;
    formGenerationHandler;
    /**
     * @inheritDoc
     */
    command;
    /**
     * @inheritDoc
     */
    describe;
    /**
     * Creates UI forms generation command.
     */
    constructor(backendIdentifierResolver, backendOutputClientBuilder, formGenerationHandler) {
        this.backendIdentifierResolver = backendIdentifierResolver;
        this.backendOutputClientBuilder = backendOutputClientBuilder;
        this.formGenerationHandler = formGenerationHandler;
        this.command = 'forms';
        this.describe = 'Generates UI forms';
    }
    getBackendIdentifier = async (args) => {
        return await this.backendIdentifierResolver.resolve(args);
    };
    /**
     * @inheritDoc
     */
    handler = async (args) => {
        const backendIdentifier = await this.backendIdentifierResolver.resolve(args);
        if (!backendIdentifier) {
            throw new Error('Could not resolve the backend identifier');
        }
        const backendOutputClient = this.backendOutputClientBuilder();
        const output = await backendOutputClient.getOutput(backendIdentifier);
        if (!(graphqlOutputKey in output) || !output[graphqlOutputKey]) {
            throw new Error('No GraphQL API configured for this backend.');
        }
        const apiUrl = output[graphqlOutputKey].payload.amplifyApiModelSchemaS3Uri;
        if (!args.outDir) {
            throw new Error('out-dir must be defined');
        }
        const outDir = args.outDir;
        await this.formGenerationHandler.generate({
            modelsOutDir: path.join(outDir, 'graphql'),
            backendIdentifier,
            uiOutDir: outDir,
            apiUrl,
            modelsFilter: args.models,
        });
    };
    /**
     * @inheritDoc
     */
    builder = (yargs) => {
        return yargs
            .option('stack', {
            conflicts: ['app-id', 'branch'],
            describe: 'A stack name that contains an Amplify backend',
            type: 'string',
            array: false,
            group: 'Stack identifier',
        })
            .option('app-id', {
            conflicts: ['stack'],
            describe: 'The Amplify App ID of the project',
            type: 'string',
            array: false,
            implies: 'branch',
            group: 'Project identifier',
        })
            .option('branch', {
            conflicts: ['stack'],
            describe: 'A git branch of the Amplify project',
            type: 'string',
            array: false,
            group: 'Project identifier',
            implies: 'appId',
        })
            .option('out-dir', {
            describe: 'A path to directory where generated forms are written.',
            default: DEFAULT_UI_PATH,
            type: 'string',
            array: false,
            group: 'Form Generation',
        })
            .option('models', {
            describe: 'Model name to generate',
            type: 'string',
            array: true,
            group: 'Form Generation',
        });
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGVfZm9ybXNfY29tbWFuZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21tYW5kcy9nZW5lcmF0ZS9mb3Jtcy9nZW5lcmF0ZV9mb3Jtc19jb21tYW5kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUd4QixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUV2RSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sa0VBQWtFLENBQUM7QUFlbkc7O0dBRUc7QUFDSCxNQUFNLE9BQU8sb0JBQW9CO0lBaUJaO0lBQ0E7SUFDQTtJQWhCbkI7O09BRUc7SUFDTSxPQUFPLENBQVM7SUFFekI7O09BRUc7SUFDTSxRQUFRLENBQVM7SUFFMUI7O09BRUc7SUFDSCxZQUNtQix5QkFBb0QsRUFDcEQsMEJBQXFELEVBQ3JELHFCQUE0QztRQUY1Qyw4QkFBeUIsR0FBekIseUJBQXlCLENBQTJCO1FBQ3BELCtCQUEwQixHQUExQiwwQkFBMEIsQ0FBMkI7UUFDckQsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUF1QjtRQUU3RCxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN2QixJQUFJLENBQUMsUUFBUSxHQUFHLG9CQUFvQixDQUFDO0lBQ3ZDLENBQUM7SUFFRCxvQkFBb0IsR0FBRyxLQUFLLEVBQUUsSUFBaUMsRUFBRSxFQUFFO1FBQ2pFLE9BQU8sTUFBTSxJQUFJLENBQUMseUJBQXlCLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVELENBQUMsQ0FBQztJQUVGOztPQUVHO0lBQ0gsT0FBTyxHQUFHLEtBQUssRUFDYixJQUFxRCxFQUN0QyxFQUFFO1FBQ2pCLE1BQU0saUJBQWlCLEdBQUcsTUFBTSxJQUFJLENBQUMseUJBQXlCLENBQUMsT0FBTyxDQUNwRSxJQUFJLENBQ0wsQ0FBQztRQUVGLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUN0QixNQUFNLElBQUksS0FBSyxDQUFDLDBDQUEwQyxDQUFDLENBQUM7U0FDN0Q7UUFFRCxNQUFNLG1CQUFtQixHQUFHLElBQUksQ0FBQywwQkFBMEIsRUFBRSxDQUFDO1FBRTlELE1BQU0sTUFBTSxHQUFHLE1BQU0sbUJBQW1CLENBQUMsU0FBUyxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFFdEUsSUFBSSxDQUFDLENBQUMsZ0JBQWdCLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsRUFBRTtZQUM5RCxNQUFNLElBQUksS0FBSyxDQUFDLDZDQUE2QyxDQUFDLENBQUM7U0FDaEU7UUFFRCxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxPQUFPLENBQUMsMEJBQTBCLENBQUM7UUFFM0UsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDaEIsTUFBTSxJQUFJLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1NBQzVDO1FBRUQsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUUzQixNQUFNLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxRQUFRLENBQUM7WUFDeEMsWUFBWSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQztZQUMxQyxpQkFBaUI7WUFDakIsUUFBUSxFQUFFLE1BQU07WUFDaEIsTUFBTTtZQUNOLFlBQVksRUFBRSxJQUFJLENBQUMsTUFBTTtTQUMxQixDQUFDLENBQUM7SUFDTCxDQUFDLENBQUM7SUFFRjs7T0FFRztJQUNILE9BQU8sR0FBRyxDQUFDLEtBQVcsRUFBcUMsRUFBRTtRQUMzRCxPQUFPLEtBQUs7YUFDVCxNQUFNLENBQUMsT0FBTyxFQUFFO1lBQ2YsU0FBUyxFQUFFLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQztZQUMvQixRQUFRLEVBQUUsK0NBQStDO1lBQ3pELElBQUksRUFBRSxRQUFRO1lBQ2QsS0FBSyxFQUFFLEtBQUs7WUFDWixLQUFLLEVBQUUsa0JBQWtCO1NBQzFCLENBQUM7YUFDRCxNQUFNLENBQUMsUUFBUSxFQUFFO1lBQ2hCLFNBQVMsRUFBRSxDQUFDLE9BQU8sQ0FBQztZQUNwQixRQUFRLEVBQUUsbUNBQW1DO1lBQzdDLElBQUksRUFBRSxRQUFRO1lBQ2QsS0FBSyxFQUFFLEtBQUs7WUFDWixPQUFPLEVBQUUsUUFBUTtZQUNqQixLQUFLLEVBQUUsb0JBQW9CO1NBQzVCLENBQUM7YUFDRCxNQUFNLENBQUMsUUFBUSxFQUFFO1lBQ2hCLFNBQVMsRUFBRSxDQUFDLE9BQU8sQ0FBQztZQUNwQixRQUFRLEVBQUUscUNBQXFDO1lBQy9DLElBQUksRUFBRSxRQUFRO1lBQ2QsS0FBSyxFQUFFLEtBQUs7WUFDWixLQUFLLEVBQUUsb0JBQW9CO1lBQzNCLE9BQU8sRUFBRSxPQUFPO1NBQ2pCLENBQUM7YUFDRCxNQUFNLENBQUMsU0FBUyxFQUFFO1lBQ2pCLFFBQVEsRUFBRSx3REFBd0Q7WUFDbEUsT0FBTyxFQUFFLGVBQWU7WUFDeEIsSUFBSSxFQUFFLFFBQVE7WUFDZCxLQUFLLEVBQUUsS0FBSztZQUNaLEtBQUssRUFBRSxpQkFBaUI7U0FDekIsQ0FBQzthQUNELE1BQU0sQ0FBQyxRQUFRLEVBQUU7WUFDaEIsUUFBUSxFQUFFLHdCQUF3QjtZQUNsQyxJQUFJLEVBQUUsUUFBUTtZQUNkLEtBQUssRUFBRSxJQUFJO1lBQ1gsS0FBSyxFQUFFLGlCQUFpQjtTQUN6QixDQUFDLENBQUM7SUFDUCxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgQXJndW1lbnRzQ2FtZWxDYXNlLCBBcmd2LCBDb21tYW5kTW9kdWxlIH0gZnJvbSAneWFyZ3MnO1xuaW1wb3J0IHsgQmFja2VuZE91dHB1dENsaWVudCB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9kZXBsb3llZC1iYWNrZW5kLWNsaWVudCc7XG5pbXBvcnQgeyBncmFwaHFsT3V0cHV0S2V5IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0IHsgQmFja2VuZElkZW50aWZpZXJSZXNvbHZlciB9IGZyb20gJy4uLy4uLy4uL2JhY2tlbmQtaWRlbnRpZmllci9iYWNrZW5kX2lkZW50aWZpZXJfcmVzb2x2ZXIuanMnO1xuaW1wb3J0IHsgREVGQVVMVF9VSV9QQVRIIH0gZnJvbSAnLi4vLi4vLi4vZm9ybS1nZW5lcmF0aW9uL2RlZmF1bHRfZm9ybV9nZW5lcmF0aW9uX291dHB1dF9wYXRocy5qcyc7XG5pbXBvcnQgeyBGb3JtR2VuZXJhdGlvbkhhbmRsZXIgfSBmcm9tICcuLi8uLi8uLi9mb3JtLWdlbmVyYXRpb24vZm9ybV9nZW5lcmF0aW9uX2hhbmRsZXIuanMnO1xuaW1wb3J0IHsgQXJndW1lbnRzS2ViYWJDYXNlIH0gZnJvbSAnLi4vLi4vLi4va2ViYWJfY2FzZS5qcyc7XG5cbmV4cG9ydCB0eXBlIEdlbmVyYXRlRm9ybXNDb21tYW5kT3B0aW9ucyA9XG4gIEFyZ3VtZW50c0tlYmFiQ2FzZTxHZW5lcmF0ZUZvcm1zQ29tbWFuZE9wdGlvbnNDYW1lbENhc2U+O1xuXG50eXBlIEdlbmVyYXRlRm9ybXNDb21tYW5kT3B0aW9uc0NhbWVsQ2FzZSA9IHtcbiAgc3RhY2s6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgYXBwSWQ6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgYnJhbmNoOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIG91dERpcjogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBtb2RlbHM6IHN0cmluZ1tdIHwgdW5kZWZpbmVkO1xufTtcblxuLyoqXG4gKiBDb21tYW5kIHRoYXQgZ2VuZXJhdGVzIFVJIGZvcm1zLlxuICovXG5leHBvcnQgY2xhc3MgR2VuZXJhdGVGb3Jtc0NvbW1hbmRcbiAgaW1wbGVtZW50cyBDb21tYW5kTW9kdWxlPG9iamVjdCwgR2VuZXJhdGVGb3Jtc0NvbW1hbmRPcHRpb25zPlxue1xuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIHJlYWRvbmx5IGNvbW1hbmQ6IHN0cmluZztcblxuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIHJlYWRvbmx5IGRlc2NyaWJlOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgVUkgZm9ybXMgZ2VuZXJhdGlvbiBjb21tYW5kLlxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBiYWNrZW5kSWRlbnRpZmllclJlc29sdmVyOiBCYWNrZW5kSWRlbnRpZmllclJlc29sdmVyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYmFja2VuZE91dHB1dENsaWVudEJ1aWxkZXI6ICgpID0+IEJhY2tlbmRPdXRwdXRDbGllbnQsXG4gICAgcHJpdmF0ZSByZWFkb25seSBmb3JtR2VuZXJhdGlvbkhhbmRsZXI6IEZvcm1HZW5lcmF0aW9uSGFuZGxlclxuICApIHtcbiAgICB0aGlzLmNvbW1hbmQgPSAnZm9ybXMnO1xuICAgIHRoaXMuZGVzY3JpYmUgPSAnR2VuZXJhdGVzIFVJIGZvcm1zJztcbiAgfVxuXG4gIGdldEJhY2tlbmRJZGVudGlmaWVyID0gYXN5bmMgKGFyZ3M6IEdlbmVyYXRlRm9ybXNDb21tYW5kT3B0aW9ucykgPT4ge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmJhY2tlbmRJZGVudGlmaWVyUmVzb2x2ZXIucmVzb2x2ZShhcmdzKTtcbiAgfTtcblxuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIGhhbmRsZXIgPSBhc3luYyAoXG4gICAgYXJnczogQXJndW1lbnRzQ2FtZWxDYXNlPEdlbmVyYXRlRm9ybXNDb21tYW5kT3B0aW9ucz5cbiAgKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgY29uc3QgYmFja2VuZElkZW50aWZpZXIgPSBhd2FpdCB0aGlzLmJhY2tlbmRJZGVudGlmaWVyUmVzb2x2ZXIucmVzb2x2ZShcbiAgICAgIGFyZ3NcbiAgICApO1xuXG4gICAgaWYgKCFiYWNrZW5kSWRlbnRpZmllcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgcmVzb2x2ZSB0aGUgYmFja2VuZCBpZGVudGlmaWVyJyk7XG4gICAgfVxuXG4gICAgY29uc3QgYmFja2VuZE91dHB1dENsaWVudCA9IHRoaXMuYmFja2VuZE91dHB1dENsaWVudEJ1aWxkZXIoKTtcblxuICAgIGNvbnN0IG91dHB1dCA9IGF3YWl0IGJhY2tlbmRPdXRwdXRDbGllbnQuZ2V0T3V0cHV0KGJhY2tlbmRJZGVudGlmaWVyKTtcblxuICAgIGlmICghKGdyYXBocWxPdXRwdXRLZXkgaW4gb3V0cHV0KSB8fCAhb3V0cHV0W2dyYXBocWxPdXRwdXRLZXldKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIEdyYXBoUUwgQVBJIGNvbmZpZ3VyZWQgZm9yIHRoaXMgYmFja2VuZC4nKTtcbiAgICB9XG5cbiAgICBjb25zdCBhcGlVcmwgPSBvdXRwdXRbZ3JhcGhxbE91dHB1dEtleV0ucGF5bG9hZC5hbXBsaWZ5QXBpTW9kZWxTY2hlbWFTM1VyaTtcblxuICAgIGlmICghYXJncy5vdXREaXIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignb3V0LWRpciBtdXN0IGJlIGRlZmluZWQnKTtcbiAgICB9XG5cbiAgICBjb25zdCBvdXREaXIgPSBhcmdzLm91dERpcjtcblxuICAgIGF3YWl0IHRoaXMuZm9ybUdlbmVyYXRpb25IYW5kbGVyLmdlbmVyYXRlKHtcbiAgICAgIG1vZGVsc091dERpcjogcGF0aC5qb2luKG91dERpciwgJ2dyYXBocWwnKSxcbiAgICAgIGJhY2tlbmRJZGVudGlmaWVyLFxuICAgICAgdWlPdXREaXI6IG91dERpcixcbiAgICAgIGFwaVVybCxcbiAgICAgIG1vZGVsc0ZpbHRlcjogYXJncy5tb2RlbHMsXG4gICAgfSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICBidWlsZGVyID0gKHlhcmdzOiBBcmd2KTogQXJndjxHZW5lcmF0ZUZvcm1zQ29tbWFuZE9wdGlvbnM+ID0+IHtcbiAgICByZXR1cm4geWFyZ3NcbiAgICAgIC5vcHRpb24oJ3N0YWNrJywge1xuICAgICAgICBjb25mbGljdHM6IFsnYXBwLWlkJywgJ2JyYW5jaCddLFxuICAgICAgICBkZXNjcmliZTogJ0Egc3RhY2sgbmFtZSB0aGF0IGNvbnRhaW5zIGFuIEFtcGxpZnkgYmFja2VuZCcsXG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgIGdyb3VwOiAnU3RhY2sgaWRlbnRpZmllcicsXG4gICAgICB9KVxuICAgICAgLm9wdGlvbignYXBwLWlkJywge1xuICAgICAgICBjb25mbGljdHM6IFsnc3RhY2snXSxcbiAgICAgICAgZGVzY3JpYmU6ICdUaGUgQW1wbGlmeSBBcHAgSUQgb2YgdGhlIHByb2plY3QnLFxuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICBpbXBsaWVzOiAnYnJhbmNoJyxcbiAgICAgICAgZ3JvdXA6ICdQcm9qZWN0IGlkZW50aWZpZXInLFxuICAgICAgfSlcbiAgICAgIC5vcHRpb24oJ2JyYW5jaCcsIHtcbiAgICAgICAgY29uZmxpY3RzOiBbJ3N0YWNrJ10sXG4gICAgICAgIGRlc2NyaWJlOiAnQSBnaXQgYnJhbmNoIG9mIHRoZSBBbXBsaWZ5IHByb2plY3QnLFxuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICBncm91cDogJ1Byb2plY3QgaWRlbnRpZmllcicsXG4gICAgICAgIGltcGxpZXM6ICdhcHBJZCcsXG4gICAgICB9KVxuICAgICAgLm9wdGlvbignb3V0LWRpcicsIHtcbiAgICAgICAgZGVzY3JpYmU6ICdBIHBhdGggdG8gZGlyZWN0b3J5IHdoZXJlIGdlbmVyYXRlZCBmb3JtcyBhcmUgd3JpdHRlbi4nLFxuICAgICAgICBkZWZhdWx0OiBERUZBVUxUX1VJX1BBVEgsXG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgIGdyb3VwOiAnRm9ybSBHZW5lcmF0aW9uJyxcbiAgICAgIH0pXG4gICAgICAub3B0aW9uKCdtb2RlbHMnLCB7XG4gICAgICAgIGRlc2NyaWJlOiAnTW9kZWwgbmFtZSB0byBnZW5lcmF0ZScsXG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICBhcnJheTogdHJ1ZSxcbiAgICAgICAgZ3JvdXA6ICdGb3JtIEdlbmVyYXRpb24nLFxuICAgICAgfSk7XG4gIH07XG59XG4iXX0=