"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.parseUserDefinedSlots = exports.getSlotName = exports.separateSlots = exports.validateFunctionSlots = void 0;
/**
 * Validate that only supported props are being passed into the funciton slots.
 * @param functionSlots the slot inputs to validate.
 */
const validateFunctionSlots = (functionSlots) => {
    functionSlots.forEach(({ function: { responseMappingTemplate, requestMappingTemplate } }) => {
        if (!requestMappingTemplate && !responseMappingTemplate) {
            throw new Error('Expected at least one of either requestMappingTemplate or responseMappingTemplate');
        }
    });
};
exports.validateFunctionSlots = validateFunctionSlots;
/**
 * We'll partition any slots have both a request and response mapping template into two to make the existing system work.
 * @param functionSlots the possibly consolidated slots.
 * @returns no longer consolidated slots.
 */
const separateSlots = (functionSlots) => functionSlots.flatMap((slot) => {
    if (slot.function.requestMappingTemplate && slot.function.responseMappingTemplate) {
        return [
            {
                ...slot,
                function: {
                    requestMappingTemplate: slot.function.requestMappingTemplate,
                },
            },
            {
                ...slot,
                function: {
                    responseMappingTemplate: slot.function.responseMappingTemplate,
                },
            },
        ];
    }
    return [slot];
});
exports.separateSlots = separateSlots;
/**
 * Given a set of strongly typed input params, generate a valid transformer slot name.
 * @param params the slot configuration
 * @returns the slot id
 */
const getSlotName = (params) => [
    params.typeName,
    params.fieldName,
    params.slotName,
    params.slotIndex,
    params.function.requestMappingTemplate ? 'req' : 'res',
    'vtl',
].join('.');
exports.getSlotName = getSlotName;
/**
 * Utility to avoid using lodash.
 * @param obj the object to deeply set values in.
 * @param path the access path.
 * @param val the value to set.
 */
const setIn = (obj, path, val) => {
    if (path.length === 1) {
        // eslint-disable-next-line no-param-reassign
        obj[path[0]] = val;
        return;
    }
    if (!obj[path[0]]) {
        // eslint-disable-next-line no-param-reassign
        obj[path[0]] = {};
    }
    setIn(obj[path[0]], path.slice(1), val);
};
const parseUserDefinedSlots = (userDefinedTemplates) => {
    const groupedResolversMap = {};
    userDefinedTemplates
        .map((slot) => [
        (0, exports.getSlotName)(slot),
        slot.function.requestMappingTemplate
            ? slot.function.requestMappingTemplate.renderTemplate()
            : slot.function.responseMappingTemplate?.renderTemplate() ?? '',
    ])
        .forEach(([fileName, template]) => {
        const slicedSlotName = fileName.split('.');
        const resolverType = slicedSlotName[slicedSlotName.length - 2] === 'res' ? 'responseResolver' : 'requestResolver';
        const resolverName = [slicedSlotName[0], slicedSlotName[1]].join('.');
        const slotName = slicedSlotName[2];
        const resolverOrder = `order${Number(slicedSlotName[3]) || 0}`;
        const resolver = {
            fileName,
            template,
        };
        const slotHash = `${resolverName}#${slotName}`;
        // because a slot can have a request and response resolver, we need to group corresponding request and response resolvers
        if (slotHash in groupedResolversMap && resolverOrder in groupedResolversMap[slotHash]) {
            setIn(groupedResolversMap, [slotHash, resolverOrder, resolverType], resolver);
        }
        else {
            const slot = {
                resolverTypeName: slicedSlotName[0],
                resolverFieldName: slicedSlotName[1],
                slotName,
                [resolverType]: resolver,
            };
            setIn(groupedResolversMap, [slotHash, resolverOrder], slot);
        }
    });
    return Object.entries(groupedResolversMap)
        .map(([resolverNameKey, numberedSlots]) => ({
        orderedSlots: Object.entries(numberedSlots)
            .sort(([i], [j]) => i.localeCompare(j))
            .map(([_, slot]) => slot),
        resolverName: resolverNameKey.split('#')[0],
    }))
        .reduce((acc, { orderedSlots, resolverName }) => {
        if (acc[resolverName]) {
            acc[resolverName].push(...orderedSlots);
        }
        else {
            acc[resolverName] = orderedSlots;
        }
        return acc;
    }, {});
};
exports.parseUserDefinedSlots = parseUserDefinedSlots;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlci1kZWZpbmVkLXNsb3RzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2ludGVybmFsL3VzZXItZGVmaW5lZC1zbG90cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFHQTs7O0dBR0c7QUFDSSxNQUFNLHFCQUFxQixHQUFHLENBQUMsYUFBNkIsRUFBUSxFQUFFO0lBQzNFLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLHVCQUF1QixFQUFFLHNCQUFzQixFQUFFLEVBQUUsRUFBRSxFQUFFO1FBQzFGLElBQUksQ0FBQyxzQkFBc0IsSUFBSSxDQUFDLHVCQUF1QixFQUFFO1lBQ3ZELE1BQU0sSUFBSSxLQUFLLENBQUMsbUZBQW1GLENBQUMsQ0FBQztTQUN0RztJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDO0FBTlcsUUFBQSxxQkFBcUIseUJBTWhDO0FBRUY7Ozs7R0FJRztBQUNJLE1BQU0sYUFBYSxHQUFHLENBQUMsYUFBNkIsRUFBa0IsRUFBRSxDQUM3RSxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7SUFDN0IsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLHNCQUFzQixJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsdUJBQXVCLEVBQUU7UUFDakYsT0FBTztZQUNMO2dCQUNFLEdBQUcsSUFBSTtnQkFDUCxRQUFRLEVBQUU7b0JBQ1Isc0JBQXNCLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxzQkFBc0I7aUJBQzdEO2FBQ0Y7WUFDRDtnQkFDRSxHQUFHLElBQUk7Z0JBQ1AsUUFBUSxFQUFFO29CQUNSLHVCQUF1QixFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsdUJBQXVCO2lCQUMvRDthQUNGO1NBQ0YsQ0FBQztLQUNIO0lBQ0QsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ2hCLENBQUMsQ0FBQyxDQUFDO0FBbkJRLFFBQUEsYUFBYSxpQkFt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R0FBRyxDQUFDO0lBQ2IsQ0FBQyxFQUFFLEVBQXVDLENBQUMsQ0FBQztBQUNoRCxDQUFDLENBQUM7QUFwRFcsUUFBQSxxQkFBcUIseUJBb0RoQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFVzZXJEZWZpbmVkU2xvdCwgVXNlckRlZmluZWRSZXNvbHZlciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9ncmFwaHFsLXRyYW5zZm9ybWVyLWNvcmUnO1xuaW1wb3J0IHsgRnVuY3Rpb25TbG90IH0gZnJvbSAnLi4vdHlwZXMnO1xuXG4vKipcbiAqIFZhbGlkYXRlIHRoYXQgb25seSBzdXBwb3J0ZWQgcHJvcHMgYXJlIGJlaW5nIHBhc3NlZCBpbnRvIHRoZSBmdW5jaXRvbiBzbG90cy5cbiAqIEBwYXJhbSBmdW5jdGlvblNsb3RzIHRoZSBzbG90IGlucHV0cyB0byB2YWxpZGF0ZS5cbiAqL1xuZXhwb3J0IGNvbnN0IHZhbGlkYXRlRnVuY3Rpb25TbG90cyA9IChmdW5jdGlvblNsb3RzOiBGdW5jdGlvblNsb3RbXSk6IHZvaWQgPT4ge1xuICBmdW5jdGlvblNsb3RzLmZvckVhY2goKHsgZnVuY3Rpb246IHsgcmVzcG9uc2VNYXBwaW5nVGVtcGxhdGUsIHJlcXVlc3RNYXBwaW5nVGVtcGxhdGUgfSB9KSA9PiB7XG4gICAgaWYgKCFyZXF1ZXN0TWFwcGluZ1RlbXBsYXRlICYmICFyZXNwb25zZU1hcHBpbmdUZW1wbGF0ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdFeHBlY3RlZCBhdCBsZWFzdCBvbmUgb2YgZWl0aGVyIHJlcXVlc3RNYXBwaW5nVGVtcGxhdGUgb3IgcmVzcG9uc2VNYXBwaW5nVGVtcGxhdGUnKTtcbiAgICB9XG4gIH0pO1xufTtcblxuLyoqXG4gKiBXZSdsbCBwYXJ0aXRpb24gYW55IHNsb3RzIGhhdmUgYm90aCBhIHJlcXVlc3QgYW5kIHJlc3BvbnNlIG1hcHBpbmcgdGVtcGxhdGUgaW50byB0d28gdG8gbWFrZSB0aGUgZXhpc3Rpbmcgc3lzdGVtIHdvcmsuXG4gKiBAcGFyYW0gZnVuY3Rpb25TbG90cyB0aGUgcG9zc2libHkgY29uc29saWRhdGVkIHNsb3RzLlxuICogQHJldHVybnMgbm8gbG9uZ2VyIGNvbnNvbGlkYXRlZCBzbG90cy5cbiAqL1xuZXhwb3J0IGNvbnN0IHNlcGFyYXRlU2xvdHMgPSAoZnVuY3Rpb25TbG90czogRnVuY3Rpb25TbG90W10pOiBGdW5jdGlvblNsb3RbXSA9PlxuICBmdW5jdGlvblNsb3RzLmZsYXRNYXAoKHNsb3QpID0+IHtcbiAgICBpZiAoc2xvdC5mdW5jdGlvbi5yZXF1ZXN0TWFwcGluZ1RlbXBsYXRlICYmIHNsb3QuZnVuY3Rpb24ucmVzcG9uc2VNYXBwaW5nVGVtcGxhdGUpIHtcbiAgICAgIHJldHVybiBbXG4gICAgICAgIHtcbiAgICAgICAgICAuLi5zbG90LFxuICAgICAgICAgIGZ1bmN0aW9uOiB7XG4gICAgICAgICAgICByZXF1ZXN0TWFwcGluZ1RlbXBsYXRlOiBzbG90LmZ1bmN0aW9uLnJlcXVlc3RNYXBwaW5nVGVtcGxhdGUsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIC4uLnNsb3QsXG4gICAgICAgICAgZnVuY3Rpb246IHtcbiAgICAgICAgICAgIHJlc3BvbnNlTWFwcGluZ1RlbXBsYXRlOiBzbG90LmZ1bmN0aW9uLnJlc3BvbnNlTWFwcGluZ1RlbXBsYXRlLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICBdO1xuICAgIH1cbiAgICByZXR1cm4gW3Nsb3RdO1xuICB9KTtcblxuLyoqXG4gKiBHaXZlbiBhIHNldCBvZiBzdHJvbmdseSB0eXBlZCBpbnB1dCBwYXJhbXMsIGdlbmVyYXRlIGEgdmFsaWQgdHJhbnNmb3JtZXIgc2xvdCBuYW1lLlxuICogQHBhcmFtIHBhcmFtcyB0aGUgc2xvdCBjb25maWd1cmF0aW9uXG4gKiBAcmV0dXJucyB0aGUgc2xvdCBpZFxuICovXG5leHBvcnQgY29uc3QgZ2V0U2xvdE5hbWUgPSAocGFyYW1zOiBGdW5jdGlvblNsb3QpOiBzdHJpbmcgPT5cbiAgW1xuICAgIHBhcmFtcy50eXBlTmFtZSxcbiAgICBwYXJhbXMuZmllbGROYW1lLFxuICAgIHBhcmFtcy5zbG90TmFtZSxcbiAgICBwYXJhbXMuc2xvdEluZGV4LFxuICAgIHBhcmFtcy5mdW5jdGlvbi5yZXF1ZXN0TWFwcGluZ1RlbXBsYXRlID8gJ3JlcScgOiAncmVzJyxcbiAgICAndnRsJyxcbiAgXS5qb2luKCcuJyk7XG5cbi8qKlxuICogVXRpbGl0eSB0byBhdm9pZCB1c2luZyBsb2Rhc2guXG4gKiBAcGFyYW0gb2JqIHRoZSBvYmplY3QgdG8gZGVlcGx5IHNldCB2YWx1ZXMgaW4uXG4gKiBAcGFyYW0gcGF0aCB0aGUgYWNjZXNzIHBhdGguXG4gKiBAcGFyYW0gdmFsIHRoZSB2YWx1ZSB0byBzZXQuXG4gKi9cbmNvbnN0IHNldEluID0gKG9iajogUmVjb3JkPGFueSwgYW55PiwgcGF0aDogYW55W10sIHZhbDogYW55KTogdm9pZCA9PiB7XG4gIGlmIChwYXRoLmxlbmd0aCA9PT0gMSkge1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1wYXJhbS1yZWFzc2lnblxuICAgIG9ialtwYXRoWzBdXSA9IHZhbDtcbiAgICByZXR1cm47XG4gIH1cbiAgaWYgKCFvYmpbcGF0aFswXV0pIHtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcGFyYW0tcmVhc3NpZ25cbiAgICBvYmpbcGF0aFswXV0gPSB7fTtcbiAgfVxuICBzZXRJbihvYmpbcGF0aFswXV0sIHBhdGguc2xpY2UoMSksIHZhbCk7XG59O1xuXG5leHBvcnQgY29uc3QgcGFyc2VVc2VyRGVmaW5lZFNsb3RzID0gKHVzZXJEZWZpbmVkVGVtcGxhdGVzOiBGdW5jdGlvblNsb3RbXSk6IFJlY29yZDxzdHJpbmcsIFVzZXJEZWZpbmVkU2xvdFtdPiA9PiB7XG4gIHR5cGUgUmVzb2x2ZXJLZXkgPSBzdHJpbmc7XG4gIHR5cGUgUmVzb2x2ZXJPcmRlciA9IG51bWJlcjtcbiAgY29uc3QgZ3JvdXBlZFJlc29sdmVyc01hcDogUmVjb3JkPFJlc29sdmVyS2V5LCBSZWNvcmQ8UmVzb2x2ZXJPcmRlciwgVXNlckRlZmluZWRTbG90Pj4gPSB7fTtcblxuICB1c2VyRGVmaW5lZFRlbXBsYXRlc1xuICAgIC5tYXAoKHNsb3QpID0+IFtcbiAgICAgIGdldFNsb3ROYW1lKHNsb3QpLFxuICAgICAgc2xvdC5mdW5jdGlvbi5yZXF1ZXN0TWFwcGluZ1RlbXBsYXRlXG4gICAgICAgID8gc2xvdC5mdW5jdGlvbi5yZXF1ZXN0TWFwcGluZ1RlbXBsYXRlLnJlbmRlclRlbXBsYXRlKClcbiAgICAgICAgOiBzbG90LmZ1bmN0aW9uLnJlc3BvbnNlTWFwcGluZ1RlbXBsYXRlPy5yZW5kZXJUZW1wbGF0ZSgpID8/ICcnLFxuICAgIF0pXG4gICAgLmZvckVhY2goKFtmaWxlTmFtZSwgdGVtcGxhdGVdKSA9PiB7XG4gICAgICBjb25zdCBzbGljZWRTbG90TmFtZSA9IGZpbGVOYW1lLnNwbGl0KCcuJyk7XG4gICAgICBjb25zdCByZXNvbHZlclR5cGUgPSBzbGljZWRTbG90TmFtZVtzbGljZWRTbG90TmFtZS5sZW5ndGggLSAyXSA9PT0gJ3JlcycgPyAncmVzcG9uc2VSZXNvbHZlcicgOiAncmVxdWVzdFJlc29sdmVyJztcbiAgICAgIGNvbnN0IHJlc29sdmVyTmFtZSA9IFtzbGljZWRTbG90TmFtZVswXSwgc2xpY2VkU2xvdE5hbWVbMV1dLmpvaW4oJy4nKTtcbiAgICAgIGNvbnN0IHNsb3ROYW1lID0gc2xpY2VkU2xvdE5hbWVbMl07XG4gICAgICBjb25zdCByZXNvbHZlck9yZGVyID0gYG9yZGVyJHtOdW1iZXIoc2xpY2VkU2xvdE5hbWVbM10pIHx8IDB9YDtcbiAgICAgIGNvbnN0IHJlc29sdmVyOiBVc2VyRGVmaW5lZFJlc29sdmVyID0ge1xuICAgICAgICBmaWxlTmFtZSxcbiAgICAgICAgdGVtcGxhdGUsXG4gICAgICB9O1xuICAgICAgY29uc3Qgc2xvdEhhc2ggPSBgJHtyZXNvbHZlck5hbWV9IyR7c2xvdE5hbWV9YDtcbiAgICAgIC8vIGJlY2F1c2UgYSBzbG90IGNhbiBoYXZlIGEgcmVxdWVzdCBhbmQgcmVzcG9uc2UgcmVzb2x2ZXIsIHdlIG5lZWQgdG8gZ3JvdXAgY29ycmVzcG9uZGluZyByZXF1ZXN0IGFuZCByZXNwb25zZSByZXNvbHZlcnNcbiAgICAgIGlmIChzbG90SGFzaCBpbiBncm91cGVkUmVzb2x2ZXJzTWFwICYmIHJlc29sdmVyT3JkZXIgaW4gZ3JvdXBlZFJlc29sdmVyc01hcFtzbG90SGFzaF0pIHtcbiAgICAgICAgc2V0SW4oZ3JvdXBlZFJlc29sdmVyc01hcCwgW3Nsb3RIYXNoLCByZXNvbHZlck9yZGVyLCByZXNvbHZlclR5cGVdLCByZXNvbHZlcik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBzbG90ID0ge1xuICAgICAgICAgIHJlc29sdmVyVHlwZU5hbWU6IHNsaWNlZFNsb3ROYW1lWzBdLFxuICAgICAgICAgIHJlc29sdmVyRmllbGROYW1lOiBzbGljZWRTbG90TmFtZVsxXSxcbiAgICAgICAgICBzbG90TmFtZSxcbiAgICAgICAgICBbcmVzb2x2ZXJUeXBlXTogcmVzb2x2ZXIsXG4gICAgICAgIH07XG4gICAgICAgIHNldEluKGdyb3VwZWRSZXNvbHZlcnNNYXAsIFtzbG90SGFzaCwgcmVzb2x2ZXJPcmRlcl0sIHNsb3QpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gIHJldHVybiBPYmplY3QuZW50cmllcyhncm91cGVkUmVzb2x2ZXJzTWFwKVxuICAgIC5tYXAoKFtyZXNvbHZlck5hbWVLZXksIG51bWJlcmVkU2xvdHNdKSA9PiAoe1xuICAgICAgb3JkZXJlZFNsb3RzOiBPYmplY3QuZW50cmllcyhudW1iZXJlZFNsb3RzKVxuICAgICAgICAuc29ydCgoW2ldLCBbal0pID0+IGkubG9jYWxlQ29tcGFyZShqKSlcbiAgICAgICAgLm1hcCgoW18sIHNsb3RdKSA9PiBzbG90KSxcbiAgICAgIHJlc29sdmVyTmFtZTogcmVzb2x2ZXJOYW1lS2V5LnNwbGl0KCcjJylbMF0sXG4gICAgfSkpXG4gICAgLnJlZHVjZSgoYWNjLCB7IG9yZGVyZWRTbG90cywgcmVzb2x2ZXJOYW1lIH0pID0+IHtcbiAgICAgIGlmIChhY2NbcmVzb2x2ZXJOYW1lXSkge1xuICAgICAgICBhY2NbcmVzb2x2ZXJOYW1lXS5wdXNoKC4uLm9yZGVyZWRTbG90cyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhY2NbcmVzb2x2ZXJOYW1lXSA9IG9yZGVyZWRTbG90cztcbiAgICAgIH1cbiAgICAgIHJldHVybiBhY2M7XG4gICAgfSwge30gYXMgUmVjb3JkPHN0cmluZywgVXNlckRlZmluZWRTbG90W10+KTtcbn07XG4iXX0=