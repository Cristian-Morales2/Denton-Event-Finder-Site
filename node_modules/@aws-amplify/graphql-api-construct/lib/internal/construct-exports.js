"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getGeneratedFunctionSlots = exports.getGeneratedResources = void 0;
const aws_appsync_1 = require("aws-cdk-lib/aws-appsync");
const aws_dynamodb_1 = require("aws-cdk-lib/aws-dynamodb");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const graphql_transformer_core_1 = require("@aws-amplify/graphql-transformer-core");
const aws_lambda_1 = require("aws-cdk-lib/aws-lambda");
const amplify_dynamodb_table_wrapper_1 = require("../amplify-dynamodb-table-wrapper");
const construct_tree_1 = require("./construct-tree");
/**
 * Check if a resource is implementing table interface
 * The required properties need to be present in the input
 * https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_dynamodb.ITable.html#properties
 * @param table table resource
 * @returns whether the resource is a ITable or not
 */
function isITable(table) {
    return 'env' in table && 'node' in table && 'stack' in table && 'tableArn' in table && 'tableName' in table;
}
/**
 * Everything below here is intended to help us gather the
 * output values and render out the L1 resources for access.
 *
 * This is done by recursing along the construct tree, and classifying the generated resources.
 *
 * @param scope root to search for generated resource against
 * @returns a mapping of L1 and L2 constructs generated by the Graphql Transformer.
 */
const getGeneratedResources = (scope) => {
    let cfnGraphqlApi;
    let cfnGraphqlSchema;
    let cfnApiKey;
    const cfnResolvers = {};
    const cfnFunctionConfigurations = {};
    const cfnDataSources = {};
    const tables = {};
    const cfnTables = {};
    const amplifyDynamoDbTables = {};
    const roles = {};
    const cfnRoles = {};
    const functions = {};
    const cfnFunctions = {};
    const additionalCfnResources = {};
    const classifyConstruct = (currentScope) => {
        if (currentScope instanceof aws_appsync_1.CfnGraphQLApi) {
            cfnGraphqlApi = currentScope;
            return;
        }
        if (currentScope instanceof aws_appsync_1.CfnGraphQLSchema) {
            cfnGraphqlSchema = currentScope;
            return;
        }
        if (currentScope instanceof aws_appsync_1.CfnApiKey) {
            cfnApiKey = currentScope;
            return;
        }
        // Retrieve reference name for indexed resources, and bail if none is found.
        const resourceName = (0, graphql_transformer_core_1.getResourceName)(currentScope);
        if (!resourceName)
            return;
        if (currentScope instanceof aws_appsync_1.CfnDataSource) {
            cfnDataSources[resourceName] = currentScope;
            return;
        }
        if (currentScope instanceof aws_appsync_1.CfnResolver) {
            cfnResolvers[resourceName] = currentScope;
            return;
        }
        if (currentScope instanceof aws_appsync_1.CfnFunctionConfiguration) {
            cfnFunctionConfigurations[resourceName] = currentScope;
            return;
        }
        if (currentScope instanceof aws_dynamodb_1.Table || isITable(currentScope)) {
            tables[resourceName] = currentScope;
            return;
        }
        if (currentScope instanceof aws_dynamodb_1.CfnTable) {
            cfnTables[resourceName] = currentScope;
            return;
        }
        if (amplify_dynamodb_table_wrapper_1.AmplifyDynamoDbTableWrapper.isAmplifyDynamoDbTableResource(currentScope)) {
            amplifyDynamoDbTables[resourceName] = new amplify_dynamodb_table_wrapper_1.AmplifyDynamoDbTableWrapper(currentScope);
            return;
        }
        if (currentScope instanceof aws_iam_1.Role) {
            roles[resourceName] = currentScope;
            return;
        }
        if (currentScope instanceof aws_iam_1.CfnRole) {
            cfnRoles[resourceName] = currentScope;
            return;
        }
        if (currentScope instanceof aws_lambda_1.Function) {
            functions[resourceName] = currentScope;
            return;
        }
        if (currentScope instanceof aws_lambda_1.CfnFunction) {
            cfnFunctions[resourceName] = currentScope;
            return;
        }
        if (currentScope instanceof aws_cdk_lib_1.CfnResource) {
            additionalCfnResources[resourceName] = currentScope;
            return;
        }
    };
    scope.node.children.forEach((child) => (0, construct_tree_1.walkAndProcessNodes)(child, classifyConstruct));
    if (!cfnGraphqlApi) {
        throw new Error('Expected to find AWS::AppSync::GraphQLApi in the generated resource scope.');
    }
    if (!cfnGraphqlSchema) {
        throw new Error('Expected to find AWS::AppSync::GraphQLSchema in the generated resource scope.');
    }
    const nestedStacks = Object.fromEntries(scope.node.children.filter(aws_cdk_lib_1.NestedStack.isNestedStack).map((nestedStack) => [nestedStack.node.id, nestedStack]));
    return {
        graphqlApi: aws_appsync_1.GraphqlApi.fromGraphqlApiAttributes(scope, 'L2GraphqlApi', { graphqlApiId: cfnGraphqlApi.attrApiId }),
        tables,
        roles,
        functions,
        nestedStacks,
        cfnResources: {
            cfnGraphqlApi,
            cfnGraphqlSchema,
            cfnApiKey,
            cfnResolvers,
            cfnFunctionConfigurations,
            cfnDataSources,
            cfnTables,
            amplifyDynamoDbTables,
            cfnRoles,
            cfnFunctions,
            additionalCfnResources,
        },
    };
};
exports.getGeneratedResources = getGeneratedResources;
/**
 * Get the function slots generated by the Graphql transform operation, adhering to the FunctionSlot interface.
 * @param generatedResolvers the resolvers generated by the transformer to spit back out.
 * @returns the list of generated function slots in the transformer, in order to facilitate overrides.
 */
const getGeneratedFunctionSlots = (generatedResolvers) => Object.entries(generatedResolvers)
    .filter(([name]) => name.split('.').length === 6)
    .map(([name, resolverCode]) => {
    const [typeName, fieldName, slotName, slotIndex, templateType] = name.split('.');
    return {
        typeName,
        fieldName,
        slotName,
        slotIndex: Number.parseInt(slotIndex, 10),
        function: {
            // TODO: this should consolidate req/req values back together
            ...(templateType === 'req' ? { requestMappingTemplate: resolverCode } : {}),
            ...(templateType === 'res' ? { responseMappingTemplate: resolverCode } : {}),
        },
    };
});
exports.getGeneratedFunctionSlots = getGeneratedFunctionSlots;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uc3RydWN0LWV4cG9ydHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaW50ZXJuYWwvY29uc3RydWN0LWV4cG9ydHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EseURBUWlDO0FBQ2pDLDJEQUFtRTtBQUNuRSxpREFBb0Q7QUFDcEQsNkNBQXVEO0FBQ3ZELG9GQUF3RTtBQUN4RSx1REFBaUY7QUFFakYsc0ZBQWdGO0FBQ2hGLHFEQUF1RDtBQUV2RDs7Ozs7O0dBTUc7QUFDSCxTQUFTLFFBQVEsQ0FBQyxLQUFVO0lBQzFCLE9BQU8sS0FBSyxJQUFJLEtBQUssSUFBSSxNQUFNLElBQUksS0FBSyxJQUFJLE9BQU8sSUFBSSxLQUFLLElBQUksVUFBVSxJQUFJLEtBQUssSUFBSSxXQUFXLElBQUksS0FBSyxDQUFDO0FBQzlHLENBQUM7QUFDRDs7Ozs7Ozs7R0FRRztBQUNJLE1BQU0scUJBQXFCLEdBQUcsQ0FBQyxLQUFnQixFQUE4QixFQUFFO0lBQ3BGLElBQUksYUFBd0MsQ0FBQztJQUM3QyxJQUFJLGdCQUE4QyxDQUFDO0lBQ25ELElBQUksU0FBZ0MsQ0FBQztJQUNyQyxNQUFNLFlBQVksR0FBZ0MsRUFBRSxDQUFDO0lBQ3JELE1BQU0seUJBQXlCLEdBQTZDLEVBQUUsQ0FBQztJQUMvRSxNQUFNLGNBQWMsR0FBa0MsRUFBRSxDQUFDO0lBQ3pELE1BQU0sTUFBTSxHQUEyQixFQUFFLENBQUM7SUFDMUMsTUFBTSxTQUFTLEdBQTZCLEVBQUUsQ0FBQztJQUMvQyxNQUFNLHFCQUFxQixHQUFnRCxFQUFFLENBQUM7SUFDOUUsTUFBTSxLQUFLLEdBQXlCLEVBQUUsQ0FBQztJQUN2QyxNQUFNLFFBQVEsR0FBNEIsRUFBRSxDQUFDO0lBQzdDLE1BQU0sU0FBUyxHQUFtQyxFQUFFLENBQUM7SUFDckQsTUFBTSxZQUFZLEdBQWdDLEVBQUUsQ0FBQztJQUNyRCxNQUFNLHNCQUFzQixHQUFnQyxFQUFFLENBQUM7SUFFL0QsTUFB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O1lBQ1IsNkRBQTZEO1lBQzdELEdBQUcsQ0FBQyxZQUFZLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLHNCQUFzQixFQUFFLFlBQVksRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDM0UsR0FBRyxDQUFDLFlBQVksS0FBSyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsdUJBQXVCLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztTQUM3RTtLQUNjLENBQUM7QUFDcEIsQ0FBQyxDQUFDLENBQUM7QUFoQk0sUUFBQSx5QkFBeUIsNkJBZ0IvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHtcbiAgQ2ZuR3JhcGhRTEFwaSxcbiAgQ2ZuR3JhcGhRTFNjaGVtYSxcbiAgQ2ZuQXBpS2V5LFxuICBDZm5SZXNvbHZlcixcbiAgQ2ZuRnVuY3Rpb25Db25maWd1cmF0aW9uLFxuICBDZm5EYXRhU291cmNlLFxuICBHcmFwaHFsQXBpLFxufSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtYXBwc3luYyc7XG5pbXBvcnQgeyBDZm5UYWJsZSwgVGFibGUsIElUYWJsZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1keW5hbW9kYic7XG5pbXBvcnQgeyBDZm5Sb2xlLCBSb2xlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgeyBDZm5SZXNvdXJjZSwgTmVzdGVkU3RhY2sgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBnZXRSZXNvdXJjZU5hbWUgfSBmcm9tICdAYXdzLWFtcGxpZnkvZ3JhcGhxbC10cmFuc2Zvcm1lci1jb3JlJztcbmltcG9ydCB7IENmbkZ1bmN0aW9uLCBGdW5jdGlvbiBhcyBMYW1iZGFGdW5jdGlvbiB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgQW1wbGlmeUdyYXBocWxBcGlSZXNvdXJjZXMsIEZ1bmN0aW9uU2xvdCB9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7IEFtcGxpZnlEeW5hbW9EYlRhYmxlV3JhcHBlciB9IGZyb20gJy4uL2FtcGxpZnktZHluYW1vZGItdGFibGUtd3JhcHBlcic7XG5pbXBvcnQgeyB3YWxrQW5kUHJvY2Vzc05vZGVzIH0gZnJvbSAnLi9jb25zdHJ1Y3QtdHJlZSc7XG5cbi8qKlxuICogQ2hlY2sgaWYgYSByZXNvdXJjZSBpcyBpbXBsZW1lbnRpbmcgdGFibGUgaW50ZXJmYWNlXG4gKiBUaGUgcmVxdWlyZWQgcHJvcGVydGllcyBuZWVkIHRvIGJlIHByZXNlbnQgaW4gdGhlIGlucHV0XG4gKiBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vY2RrL2FwaS92Mi9kb2NzL2F3cy1jZGstbGliLmF3c19keW5hbW9kYi5JVGFibGUuaHRtbCNwcm9wZXJ0aWVzXG4gKiBAcGFyYW0gdGFibGUgdGFibGUgcmVzb3VyY2VcbiAqIEByZXR1cm5zIHdoZXRoZXIgdGhlIHJlc291cmNlIGlzIGEgSVRhYmxlIG9yIG5vdFxuICovXG5mdW5jdGlvbiBpc0lUYWJsZSh0YWJsZTogYW55KTogdGFibGUgaXMgSVRhYmxlIHtcbiAgcmV0dXJuICdlbnYnIGluIHRhYmxlICYmICdub2RlJyBpbiB0YWJsZSAmJiAnc3RhY2snIGluIHRhYmxlICYmICd0YWJsZUFybicgaW4gdGFibGUgJiYgJ3RhYmxlTmFtZScgaW4gdGFibGU7XG59XG4vKipcbiAqIEV2ZXJ5dGhpbmcgYmVsb3cgaGVyZSBpcyBpbnRlbmRlZCB0byBoZWxwIHVzIGdhdGhlciB0aGVcbiAqIG91dHB1dCB2YWx1ZXMgYW5kIHJlbmRlciBvdXQgdGhlIEwxIHJlc291cmNlcyBmb3IgYWNjZXNzLlxuICpcbiAqIFRoaXMgaXMgZG9uZSBieSByZWN1cnNpbmcgYWxvbmcgdGhlIGNvbnN0cnVjdCB0cmVlLCBhbmQgY2xhc3NpZnlpbmcgdGhlIGdlbmVyYXRlZCByZXNvdXJjZXMuXG4gKlxuICogQHBhcmFtIHNjb3BlIHJvb3QgdG8gc2VhcmNoIGZvciBnZW5lcmF0ZWQgcmVzb3VyY2UgYWdhaW5zdFxuICogQHJldHVybnMgYSBtYXBwaW5nIG9mIEwxIGFuZCBMMiBjb25zdHJ1Y3RzIGdlbmVyYXRlZCBieSB0aGUgR3JhcGhxbCBUcmFuc2Zvcm1lci5cbiAqL1xuZXhwb3J0IGNvbnN0IGdldEdlbmVyYXRlZFJlc291cmNlcyA9IChzY29wZTogQ29uc3RydWN0KTogQW1wbGlmeUdyYXBocWxBcGlSZXNvdXJjZXMgPT4ge1xuICBsZXQgY2ZuR3JhcGhxbEFwaTogQ2ZuR3JhcGhRTEFwaSB8IHVuZGVmaW5lZDtcbiAgbGV0IGNmbkdyYXBocWxTY2hlbWE6IENmbkdyYXBoUUxTY2hlbWEgfCB1bmRlZmluZWQ7XG4gIGxldCBjZm5BcGlLZXk6IENmbkFwaUtleSB8IHVuZGVmaW5lZDtcbiAgY29uc3QgY2ZuUmVzb2x2ZXJzOiBSZWNvcmQ8c3RyaW5nLCBDZm5SZXNvbHZlcj4gPSB7fTtcbiAgY29uc3QgY2ZuRnVuY3Rpb25Db25maWd1cmF0aW9uczogUmVjb3JkPHN0cmluZywgQ2ZuRnVuY3Rpb25Db25maWd1cmF0aW9uPiA9IHt9O1xuICBjb25zdCBjZm5EYXRhU291cmNlczogUmVjb3JkPHN0cmluZywgQ2ZuRGF0YVNvdXJjZT4gPSB7fTtcbiAgY29uc3QgdGFibGVzOiBSZWNvcmQ8c3RyaW5nLCBJVGFibGU+ID0ge307XG4gIGNvbnN0IGNmblRhYmxlczogUmVjb3JkPHN0cmluZywgQ2ZuVGFibGU+ID0ge307XG4gIGNvbnN0IGFtcGxpZnlEeW5hbW9EYlRhYmxlczogUmVjb3JkPHN0cmluZywgQW1wbGlmeUR5bmFtb0RiVGFibGVXcmFwcGVyPiA9IHt9O1xuICBjb25zdCByb2xlczogUmVjb3JkPHN0cmluZywgUm9sZT4gPSB7fTtcbiAgY29uc3QgY2ZuUm9sZXM6IFJlY29yZDxzdHJpbmcsIENmblJvbGU+ID0ge307XG4gIGNvbnN0IGZ1bmN0aW9uczogUmVjb3JkPHN0cmluZywgTGFtYmRhRnVuY3Rpb24+ID0ge307XG4gIGNvbnN0IGNmbkZ1bmN0aW9uczogUmVjb3JkPHN0cmluZywgQ2ZuRnVuY3Rpb24+ID0ge307XG4gIGNvbnN0IGFkZGl0aW9uYWxDZm5SZXNvdXJjZXM6IFJlY29yZDxzdHJpbmcsIENmblJlc291cmNlPiA9IHt9O1xuXG4gIGNvbnN0IGNsYXNzaWZ5Q29uc3RydWN0ID0gKGN1cnJlbnRTY29wZTogQ29uc3RydWN0KTogdm9pZCA9PiB7XG4gICAgaWYgKGN1cnJlbnRTY29wZSBpbnN0YW5jZW9mIENmbkdyYXBoUUxBcGkpIHtcbiAgICAgIGNmbkdyYXBocWxBcGkgPSBjdXJyZW50U2NvcGU7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChjdXJyZW50U2NvcGUgaW5zdGFuY2VvZiBDZm5HcmFwaFFMU2NoZW1hKSB7XG4gICAgICBjZm5HcmFwaHFsU2NoZW1hID0gY3VycmVudFNjb3BlO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoY3VycmVudFNjb3BlIGluc3RhbmNlb2YgQ2ZuQXBpS2V5KSB7XG4gICAgICBjZm5BcGlLZXkgPSBjdXJyZW50U2NvcGU7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gUmV0cmlldmUgcmVmZXJlbmNlIG5hbWUgZm9yIGluZGV4ZWQgcmVzb3VyY2VzLCBhbmQgYmFpbCBpZiBub25lIGlzIGZvdW5kLlxuICAgIGNvbnN0IHJlc291cmNlTmFtZSA9IGdldFJlc291cmNlTmFtZShjdXJyZW50U2NvcGUpO1xuICAgIGlmICghcmVzb3VyY2VOYW1lKSByZXR1cm47XG5cbiAgICBpZiAoY3VycmVudFNjb3BlIGluc3RhbmNlb2YgQ2ZuRGF0YVNvdXJjZSkge1xuICAgICAgY2ZuRGF0YVNvdXJjZXNbcmVzb3VyY2VOYW1lXSA9IGN1cnJlbnRTY29wZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGN1cnJlbnRTY29wZSBpbnN0YW5jZW9mIENmblJlc29sdmVyKSB7XG4gICAgICBjZm5SZXNvbHZlcnNbcmVzb3VyY2VOYW1lXSA9IGN1cnJlbnRTY29wZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGN1cnJlbnRTY29wZSBpbnN0YW5jZW9mIENmbkZ1bmN0aW9uQ29uZmlndXJhdGlvbikge1xuICAgICAgY2ZuRnVuY3Rpb25Db25maWd1cmF0aW9uc1tyZXNvdXJjZU5hbWVdID0gY3VycmVudFNjb3BlO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoY3VycmVudFNjb3BlIGluc3RhbmNlb2YgVGFibGUgfHwgaXNJVGFibGUoY3VycmVudFNjb3BlKSkge1xuICAgICAgdGFibGVzW3Jlc291cmNlTmFtZV0gPSBjdXJyZW50U2NvcGU7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChjdXJyZW50U2NvcGUgaW5zdGFuY2VvZiBDZm5UYWJsZSkge1xuICAgICAgY2ZuVGFibGVzW3Jlc291cmNlTmFtZV0gPSBjdXJyZW50U2NvcGU7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChBbXBsaWZ5RHluYW1vRGJUYWJsZVdyYXBwZXIuaXNBbXBsaWZ5RHluYW1vRGJUYWJsZVJlc291cmNlKGN1cnJlbnRTY29wZSkpIHtcbiAgICAgIGFtcGxpZnlEeW5hbW9EYlRhYmxlc1tyZXNvdXJjZU5hbWVdID0gbmV3IEFtcGxpZnlEeW5hbW9EYlRhYmxlV3JhcHBlcihjdXJyZW50U2NvcGUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoY3VycmVudFNjb3BlIGluc3RhbmNlb2YgUm9sZSkge1xuICAgICAgcm9sZXNbcmVzb3VyY2VOYW1lXSA9IGN1cnJlbnRTY29wZTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGN1cnJlbnRTY29wZSBpbnN0YW5jZW9mIENmblJvbGUpIHtcbiAgICAgIGNmblJvbGVzW3Jlc291cmNlTmFtZV0gPSBjdXJyZW50U2NvcGU7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChjdXJyZW50U2NvcGUgaW5zdGFuY2VvZiBMYW1iZGFGdW5jdGlvbikge1xuICAgICAgZnVuY3Rpb25zW3Jlc291cmNlTmFtZV0gPSBjdXJyZW50U2NvcGU7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChjdXJyZW50U2NvcGUgaW5zdGFuY2VvZiBDZm5GdW5jdGlvbikge1xuICAgICAgY2ZuRnVuY3Rpb25zW3Jlc291cmNlTmFtZV0gPSBjdXJyZW50U2NvcGU7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChjdXJyZW50U2NvcGUgaW5zdGFuY2VvZiBDZm5SZXNvdXJjZSkge1xuICAgICAgYWRkaXRpb25hbENmblJlc291cmNlc1tyZXNvdXJjZU5hbWVdID0gY3VycmVudFNjb3BlO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgfTtcblxuICBzY29wZS5ub2RlLmNoaWxkcmVuLmZvckVhY2goKGNoaWxkKSA9PiB3YWxrQW5kUHJvY2Vzc05vZGVzKGNoaWxkLCBjbGFzc2lmeUNvbnN0cnVjdCkpO1xuXG4gIGlmICghY2ZuR3JhcGhxbEFwaSkge1xuICAgIHRocm93IG5ldyBFcnJvcignRXhwZWN0ZWQgdG8gZmluZCBBV1M6OkFwcFN5bmM6OkdyYXBoUUxBcGkgaW4gdGhlIGdlbmVyYXRlZCByZXNvdXJjZSBzY29wZS4nKTtcbiAgfVxuXG4gIGlmICghY2ZuR3JhcGhxbFNjaGVtYSkge1xuICAgIHRocm93IG5ldyBFcnJvcignRXhwZWN0ZWQgdG8gZmluZCBBV1M6OkFwcFN5bmM6OkdyYXBoUUxTY2hlbWEgaW4gdGhlIGdlbmVyYXRlZCByZXNvdXJjZSBzY29wZS4nKTtcbiAgfVxuXG4gIGNvbnN0IG5lc3RlZFN0YWNrczogUmVjb3JkPHN0cmluZywgTmVzdGVkU3RhY2s+ID0gT2JqZWN0LmZyb21FbnRyaWVzKFxuICAgIHNjb3BlLm5vZGUuY2hpbGRyZW4uZmlsdGVyKE5lc3RlZFN0YWNrLmlzTmVzdGVkU3RhY2spLm1hcCgobmVzdGVkU3RhY2s6IE5lc3RlZFN0YWNrKSA9PiBbbmVzdGVkU3RhY2subm9kZS5pZCwgbmVzdGVkU3RhY2tdKSxcbiAgKTtcblxuICByZXR1cm4ge1xuICAgIGdyYXBocWxBcGk6IEdyYXBocWxBcGkuZnJvbUdyYXBocWxBcGlBdHRyaWJ1dGVzKHNjb3BlLCAnTDJHcmFwaHFsQXBpJywgeyBncmFwaHFsQXBpSWQ6IGNmbkdyYXBocWxBcGkuYXR0ckFwaUlkIH0pLFxuICAgIHRhYmxlcyxcbiAgICByb2xlcyxcbiAgICBmdW5jdGlvbnMsXG4gICAgbmVzdGVkU3RhY2tzLFxuICAgIGNmblJlc291cmNlczoge1xuICAgICAgY2ZuR3JhcGhxbEFwaSxcbiAgICAgIGNmbkdyYXBocWxTY2hlbWEsXG4gICAgICBjZm5BcGlLZXksXG4gICAgICBjZm5SZXNvbHZlcnMsXG4gICAgICBjZm5GdW5jdGlvbkNvbmZpZ3VyYXRpb25zLFxuICAgICAgY2ZuRGF0YVNvdXJjZXMsXG4gICAgICBjZm5UYWJsZXMsXG4gICAgICBhbXBsaWZ5RHluYW1vRGJUYWJsZXMsXG4gICAgICBjZm5Sb2xlcyxcbiAgICAgIGNmbkZ1bmN0aW9ucyxcbiAgICAgIGFkZGl0aW9uYWxDZm5SZXNvdXJjZXMsXG4gICAgfSxcbiAgfTtcbn07XG5cbi8qKlxuICogR2V0IHRoZSBmdW5jdGlvbiBzbG90cyBnZW5lcmF0ZWQgYnkgdGhlIEdyYXBocWwgdHJhbnNmb3JtIG9wZXJhdGlvbiwgYWRoZXJpbmcgdG8gdGhlIEZ1bmN0aW9uU2xvdCBpbnRlcmZhY2UuXG4gKiBAcGFyYW0gZ2VuZXJhdGVkUmVzb2x2ZXJzIHRoZSByZXNvbHZlcnMgZ2VuZXJhdGVkIGJ5IHRoZSB0cmFuc2Zvcm1lciB0byBzcGl0IGJhY2sgb3V0LlxuICogQHJldHVybnMgdGhlIGxpc3Qgb2YgZ2VuZXJhdGVkIGZ1bmN0aW9uIHNsb3RzIGluIHRoZSB0cmFuc2Zvcm1lciwgaW4gb3JkZXIgdG8gZmFjaWxpdGF0ZSBvdmVycmlkZXMuXG4gKi9cbmV4cG9ydCBjb25zdCBnZXRHZW5lcmF0ZWRGdW5jdGlvblNsb3RzID0gKGdlbmVyYXRlZFJlc29sdmVyczogUmVjb3JkPHN0cmluZywgc3RyaW5nPik6IEZ1bmN0aW9uU2xvdFtdID0+XG4gIE9iamVjdC5lbnRyaWVzKGdlbmVyYXRlZFJlc29sdmVycylcbiAgICAuZmlsdGVyKChbbmFtZV0pID0+IG5hbWUuc3BsaXQoJy4nKS5sZW5ndGggPT09IDYpXG4gICAgLm1hcCgoW25hbWUsIHJlc29sdmVyQ29kZV0pID0+IHtcbiAgICAgIGNvbnN0IFt0eXBlTmFtZSwgZmllbGROYW1lLCBzbG90TmFtZSwgc2xvdEluZGV4LCB0ZW1wbGF0ZVR5cGVdID0gbmFtZS5zcGxpdCgnLicpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdHlwZU5hbWUsXG4gICAgICAgIGZpZWxkTmFtZSxcbiAgICAgICAgc2xvdE5hbWUsXG4gICAgICAgIHNsb3RJbmRleDogTnVtYmVyLnBhcnNlSW50KHNsb3RJbmRleCwgMTApLFxuICAgICAgICBmdW5jdGlvbjoge1xuICAgICAgICAgIC8vIFRPRE86IHRoaXMgc2hvdWxkIGNvbnNvbGlkYXRlIHJlcS9yZXEgdmFsdWVzIGJhY2sgdG9nZXRoZXJcbiAgICAgICAgICAuLi4odGVtcGxhdGVUeXBlID09PSAncmVxJyA/IHsgcmVxdWVzdE1hcHBpbmdUZW1wbGF0ZTogcmVzb2x2ZXJDb2RlIH0gOiB7fSksXG4gICAgICAgICAgLi4uKHRlbXBsYXRlVHlwZSA9PT0gJ3JlcycgPyB7IHJlc3BvbnNlTWFwcGluZ1RlbXBsYXRlOiByZXNvbHZlckNvZGUgfSA6IHt9KSxcbiAgICAgICAgfSxcbiAgICAgIH0gYXMgRnVuY3Rpb25TbG90O1xuICAgIH0pO1xuIl19