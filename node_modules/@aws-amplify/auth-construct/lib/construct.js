"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AmplifyAuth = void 0;
const constructs_1 = require("constructs");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_cognito_1 = require("aws-cdk-lib/aws-cognito");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const backend_output_schemas_1 = require("@aws-amplify/backend-output-schemas");
const defaults_js_1 = require("./defaults.js");
const backend_output_storage_1 = require("@aws-amplify/backend-output-storage");
const path = __importStar(require("path"));
const oauthProviderToProviderDomainMap = {
    facebook: 'graph.facebook.com',
    google: 'accounts.google.com',
    amazon: 'www.amazon.com',
    apple: 'appleid.apple.com',
};
const INVITATION_PLACEHOLDERS = {
    CODE: '{####}',
    USERNAME: '{username}',
};
const VERIFICATION_EMAIL_PLACEHOLDERS = {
    CODE: '{####}',
    LINK: '{##Verify Email##}',
};
const VERIFICATION_SMS_PLACEHOLDERS = {
    CODE: '{####}',
};
const MFA_SMS_PLACEHOLDERS = {
    CODE: '{####}',
};
const DEFAULT_OAUTH_SCOPES = [
    aws_cognito_1.OAuthScope.PHONE,
    aws_cognito_1.OAuthScope.EMAIL,
    aws_cognito_1.OAuthScope.OPENID,
    aws_cognito_1.OAuthScope.PROFILE,
    aws_cognito_1.OAuthScope.COGNITO_ADMIN,
];
// Be very careful editing this value. It is the string that is used to attribute stacks to Amplify Auth in BI metrics
const authStackType = 'auth-Cognito';
/**
 * Amplify Auth CDK Construct
 */
class AmplifyAuth extends constructs_1.Construct {
    /**
     * Create a new Auth construct with AuthProps.
     * If no props are provided, email login and defaults will be used.
     */
    constructor(scope, id, props = defaults_js_1.DEFAULTS.IF_NO_PROPS_PROVIDED) {
        var _a, _b;
        super(scope, id);
        this.groups = {};
        /**
         * Create Auth/UnAuth Roles
         * @returns DefaultRoles
         */
        this.setupAuthAndUnAuthRoles = (identityPoolId) => {
            const result = {
                auth: new aws_iam_1.Role(this, `${this.name}authenticatedUserRole`, {
                    assumedBy: new aws_iam_1.FederatedPrincipal('cognito-identity.amazonaws.com', {
                        StringEquals: {
                            'cognito-identity.amazonaws.com:aud': identityPoolId,
                        },
                        'ForAnyValue:StringLike': {
                            'cognito-identity.amazonaws.com:amr': 'authenticated',
                        },
                    }, 'sts:AssumeRoleWithWebIdentity'),
                }),
                unAuth: new aws_iam_1.Role(this, `${this.name}unauthenticatedUserRole`, {
                    assumedBy: new aws_iam_1.FederatedPrincipal('cognito-identity.amazonaws.com', {
                        StringEquals: {
                            'cognito-identity.amazonaws.com:aud': identityPoolId,
                        },
                        'ForAnyValue:StringLike': {
                            'cognito-identity.amazonaws.com:amr': 'unauthenticated',
                        },
                    }, 'sts:AssumeRoleWithWebIdentity'),
                }),
            };
            return result;
        };
        /**
         * Auto generate the user pool groups and group roles
         */
        this.setupUserPoolGroups = (groups, identityPool) => {
            (groups || []).forEach((groupName, index) => {
                const groupRole = new aws_iam_1.Role(this, `${this.name}${groupName}GroupRole`, {
                    assumedBy: new aws_iam_1.FederatedPrincipal('cognito-identity.amazonaws.com', {
                        StringEquals: {
                            'cognito-identity.amazonaws.com:aud': identityPool.ref,
                        },
                        'ForAnyValue:StringLike': {
                            'cognito-identity.amazonaws.com:amr': 'authenticated',
                        },
                    }, 'sts:AssumeRoleWithWebIdentity'),
                });
                const currentGroup = new aws_cognito_1.CfnUserPoolGroup(this, `${this.name}${groupName}Group`, {
                    userPoolId: this.userPool.userPoolId,
                    groupName: groupName,
                    roleArn: groupRole.roleArn,
                    precedence: index,
                });
                this.groups[groupName] = {
                    cfnUserGroup: currentGroup,
                    role: groupRole,
                };
            });
        };
        /**
         * Setup Identity Pool with default roles/role mappings, and register providers
         */
        this.setupIdentityPool = (userPool, userPoolClient, providerSetupResult) => {
            // setup identity pool
            const region = aws_cdk_lib_1.Stack.of(this).region;
            const identityPool = new aws_cdk_lib_1.aws_cognito.CfnIdentityPool(this, `${this.name}IdentityPool`, {
                allowUnauthenticatedIdentities: defaults_js_1.DEFAULTS.ALLOW_UNAUTHENTICATED_IDENTITIES,
            });
            const roles = this.setupAuthAndUnAuthRoles(identityPool.ref);
            const identityPoolRoleAttachment = new aws_cdk_lib_1.aws_cognito.CfnIdentityPoolRoleAttachment(this, `${this.name}IdentityPoolRoleAttachment`, {
                identityPoolId: identityPool.ref,
                roles: {
                    unauthenticated: roles.unAuth.roleArn,
                    authenticated: roles.auth.roleArn,
                },
                roleMappings: {
                    UserPoolWebClientRoleMapping: {
                        type: 'Token',
                        ambiguousRoleResolution: 'AuthenticatedRole',
                        identityProvider: `cognito-idp.${region}.amazonaws.com/${userPool.userPoolId}:${userPoolClient.userPoolClientId}`,
                    },
                },
            });
            identityPoolRoleAttachment.addDependency(identityPool);
            identityPoolRoleAttachment.node.addDependency(userPoolClient);
            // add cognito provider
            identityPool.cognitoIdentityProviders = [
                {
                    clientId: userPoolClient.userPoolClientId,
                    providerName: `cognito-idp.${region}.amazonaws.com/${userPool.userPoolId}`,
                },
            ];
            // add other providers
            identityPool.supportedLoginProviders = providerSetupResult.oAuthMappings;
            return {
                identityPool,
                identityPoolRoleAttachment,
                roles,
            };
        };
        /**
         * Process props into UserPoolProps (set defaults if needed)
         */
        this.getUserPoolProps = (props) => {
            var _a;
            const emailEnabled = props.loginWith.email ? true : false;
            const phoneEnabled = props.loginWith.phone ? true : false;
            const oneOfEmailOrPhone = emailEnabled || phoneEnabled;
            if (!oneOfEmailOrPhone) {
                throw Error('At least one of email or phone must be enabled.');
            }
            let userVerificationSettings = {};
            // extract email settings if settings object is defined
            if (typeof props.loginWith.email === 'object') {
                const emailSettings = props.loginWith.email;
                // verify email body and inject the actual template values which cognito uses
                const emailBody = this.verifyEmailBody(emailSettings);
                userVerificationSettings = {
                    emailBody: emailBody,
                    emailStyle: this.getEmailVerificationStyle(emailSettings.verificationEmailStyle),
                    emailSubject: emailSettings.verificationEmailSubject,
                };
            }
            // extract phone settings if settings object is defined
            if (typeof props.loginWith.phone === 'object') {
                const phoneSettings = props.loginWith.phone;
                let smsMessage;
                if (phoneSettings.verificationMessage &&
                    typeof phoneSettings.verificationMessage === 'function') {
                    // validate sms message structure
                    smsMessage = phoneSettings.verificationMessage(() => VERIFICATION_SMS_PLACEHOLDERS.CODE);
                    if (!smsMessage.includes(VERIFICATION_SMS_PLACEHOLDERS.CODE)) {
                        throw Error("Invalid phone settings. Property 'verificationMessage' must utilize the 'code' parameter at least once as a placeholder for the verification code.");
                    }
                }
                userVerificationSettings = {
                    ...userVerificationSettings,
                    smsMessage: smsMessage,
                };
            }
            const mfaType = this.getMFAType(props.multifactor);
            const mfaMode = this.getMFAMode(props.multifactor);
            // If phone login is enabled along with MFA, cognito requires that mfa SMS type to be enabled.
            if (phoneEnabled && mfaMode && mfaMode !== 'OFF' && !(mfaType === null || mfaType === void 0 ? void 0 : mfaType.sms)) {
                throw Error('Invalid MFA settings. SMS must be enabled in multiFactor if loginWith phone is enabled');
            }
            const userPoolProps = {
                signInCaseSensitive: defaults_js_1.DEFAULTS.SIGN_IN_CASE_SENSITIVE,
                signInAliases: {
                    phone: phoneEnabled,
                    email: emailEnabled,
                },
                keepOriginal: {
                    email: emailEnabled,
                    phone: phoneEnabled,
                },
                autoVerify: {
                    email: emailEnabled,
                    phone: phoneEnabled,
                },
                userVerification: userVerificationSettings,
                passwordPolicy: defaults_js_1.DEFAULTS.PASSWORD_POLICY,
                standardAttributes: {
                    email: defaults_js_1.DEFAULTS.IS_REQUIRED_ATTRIBUTE.email(emailEnabled),
                    phoneNumber: defaults_js_1.DEFAULTS.IS_REQUIRED_ATTRIBUTE.phoneNumber(phoneEnabled),
                    ...(props.userAttributes ? props.userAttributes : {}),
                },
                selfSignUpEnabled: defaults_js_1.DEFAULTS.ALLOW_SELF_SIGN_UP,
                mfa: mfaMode,
                mfaMessage: this.getMFAMessage(props.multifactor),
                mfaSecondFactor: mfaType,
                accountRecovery: this.getAccountRecoverySetting(emailEnabled, phoneEnabled, props.accountRecovery),
                removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
                userInvitation: typeof props.loginWith.email !== 'boolean'
                    ? this.getUserInvitationSettings((_a = props.loginWith.email) === null || _a === void 0 ? void 0 : _a.userInvitation)
                    : undefined,
            };
            return userPoolProps;
        };
        /**
         * Get email verification style from user props
         * @param verificationEmailStyle - string value
         * @returns verificationEmailStyle - enum value
         */
        this.getEmailVerificationStyle = (verificationEmailStyle) => {
            if (verificationEmailStyle === 'CODE') {
                return aws_cdk_lib_1.aws_cognito.VerificationEmailStyle.CODE;
            }
            else if (verificationEmailStyle === 'LINK') {
                return aws_cdk_lib_1.aws_cognito.VerificationEmailStyle.LINK;
            }
            return undefined;
        };
        /**
         * Determine the account recovery option based on enabled login methods.
         * @param emailEnabled - is email enabled
         * @param phoneEnabled - is phone enabled
         * @param accountRecoveryMethodAsString - the user provided account recovery setting
         * @returns account recovery setting enum value
         */
        this.getAccountRecoverySetting = (emailEnabled, phoneEnabled, accountRecoveryMethodAsString) => {
            const accountRecovery = this.convertAccountRecoveryStringToEnum(accountRecoveryMethodAsString);
            if (accountRecovery !== undefined) {
                return accountRecovery;
            }
            // set default based on enabled login methods
            if (phoneEnabled && emailEnabled) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery.EMAIL_ONLY;
            }
            if (phoneEnabled) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery.PHONE_ONLY_WITHOUT_MFA;
            }
            if (emailEnabled) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery.EMAIL_ONLY;
            }
            return undefined;
        };
        /**
         * Convert user friendly Mfa mode to cognito Mfa Mode.
         * This eliminates the need for users to import cognito.Mfa.
         * @param mfa - MFA settings
         * @returns cognito MFA enforcement mode
         */
        this.getMFAMode = (mfa) => {
            if (mfa) {
                switch (mfa.mode) {
                    case 'OFF':
                        return aws_cognito_1.Mfa.OFF;
                    case 'OPTIONAL':
                        return aws_cognito_1.Mfa.OPTIONAL;
                    case 'REQUIRED':
                        return aws_cognito_1.Mfa.REQUIRED;
                }
            }
            return undefined;
        };
        /**
         * Convert user friendly Mfa type to cognito Mfa type.
         * This eliminates the need for users to import cognito.Mfa.
         * @param mfa - MFA settings
         * @returns cognito MFA type (sms or totp)
         */
        this.getMFAType = (mfa) => {
            return typeof mfa === 'object' && mfa.mode !== 'OFF'
                ? {
                    sms: mfa.sms ? true : false,
                    otp: mfa.totp ? true : false,
                }
                : undefined;
        };
        /**
         * Convert user friendly account recovery method to cognito AccountRecover enum.
         * This eliminates the need for users to import cognito.AccountRecovery.
         * @param method - account recovery method as a string value
         * @returns cognito.AccountRecovery enum value
         */
        this.convertAccountRecoveryStringToEnum = (method) => {
            if (method !== undefined) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery[method];
            }
            return undefined;
        };
        /**
         * Extract the MFA message settings and perform validation.
         * @param mfa - MFA settings
         * @returns mfa message
         */
        this.getMFAMessage = (mfa) => {
            if (mfa && mfa.mode !== 'OFF' && typeof mfa.sms === 'object') {
                const message = mfa.sms.smsMessage(() => MFA_SMS_PLACEHOLDERS.CODE);
                if (!message.includes(MFA_SMS_PLACEHOLDERS.CODE)) {
                    throw Error("Invalid MFA settings. Property 'smsMessage' must utilize the 'code' parameter at least once as a placeholder for the verification code.");
                }
                return message;
            }
            return undefined;
        };
        /**
         * Setup External Providers (OAuth/OIDC/SAML) and related settings
         * such as OAuth settings and User Pool Domains
         */
        this.setupExternalProviders = (userPool, loginOptions) => {
            /**
             * If email is enabled, and is the only required attribute, we are able to
             * automatically map the email attribute from external providers, excluding SAML.
             */
            const shouldMapEmailAttributes = loginOptions.email && !loginOptions.phone;
            const result = {
                oAuthMappings: {},
                oAuthSettings: {
                    flows: defaults_js_1.DEFAULTS.OAUTH_FLOWS,
                },
            };
            // external providers
            const external = loginOptions.externalProviders;
            if (!external) {
                return result;
            }
            // make sure logout/callback urls are not empty
            if (external.logoutUrls && external.logoutUrls.length === 0) {
                throw Error('You must define logoutUrls when configuring external login providers.');
            }
            if (external.callbackUrls && external.callbackUrls.length === 0) {
                throw Error('You must define callbackUrls when configuring external login providers.');
            }
            if (external.google) {
                const googleProps = external.google;
                result.google = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderGoogle(this, `${this.name}GoogleIdP`, {
                    userPool,
                    clientId: googleProps.clientId,
                    clientSecretValue: googleProps.clientSecret,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.GOOGLE_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(googleProps.attributeMapping),
                    },
                    scopes: googleProps.scopes,
                });
                result.oAuthMappings[oauthProviderToProviderDomainMap.google] =
                    external.google.clientId;
            }
            if (external.facebook) {
                result.facebook = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderFacebook(this, `${this.name}FacebookIDP`, {
                    userPool,
                    ...external.facebook,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.FACEBOOK_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(external.facebook.attributeMapping),
                    },
                });
                result.oAuthMappings[oauthProviderToProviderDomainMap.facebook] =
                    external.facebook.clientId;
            }
            if (external.loginWithAmazon) {
                result.amazon = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderAmazon(this, `${this.name}AmazonIDP`, {
                    userPool,
                    ...external.loginWithAmazon,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.AMAZON_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(external.loginWithAmazon.attributeMapping),
                    },
                });
                result.oAuthMappings[oauthProviderToProviderDomainMap.amazon] =
                    external.loginWithAmazon.clientId;
            }
            if (external.signInWithApple) {
                result.apple = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderApple(this, `${this.name}AppleIDP`, {
                    userPool,
                    ...external.signInWithApple,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.APPLE_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(external.signInWithApple.attributeMapping),
                    },
                });
                result.oAuthMappings[oauthProviderToProviderDomainMap.apple] =
                    external.signInWithApple.clientId;
            }
            if (external.oidc && external.oidc.length > 0) {
                result.oidc = [];
                external.oidc.forEach((provider, index) => {
                    var _a, _b;
                    const requestMethod = provider.attributeRequestMethod === undefined
                        ? 'GET' // default if not defined
                        : provider.attributeRequestMethod;
                    const generatedProvider = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderOidc(this, `${this.name}${(_a = provider.name) !== null && _a !== void 0 ? _a : index}OidcIDP`, {
                        userPool,
                        attributeRequestMethod: requestMethod === 'GET'
                            ? aws_cognito_1.OidcAttributeRequestMethod.GET
                            : aws_cognito_1.OidcAttributeRequestMethod.POST,
                        clientId: provider.clientId,
                        clientSecret: provider.clientSecret,
                        endpoints: provider.endpoints,
                        identifiers: provider.identifiers,
                        issuerUrl: provider.issuerUrl,
                        name: provider.name,
                        scopes: provider.scopes,
                        attributeMapping: {
                            ...(shouldMapEmailAttributes
                                ? {
                                    email: {
                                        attributeName: 'email',
                                    },
                                }
                                : undefined),
                            ...this.convertToCognitoAttributeMapping(provider.attributeMapping),
                        },
                    });
                    (_b = result.oidc) === null || _b === void 0 ? void 0 : _b.push(generatedProvider);
                });
            }
            if (external.saml) {
                const saml = external.saml;
                result.saml = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderSaml(this, `${this.name}SamlIDP`, {
                    userPool,
                    attributeMapping: this.convertToCognitoAttributeMapping(saml.attributeMapping),
                    identifiers: saml.identifiers,
                    idpSignout: saml.idpSignout,
                    metadata: {
                        metadataContent: saml.metadata.metadataContent,
                        metadataType: saml.metadata.metadataType === 'FILE'
                            ? aws_cognito_1.UserPoolIdentityProviderSamlMetadataType.FILE
                            : aws_cognito_1.UserPoolIdentityProviderSamlMetadataType.URL,
                    },
                    name: saml.name,
                });
            }
            // Always generate a domain prefix if external provider is configured
            if (this.domainPrefix) {
                this.userPool.addDomain(`${this.name}UserPoolDomain`, {
                    cognitoDomain: { domainPrefix: this.domainPrefix },
                });
            }
            else {
                throw new Error('Cognito Domain Prefix is missing when external providers are configured.');
            }
            // oauth settings for the UserPool client
            result.oAuthSettings = {
                callbackUrls: external.callbackUrls,
                logoutUrls: external.logoutUrls,
                scopes: external.scopes
                    ? this.getOAuthScopes(external.scopes)
                    : DEFAULT_OAUTH_SCOPES,
                flows: defaults_js_1.DEFAULTS.OAUTH_FLOWS,
            };
            return result;
        };
        /**
         * Converts the simplified mapping type to cognito.AttributeMapping.
         * @param mapping the AttributeMapping to convert to a cognito.AttributeMapping
         * @returns cognito.AttributeMapping
         */
        this.convertToCognitoAttributeMapping = (mapping) => {
            if (!mapping) {
                return undefined;
            }
            const result = {};
            for (const [attrName, value] of Object.entries(mapping)) {
                if (typeof value === 'string') {
                    result[attrName] = {
                        attributeName: value,
                    };
                }
                if (typeof value === 'object' && attrName === 'custom') {
                    // dealing with custom attributes
                    const customAttributes = {};
                    for (const [customKey, attrName] of Object.entries(value)) {
                        customAttributes[customKey] = {
                            attributeName: attrName,
                        };
                    }
                    result[attrName] = customAttributes;
                }
            }
            return result;
        };
        /**
         * Convert scopes from string list to OAuthScopes.
         * @param scopes - scope list
         * @returns cognito OAuthScopes
         */
        this.getOAuthScopes = (scopes) => {
            if (scopes === undefined) {
                return [];
            }
            const result = [];
            for (const scope of scopes) {
                result.push(aws_cdk_lib_1.aws_cognito.OAuthScope[scope]);
            }
            return result;
        };
        /**
         * Stores auth output using the provided strategy
         */
        this.storeOutput = (outputStorageStrategy = new backend_output_storage_1.StackMetadataBackendOutputStorageStrategy(aws_cdk_lib_1.Stack.of(this))) => {
            const cfnUserPool = this.resources.cfnResources.cfnUserPool;
            const cfnUserPoolClient = this.resources.cfnResources.cfnUserPoolClient;
            const cfnIdentityPool = this.resources.cfnResources.cfnIdentityPool;
            // these properties cannot be overwritten
            const output = {
                userPoolId: this.resources.userPool.userPoolId,
                webClientId: this.resources.userPoolClient.userPoolClientId,
                identityPoolId: cfnIdentityPool.ref,
                authRegion: aws_cdk_lib_1.Stack.of(this).region,
            };
            // the properties below this line can be overwritten, so they are exposed via cdk LAZY
            output.allowUnauthenticatedIdentities = aws_cdk_lib_1.Lazy.string({
                produce: () => cfnIdentityPool.allowUnauthenticatedIdentities === true
                    ? 'true'
                    : 'false',
            });
            // extract signupAttributes from UserPool schema's required attributes
            output.signupAttributes = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    if (!cfnUserPool.schema) {
                        return '[]';
                    }
                    return JSON.stringify(cfnUserPool.schema
                        .filter((attribute) => attribute.required && attribute.name)
                        .map((attribute) => { var _a; return (_a = attribute.name) === null || _a === void 0 ? void 0 : _a.toLowerCase(); }));
                },
            });
            // extract usernameAttributes from UserPool's usernameAttributes
            output.usernameAttributes = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    return JSON.stringify(((_a = cfnUserPool.usernameAttributes) === null || _a === void 0 ? void 0 : _a.map((attr) => attr.toLowerCase())) ||
                        []);
                },
            });
            // extract verificationMechanisms from UserPool's autoVerifiedAttributes
            output.verificationMechanisms = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    return JSON.stringify((_a = cfnUserPool.autoVerifiedAttributes) !== null && _a !== void 0 ? _a : []);
                },
            });
            // extract the passwordPolicy from the UserPool policies
            output.passwordPolicyMinLength = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    if (!cfnUserPool.policies) {
                        return '';
                    }
                    const policy = cfnUserPool.policies
                        .passwordPolicy;
                    return (_a = policy.minimumLength) === null || _a === void 0 ? void 0 : _a.toString();
                },
            });
            output.passwordPolicyRequirements = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    if (!cfnUserPool.policies) {
                        return '';
                    }
                    const policy = cfnUserPool.policies
                        .passwordPolicy;
                    const requirements = [];
                    policy.requireNumbers && requirements.push('REQUIRES_NUMBERS');
                    policy.requireLowercase && requirements.push('REQUIRES_LOWERCASE');
                    policy.requireUppercase && requirements.push('REQUIRES_UPPERCASE');
                    policy.requireSymbols && requirements.push('REQUIRES_SYMBOLS');
                    return JSON.stringify(requirements);
                },
            });
            // extract the MFA configuration setting from the UserPool resource
            output.mfaConfiguration = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    return (_a = cfnUserPool.mfaConfiguration) !== null && _a !== void 0 ? _a : 'OFF';
                },
            });
            // extract the MFA types from the UserPool resource
            output.mfaTypes = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    const mfaTypes = [];
                    ((_a = cfnUserPool.enabledMfas) !== null && _a !== void 0 ? _a : []).forEach((type) => {
                        if (type === 'SMS_MFA') {
                            mfaTypes.push('SMS');
                        }
                        if (type === 'SOFTWARE_TOKEN_MFA') {
                            mfaTypes.push('TOTP');
                        }
                    });
                    return JSON.stringify(mfaTypes);
                },
            });
            // extract social providers from UserPool resource
            output.socialProviders = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    const outputProviders = [];
                    const userPoolProviders = this.resources.userPool.identityProviders;
                    if (!userPoolProviders || userPoolProviders.length === 0) {
                        return '';
                    }
                    for (const provider of userPoolProviders) {
                        const providerResource = provider.node.findChild('Resource');
                        if (!(providerResource instanceof aws_cognito_1.CfnUserPoolIdentityProvider)) {
                            throw Error('Could not find the CfnUserPoolIdentityProvider resource in the stack.');
                        }
                        const providerType = providerResource.providerType;
                        const providerName = providerResource.providerName;
                        if (providerType === 'Google') {
                            outputProviders.push('GOOGLE');
                        }
                        if (providerType === 'Facebook') {
                            outputProviders.push('FACEBOOK');
                        }
                        if (providerType === 'SignInWithApple') {
                            outputProviders.push('SIGN_IN_WITH_APPLE');
                        }
                        if (providerType === 'LoginWithAmazon') {
                            outputProviders.push('LOGIN_WITH_AMAZON');
                        }
                        if (providerType === 'OIDC') {
                            outputProviders.push(providerName);
                        }
                        if (providerType === 'SAML') {
                            outputProviders.push(providerName);
                        }
                    }
                    return JSON.stringify(outputProviders);
                },
            });
            output.oauthCognitoDomain = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    const userPoolDomain = this.resources.userPool.node.tryFindChild('UserPoolDomain');
                    if (!userPoolDomain) {
                        return '';
                    }
                    if (!(userPoolDomain instanceof aws_cognito_1.UserPoolDomain)) {
                        throw Error('Could not find UserPoolDomain resource in the stack.');
                    }
                    return `${userPoolDomain.domainName}.auth.${aws_cdk_lib_1.Stack.of(this).region}.amazoncognito.com`;
                },
            });
            output.oauthScope = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    return JSON.stringify((_a = cfnUserPoolClient.allowedOAuthScopes) !== null && _a !== void 0 ? _a : []);
                },
            });
            output.oauthRedirectSignIn = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    return cfnUserPoolClient.callbackUrLs
                        ? cfnUserPoolClient.callbackUrLs.join(',')
                        : '';
                },
            });
            output.oauthRedirectSignOut = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    return cfnUserPoolClient.logoutUrLs
                        ? cfnUserPoolClient.logoutUrLs.join(',')
                        : '';
                },
            });
            output.oauthResponseType = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    return cfnUserPoolClient.allowedOAuthFlows
                        ? cfnUserPoolClient.allowedOAuthFlows.join(',')
                        : '';
                },
            });
            output.oauthClientId = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    return cfnUserPoolClient.ref;
                },
            });
            outputStorageStrategy.addBackendOutputEntry(backend_output_schemas_1.authOutputKey, {
                version: '1',
                payload: output,
            });
        };
        this.name = (_a = props.name) !== null && _a !== void 0 ? _a : '';
        this.domainPrefix = (_b = props.loginWith.externalProviders) === null || _b === void 0 ? void 0 : _b.domainPrefix;
        // UserPool
        this.computedUserPoolProps = this.getUserPoolProps(props);
        this.userPool = new aws_cdk_lib_1.aws_cognito.UserPool(this, `${this.name}UserPool`, this.computedUserPoolProps);
        // UserPool - External Providers (Oauth, SAML, OIDC) and User Pool Domain
        this.providerSetupResult = this.setupExternalProviders(this.userPool, props.loginWith);
        // UserPool Client
        const userPoolClient = new aws_cdk_lib_1.aws_cognito.UserPoolClient(this, `${this.name}UserPoolAppClient`, {
            userPool: this.userPool,
            authFlows: defaults_js_1.DEFAULTS.AUTH_FLOWS,
            preventUserExistenceErrors: defaults_js_1.DEFAULTS.PREVENT_USER_EXISTENCE_ERRORS,
            oAuth: this.providerSetupResult.oAuthSettings,
        });
        // Identity Pool
        const { identityPool, identityPoolRoleAttachment, roles: { auth, unAuth }, } = this.setupIdentityPool(this.userPool, userPoolClient, this.providerSetupResult);
        // Setup UserPool groups
        this.setupUserPoolGroups(props.groups, identityPool);
        const cfnUserPool = this.userPool.node.findChild('Resource');
        if (!(cfnUserPool instanceof aws_cognito_1.CfnUserPool)) {
            throw Error('Could not find CfnUserPool resource in stack.');
        }
        const cfnUserPoolClient = userPoolClient.node.findChild('Resource');
        if (!(cfnUserPoolClient instanceof aws_cognito_1.CfnUserPoolClient)) {
            throw Error('Could not find CfnUserPoolClient resource in stack.');
        }
        // expose resources
        this.resources = {
            userPool: this.userPool,
            userPoolClient,
            authenticatedUserIamRole: auth,
            unauthenticatedUserIamRole: unAuth,
            cfnResources: {
                cfnUserPool,
                cfnUserPoolClient,
                cfnIdentityPool: identityPool,
                cfnIdentityPoolRoleAttachment: identityPoolRoleAttachment,
            },
            groups: this.groups,
        };
        this.storeOutput(props.outputStorageStrategy);
        new backend_output_storage_1.AttributionMetadataStorage().storeAttributionMetadata(aws_cdk_lib_1.Stack.of(this), authStackType, path.resolve(__dirname, '..', 'package.json'));
    }
    /**
     * Parses the user invitation settings and inserts codes/usernames where necessary.
     * @param settings the invitation settings
     * @returns cognito.UserInvitationConfig | undefined
     */
    getUserInvitationSettings(settings) {
        if (!settings) {
            return undefined;
        }
        return {
            emailSubject: settings.emailSubject,
            emailBody: settings.emailBody
                ? settings.emailBody(() => INVITATION_PLACEHOLDERS.USERNAME, () => INVITATION_PLACEHOLDERS.CODE)
                : undefined,
            smsMessage: settings.smsMessage
                ? settings.smsMessage(() => INVITATION_PLACEHOLDERS.USERNAME, () => INVITATION_PLACEHOLDERS.CODE)
                : undefined,
        };
    }
    /**
     * Verify the email body depending on if 'CODE' or 'LINK' style is used.
     * This ensures that the template contains the necessary placeholders for Cognito to insert verification codes or links.
     * @param emailSettings the provided email settings
     * @returns emailBody
     */
    verifyEmailBody(emailSettings) {
        let emailBody;
        if (emailSettings.verificationEmailBody &&
            emailSettings.verificationEmailStyle !== 'LINK') {
            emailBody = emailSettings.verificationEmailBody(() => VERIFICATION_EMAIL_PLACEHOLDERS.CODE);
            if (!emailBody.includes(VERIFICATION_EMAIL_PLACEHOLDERS.CODE)) {
                throw Error("Invalid email settings. Property 'verificationEmailBody' must utilize the 'code' parameter at least once as a placeholder for the verification code.");
            }
        }
        if (emailSettings.verificationEmailBody &&
            emailSettings.verificationEmailStyle === 'LINK') {
            let linkText = '';
            emailBody = emailSettings.verificationEmailBody((text) => {
                linkText = text
                    ? `{##${text}##}`
                    : VERIFICATION_EMAIL_PLACEHOLDERS.LINK;
                return linkText;
            });
            if (linkText === '' || !emailBody.includes(linkText)) {
                throw Error("Invalid email settings. Property 'verificationEmailBody' must utilize the 'link' parameter at least once as a placeholder for the verification link.");
            }
        }
        return emailBody;
    }
}
exports.AmplifyAuth = AmplifyAuth;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uc3RydWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NvbnN0cnVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUF1QztBQUN2Qyw2Q0FLcUI7QUFNckIseURBc0JpQztBQUNqQyxpREFBK0Q7QUFDL0QsZ0ZBQWdGO0FBT2hGLCtDQUF5QztBQUN6QyxnRkFHNkM7QUFDN0MsMkNBQTZCO0FBbUI3QixNQUFNLGdDQUFnQyxHQUF5QjtJQUM3RCxRQUFRLEVBQUUsb0JBQW9CO0lBQzlCLE1BQU0sRUFBRSxxQkFBcUI7SUFDN0IsTUFBTSxFQUFFLGdCQUFnQjtJQUN4QixLQUFLLEVBQUUsbUJBQW1CO0NBQzNCLENBQUM7QUFDRixNQUFNLHVCQUF1QixHQUFHO0lBQzlCLElBQUksRUFBRSxRQUFRO0lBQ2QsUUFBUSxFQUFFLFlBQVk7Q0FDdkIsQ0FBQztBQUNGLE1BQU0sK0JBQStCLEdBQUc7SUFDdEMsSUFBSSxFQUFFLFFBQVE7SUFDZCxJQUFJLEVBQUUsb0JBQW9CO0NBQzNCLENBQUM7QUFDRixNQUFNLDZCQUE2QixHQUFHO0lBQ3BDLElBQUksRUFBRSxRQUFRO0NBQ2YsQ0FBQztBQUNGLE1BQU0sb0JBQW9CLEdBQUc7SUFDM0IsSUFBSSxFQUFFLFFBQVE7Q0FDZixDQUFDO0FBQ0YsTUFBTSxvQkFBb0IsR0FBRztJQUMzQix3QkFBVSxDQUFDLEtBQUs7SUFDaEIsd0JBQVUsQ0FBQyxLQUFLO0lBQ2hCLHdCQUFVLENBQUMsTUFBTTtJQUNqQix3QkFBVSxDQUFDLE9BQU87SUFDbEIsd0JBQVUsQ0FBQyxhQUFhO0NBQ3pCLENBQUM7QUFFRixzSEFBc0g7QUFDdEgsTUFBTSxhQUFhLEdBQUcsY0FBYyxDQUFDO0FBRXJDOztHQUVHO0FBQ0gsTUFBYSxXQUNYLFNBQVEsc0JBQVM7SUEyQmpCOzs7T0FHRztJQUNILFlBQ0UsS0FBZ0IsRUFDaEIsRUFBVSxFQUNWLFFBQW1CLHNC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QUFDLFNBQVM7U0FDZCxDQUFDO0lBQ0osQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0ssZUFBZSxDQUNyQixhQUFpQztRQUVqQyxJQUFJLFNBQTZCLENBQUM7UUFDbEMsSUFDRSxhQUFhLENBQUMscUJBQXFCO1lBQ25DLGFBQWEsQ0FBQyxzQkFBc0IsS0FBSyxNQUFNLEVBQy9DO1lBQ0EsU0FBUyxHQUFHLGFBQWEsQ0FBQyxxQkFBcUIsQ0FDN0MsR0FBRyxFQUFFLENBQUMsK0JBQStCLENBQUMsSUFBSSxDQUMzQyxDQUFDO1lBQ0YsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsK0JBQStCLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQzdELE1BQU0sS0FBSyxDQUNULHNKQUFzSixDQUN2SixDQUFDO2FBQ0g7U0FDRjtRQUNELElBQ0UsYUFBYSxDQUFDLHFCQUFxQjtZQUNuQyxhQUFhLENBQUMsc0JBQXNCLEtBQUssTUFBTSxFQUMvQztZQUNBLElBQUksUUFBUSxHQUFXLEVBQUUsQ0FBQztZQUMxQixTQUFTLEdBQUcsYUFBYSxDQUFDLHFCQUFxQixDQUFDLENBQUMsSUFBYSxFQUFFLEVBQUU7Z0JBQ2hFLFFBQVEsR0FBRyxJQUFJO29CQUNiLENBQUMsQ0FBQyxNQUFNLElBQUksS0FBSztvQkFDakIsQ0FBQyxDQUFDLCtCQUErQixDQUFDLElBQUksQ0FBQztnQkFDekMsT0FBTyxRQUFRLENBQUM7WUFDbEIsQ0FBQyxDQUFDLENBQUM7WUFDSCxJQUFJLFFBQVEsS0FBSyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFO2dCQUNwRCxNQUFNLEtBQUssQ0FDVCxzSkFBc0osQ0FDdkosQ0FBQzthQUNIO1NBQ0Y7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0NBcWxCRjtBQXAvQkQsa0NBby9CQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHtcbiAgTGF6eSxcbiAgUmVtb3ZhbFBvbGljeSxcbiAgU3RhY2ssXG4gIGF3c19jb2duaXRvIGFzIGNvZ25pdG8sXG59IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7XG4gIEF1dGhSZXNvdXJjZXMsXG4gIEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG4gIFJlc291cmNlUHJvdmlkZXIsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHtcbiAgQ2ZuSWRlbnRpdHlQb29sLFxuICBDZm5Vc2VyUG9vbCxcbiAgQ2ZuVXNlclBvb2xDbGllbnQsXG4gIENmblVzZXJQb29sR3JvdXAsXG4gIENmblVzZXJQb29sSWRlbnRpdHlQcm92aWRlcixcbiAgTWZhLFxuICBNZmFTZWNvbmRGYWN0b3IsXG4gIE9BdXRoU2NvcGUsXG4gIE9pZGNBdHRyaWJ1dGVSZXF1ZXN0TWV0aG9kLFxuICBQcm92aWRlckF0dHJpYnV0ZSxcbiAgVXNlclBvb2wsXG4gIFVzZXJQb29sQ2xpZW50LFxuICBVc2VyUG9vbERvbWFpbixcbiAgVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyQW1hem9uLFxuICBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJBcHBsZSxcbiAgVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyRmFjZWJvb2ssXG4gIFVzZXJQb29sSWRlbnRpdHlQcm92aWRlckdvb2dsZSxcbiAgVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyT2lkYyxcbiAgVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyU2FtbCxcbiAgVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyU2FtbE1ldGFkYXRhVHlwZSxcbiAgVXNlclBvb2xQcm9wcyxcbn0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWNvZ25pdG8nO1xuaW1wb3J0IHsgRmVkZXJhdGVkUHJpbmNpcGFsLCBSb2xlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgeyBBdXRoT3V0cHV0LCBhdXRoT3V0cHV0S2V5IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0IHtcbiAgQXR0cmlidXRlTWFwcGluZyxcbiAgQXV0aFByb3BzLFxuICBFbWFpbExvZ2luU2V0dGluZ3MsXG4gIEV4dGVybmFsUHJvdmlkZXJPcHRpb25zLFxufSBmcm9tICcuL3R5cGVzLmpzJztcbmltcG9ydCB7IERFRkFVTFRTIH0gZnJvbSAnLi9kZWZhdWx0cy5qcyc7XG5pbXBvcnQge1xuICBBdHRyaWJ1dGlvbk1ldGFkYXRhU3RvcmFnZSxcbiAgU3RhY2tNZXRhZGF0YUJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zdG9yYWdlJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5cbnR5cGUgRGVmYXVsdFJvbGVzID0geyBhdXRoOiBSb2xlOyB1bkF1dGg6IFJvbGUgfTtcbnR5cGUgSWRlbnRpdHlQcm92aWRlclNldHVwUmVzdWx0ID0ge1xuICBvQXV0aE1hcHBpbmdzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuICBvQXV0aFNldHRpbmdzOiBjb2duaXRvLk9BdXRoU2V0dGluZ3MgfCB1bmRlZmluZWQ7XG4gIGdvb2dsZT86IFVzZXJQb29sSWRlbnRpdHlQcm92aWRlckdvb2dsZTtcbiAgZmFjZWJvb2s/OiBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJGYWNlYm9vaztcbiAgYW1hem9uPzogVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyQW1hem9uO1xuICBhcHBsZT86IFVzZXJQb29sSWRlbnRpdHlQcm92aWRlckFwcGxlO1xuICBvaWRjPzogVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyT2lkY1tdO1xuICBzYW1sPzogVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyU2FtbDtcbn07XG50eXBlIE9BdXRoUHJvdmlkZXJNYXBwaW5nID0ge1xuICBmYWNlYm9vazogc3RyaW5nO1xuICBnb29nbGU6IHN0cmluZztcbiAgYW1hem9uOiBzdHJpbmc7XG4gIGFwcGxlOiBzdHJpbmc7XG59O1xuY29uc3Qgb2F1dGhQcm92aWRlclRvUHJvdmlkZXJEb21haW5NYXA6IE9BdXRoUHJvdmlkZXJNYXBwaW5nID0ge1xuICBmYWNlYm9vazogJ2dyYXBoLmZhY2Vib29rLmNvbScsXG4gIGdvb2dsZTogJ2FjY291bnRzLmdvb2dsZS5jb20nLFxuICBhbWF6b246ICd3d3cuYW1hem9uLmNvbScsXG4gIGFwcGxlOiAnYXBwbGVpZC5hcHBsZS5jb20nLFxufTtcbmNvbnN0IElOVklUQVRJT05fUExBQ0VIT0xERVJTID0ge1xuICBDT0RFOiAneyMjIyN9JyxcbiAgVVNFUk5BTUU6ICd7dXNlcm5hbWV9Jyxcbn07XG5jb25zdCBWRVJJRklDQVRJT05fRU1BSUxfUExBQ0VIT0xERVJTID0ge1xuICBDT0RFOiAneyMjIyN9JyxcbiAgTElOSzogJ3sjI1ZlcmlmeSBFbWFpbCMjfScsXG59O1xuY29uc3QgVkVSSUZJQ0FUSU9OX1NNU19QTEFDRUhPTERFUlMgPSB7XG4gIENPREU6ICd7IyMjI30nLFxufTtcbmNvbnN0IE1GQV9TTVNfUExBQ0VIT0xERVJTID0ge1xuICBDT0RFOiAneyMjIyN9Jyxcbn07XG5jb25zdCBERUZBVUxUX09BVVRIX1NDT1BFUyA9IFtcbiAgT0F1dGhTY29wZS5QSE9ORSxcbiAgT0F1dGhTY29wZS5FTUFJTCxcbiAgT0F1dGhTY29wZS5PUEVOSUQsXG4gIE9BdXRoU2NvcGUuUFJPRklMRSxcbiAgT0F1dGhTY29wZS5DT0dOSVRPX0FETUlOLFxuXTtcblxuLy8gQmUgdmVyeSBjYXJlZnVsIGVkaXRpbmcgdGhpcyB2YWx1ZS4gSXQgaXMgdGhlIHN0cmluZyB0aGF0IGlzIHVzZWQgdG8gYXR0cmlidXRlIHN0YWNrcyB0byBBbXBsaWZ5IEF1dGggaW4gQkkgbWV0cmljc1xuY29uc3QgYXV0aFN0YWNrVHlwZSA9ICdhdXRoLUNvZ25pdG8nO1xuXG4vKipcbiAqIEFtcGxpZnkgQXV0aCBDREsgQ29uc3RydWN0XG4gKi9cbmV4cG9ydCBjbGFzcyBBbXBsaWZ5QXV0aFxuICBleHRlbmRzIENvbnN0cnVjdFxuICBpbXBsZW1lbnRzIFJlc291cmNlUHJvdmlkZXI8QXV0aFJlc291cmNlcz5cbntcbiAgLyoqXG4gICAqIFRoZSByZXNvdXJjZXMgZ2VuZXJhdGVkIGJ5IHRoZSBjb25zdHJ1Y3QuXG4gICAqL1xuICByZWFkb25seSByZXNvdXJjZXM6IEF1dGhSZXNvdXJjZXM7XG4gIC8qKlxuICAgKiBFeHRlcm5hbCBwcm92aWRlciBzZXR0aW5nc1xuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBwcm92aWRlclNldHVwUmVzdWx0OiBJZGVudGl0eVByb3ZpZGVyU2V0dXBSZXN1bHQ7XG5cbiAgcHJpdmF0ZSByZWFkb25seSB1c2VyUG9vbDogVXNlclBvb2w7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBjb21wdXRlZFVzZXJQb29sUHJvcHM6IFVzZXJQb29sUHJvcHM7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBuYW1lOiBzdHJpbmc7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBkb21haW5QcmVmaXg6IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuICBwcml2YXRlIHJlYWRvbmx5IGdyb3Vwczoge1xuICAgIFtrZXk6IHN0cmluZ106IHtcbiAgICAgIGNmblVzZXJHcm91cDogQ2ZuVXNlclBvb2xHcm91cDtcbiAgICAgIHJvbGU6IFJvbGU7XG4gICAgfTtcbiAgfSA9IHt9O1xuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgQXV0aCBjb25zdHJ1Y3Qgd2l0aCBBdXRoUHJvcHMuXG4gICAqIElmIG5vIHByb3BzIGFyZSBwcm92aWRlZCwgZW1haWwgbG9naW4gYW5kIGRlZmF1bHRzIHdpbGwgYmUgdXNlZC5cbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgaWQ6IHN0cmluZyxcbiAgICBwcm9wczogQXV0aFByb3BzID0gREVGQVVMVFMuSUZfTk9fUFJPUFNfUFJPVklERURcbiAgKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIHRoaXMubmFtZSA9IHByb3BzLm5hbWUgPz8gJyc7XG4gICAgdGhpcy5kb21haW5QcmVmaXggPSBwcm9wcy5sb2dpbldpdGguZXh0ZXJuYWxQcm92aWRlcnM/LmRvbWFpblByZWZpeDtcblxuICAgIC8vIFVzZXJQb29sXG4gICAgdGhpcy5jb21wdXRlZFVzZXJQb29sUHJvcHMgPSB0aGlzLmdldFVzZXJQb29sUHJvcHMocHJvcHMpO1xuICAgIHRoaXMudXNlclBvb2wgPSBuZXcgY29nbml0by5Vc2VyUG9vbChcbiAgICAgIHRoaXMsXG4gICAgICBgJHt0aGlzLm5hbWV9VXNlclBvb2xgLFxuICAgICAgdGhpcy5jb21wdXRlZFVzZXJQb29sUHJvcHNcbiAgICApO1xuXG4gICAgLy8gVXNlclBvb2wgLSBFeHRlcm5hbCBQcm92aWRlcnMgKE9hdXRoLCBTQU1MLCBPSURDKSBhbmQgVXNlciBQb29sIERvbWFpblxuICAgIHRoaXMucHJvdmlkZXJTZXR1cFJlc3VsdCA9IHRoaXMuc2V0dXBFeHRlcm5hbFByb3ZpZGVycyhcbiAgICAgIHRoaXMudXNlclBvb2wsXG4gICAgICBwcm9wcy5sb2dpbldpdGhcbiAgICApO1xuXG4gICAgLy8gVXNlclBvb2wgQ2xpZW50XG4gICAgY29uc3QgdXNlclBvb2xDbGllbnQgPSBuZXcgY29nbml0by5Vc2VyUG9vbENsaWVudChcbiAgICAgIHRoaXMsXG4gICAgICBgJHt0aGlzLm5hbWV9VXNlclBvb2xBcHBDbGllbnRgLFxuICAgICAge1xuICAgICAgICB1c2VyUG9vbDogdGhpcy51c2VyUG9vbCxcbiAgICAgICAgYXV0aEZsb3dzOiBERUZBVUxUUy5BVVRIX0ZMT1dTLFxuICAgICAgICBwcmV2ZW50VXNlckV4aXN0ZW5jZUVycm9yczogREVGQVVMVFMuUFJFVkVOVF9VU0VSX0VYSVNURU5DRV9FUlJPUlMsXG4gICAgICAgIG9BdXRoOiB0aGlzLnByb3ZpZGVyU2V0dXBSZXN1bHQub0F1dGhTZXR0aW5ncyxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgLy8gSWRlbnRpdHkgUG9vbFxuICAgIGNvbnN0IHtcbiAgICAgIGlkZW50aXR5UG9vbCxcbiAgICAgIGlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50LFxuICAgICAgcm9sZXM6IHsgYXV0aCwgdW5BdXRoIH0sXG4gICAgfSA9IHRoaXMuc2V0dXBJZGVudGl0eVBvb2woXG4gICAgICB0aGlzLnVzZXJQb29sLFxuICAgICAgdXNlclBvb2xDbGllbnQsXG4gICAgICB0aGlzLnByb3ZpZGVyU2V0dXBSZXN1bHRcbiAgICApO1xuXG4gICAgLy8gU2V0dXAgVXNlclBvb2wgZ3JvdXBzXG4gICAgdGhpcy5zZXR1cFVzZXJQb29sR3JvdXBzKHByb3BzLmdyb3VwcywgaWRlbnRpdHlQb29sKTtcblxuICAgIGNvbnN0IGNmblVzZXJQb29sID0gdGhpcy51c2VyUG9vbC5ub2RlLmZpbmRDaGlsZCgnUmVzb3VyY2UnKSBhcyBDZm5Vc2VyUG9vbDtcbiAgICBpZiAoIShjZm5Vc2VyUG9vbCBpbnN0YW5jZW9mIENmblVzZXJQb29sKSkge1xuICAgICAgdGhyb3cgRXJyb3IoJ0NvdWxkIG5vdCBmaW5kIENmblVzZXJQb29sIHJlc291cmNlIGluIHN0YWNrLicpO1xuICAgIH1cbiAgICBjb25zdCBjZm5Vc2VyUG9vbENsaWVudCA9IHVzZXJQb29sQ2xpZW50Lm5vZGUuZmluZENoaWxkKFxuICAgICAgJ1Jlc291cmNlJ1xuICAgICkgYXMgQ2ZuVXNlclBvb2xDbGllbnQ7XG4gICAgaWYgKCEoY2ZuVXNlclBvb2xDbGllbnQgaW5zdGFuY2VvZiBDZm5Vc2VyUG9vbENsaWVudCkpIHtcbiAgICAgIHRocm93IEVycm9yKCdDb3VsZCBub3QgZmluZCBDZm5Vc2VyUG9vbENsaWVudCByZXNvdXJjZSBpbiBzdGFjay4nKTtcbiAgICB9XG4gICAgLy8gZXhwb3NlIHJlc291cmNlc1xuICAgIHRoaXMucmVzb3VyY2VzID0ge1xuICAgICAgdXNlclBvb2w6IHRoaXMudXNlclBvb2wsXG4gICAgICB1c2VyUG9vbENsaWVudCxcbiAgICAgIGF1dGhlbnRpY2F0ZWRVc2VySWFtUm9sZTogYXV0aCxcbiAgICAgIHVuYXV0aGVudGljYXRlZFVzZXJJYW1Sb2xlOiB1bkF1dGgsXG4gICAgICBjZm5SZXNvdXJjZXM6IHtcbiAgICAgICAgY2ZuVXNlclBvb2wsXG4gICAgICAgIGNmblVzZXJQb29sQ2xpZW50LFxuICAgICAgICBjZm5JZGVudGl0eVBvb2w6IGlkZW50aXR5UG9vbCxcbiAgICAgICAgY2ZuSWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQ6IGlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50LFxuICAgICAgfSxcbiAgICAgIGdyb3VwczogdGhpcy5ncm91cHMsXG4gICAgfTtcbiAgICB0aGlzLnN0b3JlT3V0cHV0KHByb3BzLm91dHB1dFN0b3JhZ2VTdHJhdGVneSk7XG5cbiAgICBuZXcgQXR0cmlidXRpb25NZXRhZGF0YVN0b3JhZ2UoKS5zdG9yZUF0dHJpYnV0aW9uTWV0YWRhdGEoXG4gICAgICBTdGFjay5vZih0aGlzKSxcbiAgICAgIGF1dGhTdGFja1R5cGUsXG4gICAgICBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAncGFja2FnZS5qc29uJylcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBBdXRoL1VuQXV0aCBSb2xlc1xuICAgKiBAcmV0dXJucyBEZWZhdWx0Um9sZXNcbiAgICovXG4gIHByaXZhdGUgc2V0dXBBdXRoQW5kVW5BdXRoUm9sZXMgPSAoaWRlbnRpdHlQb29sSWQ6IHN0cmluZyk6IERlZmF1bHRSb2xlcyA9PiB7XG4gICAgY29uc3QgcmVzdWx0OiBEZWZhdWx0Um9sZXMgPSB7XG4gICAgICBhdXRoOiBuZXcgUm9sZSh0aGlzLCBgJHt0aGlzLm5hbWV9YXV0aGVudGljYXRlZFVzZXJSb2xlYCwge1xuICAgICAgICBhc3N1bWVkQnk6IG5ldyBGZWRlcmF0ZWRQcmluY2lwYWwoXG4gICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbScsXG4gICAgICAgICAge1xuICAgICAgICAgICAgU3RyaW5nRXF1YWxzOiB7XG4gICAgICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YXVkJzogaWRlbnRpdHlQb29sSWQsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ0ZvckFueVZhbHVlOlN0cmluZ0xpa2UnOiB7XG4gICAgICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YW1yJzogJ2F1dGhlbnRpY2F0ZWQnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgICdzdHM6QXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eSdcbiAgICAgICAgKSxcbiAgICAgIH0pLFxuICAgICAgdW5BdXRoOiBuZXcgUm9sZSh0aGlzLCBgJHt0aGlzLm5hbWV9dW5hdXRoZW50aWNhdGVkVXNlclJvbGVgLCB7XG4gICAgICAgIGFzc3VtZWRCeTogbmV3IEZlZGVyYXRlZFByaW5jaXBhbChcbiAgICAgICAgICAnY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tJyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBTdHJpbmdFcXVhbHM6IHtcbiAgICAgICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbTphdWQnOiBpZGVudGl0eVBvb2xJZCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAnRm9yQW55VmFsdWU6U3RyaW5nTGlrZSc6IHtcbiAgICAgICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbTphbXInOiAndW5hdXRoZW50aWNhdGVkJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICAnc3RzOkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHknXG4gICAgICAgICksXG4gICAgICB9KSxcbiAgICB9O1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIEF1dG8gZ2VuZXJhdGUgdGhlIHVzZXIgcG9vbCBncm91cHMgYW5kIGdyb3VwIHJvbGVzXG4gICAqL1xuICBwcml2YXRlIHNldHVwVXNlclBvb2xHcm91cHMgPSAoXG4gICAgZ3JvdXBzOiBzdHJpbmdbXSB8IHVuZGVmaW5lZCxcbiAgICBpZGVudGl0eVBvb2w6IENmbklkZW50aXR5UG9vbFxuICApID0+IHtcbiAgICAoZ3JvdXBzIHx8IFtdKS5mb3JFYWNoKChncm91cE5hbWUsIGluZGV4KSA9PiB7XG4gICAgICBjb25zdCBncm91cFJvbGUgPSBuZXcgUm9sZSh0aGlzLCBgJHt0aGlzLm5hbWV9JHtncm91cE5hbWV9R3JvdXBSb2xlYCwge1xuICAgICAgICBhc3N1bWVkQnk6IG5ldyBGZWRlcmF0ZWRQcmluY2lwYWwoXG4gICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbScsXG4gICAgICAgICAge1xuICAgICAgICAgICAgU3RyaW5nRXF1YWxzOiB7XG4gICAgICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YXVkJzogaWRlbnRpdHlQb29sLnJlZixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAnRm9yQW55VmFsdWU6U3RyaW5nTGlrZSc6IHtcbiAgICAgICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbTphbXInOiAnYXV0aGVudGljYXRlZCcsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgJ3N0czpBc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5J1xuICAgICAgICApLFxuICAgICAgfSk7XG4gICAgICBjb25zdCBjdXJyZW50R3JvdXAgPSBuZXcgQ2ZuVXNlclBvb2xHcm91cChcbiAgICAgICAgdGhpcyxcbiAgICAgICAgYCR7dGhpcy5uYW1lfSR7Z3JvdXBOYW1lfUdyb3VwYCxcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJQb29sSWQ6IHRoaXMudXNlclBvb2wudXNlclBvb2xJZCxcbiAgICAgICAgICBncm91cE5hbWU6IGdyb3VwTmFtZSxcbiAgICAgICAgICByb2xlQXJuOiBncm91cFJvbGUucm9sZUFybixcbiAgICAgICAgICBwcmVjZWRlbmNlOiBpbmRleCxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIHRoaXMuZ3JvdXBzW2dyb3VwTmFtZV0gPSB7XG4gICAgICAgIGNmblVzZXJHcm91cDogY3VycmVudEdyb3VwLFxuICAgICAgICByb2xlOiBncm91cFJvbGUsXG4gICAgICB9O1xuICAgIH0pO1xuICB9O1xuXG4gIC8qKlxuICAgKiBTZXR1cCBJZGVudGl0eSBQb29sIHdpdGggZGVmYXVsdCByb2xlcy9yb2xlIG1hcHBpbmdzLCBhbmQgcmVnaXN0ZXIgcHJvdmlkZXJzXG4gICAqL1xuICBwcml2YXRlIHNldHVwSWRlbnRpdHlQb29sID0gKFxuICAgIHVzZXJQb29sOiBVc2VyUG9vbCxcbiAgICB1c2VyUG9vbENsaWVudDogVXNlclBvb2xDbGllbnQsXG4gICAgcHJvdmlkZXJTZXR1cFJlc3VsdDogSWRlbnRpdHlQcm92aWRlclNldHVwUmVzdWx0XG4gICkgPT4ge1xuICAgIC8vIHNldHVwIGlkZW50aXR5IHBvb2xcbiAgICBjb25zdCByZWdpb24gPSBTdGFjay5vZih0aGlzKS5yZWdpb247XG4gICAgY29uc3QgaWRlbnRpdHlQb29sID0gbmV3IGNvZ25pdG8uQ2ZuSWRlbnRpdHlQb29sKFxuICAgICAgdGhpcyxcbiAgICAgIGAke3RoaXMubmFtZX1JZGVudGl0eVBvb2xgLFxuICAgICAge1xuICAgICAgICBhbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXM6XG4gICAgICAgICAgREVGQVVMVFMuQUxMT1dfVU5BVVRIRU5USUNBVEVEX0lERU5USVRJRVMsXG4gICAgICB9XG4gICAgKTtcbiAgICBjb25zdCByb2xlcyA9IHRoaXMuc2V0dXBBdXRoQW5kVW5BdXRoUm9sZXMoaWRlbnRpdHlQb29sLnJlZik7XG4gICAgY29uc3QgaWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQgPVxuICAgICAgbmV3IGNvZ25pdG8uQ2ZuSWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3RoaXMubmFtZX1JZGVudGl0eVBvb2xSb2xlQXR0YWNobWVudGAsXG4gICAgICAgIHtcbiAgICAgICAgICBpZGVudGl0eVBvb2xJZDogaWRlbnRpdHlQb29sLnJlZixcbiAgICAgICAgICByb2xlczoge1xuICAgICAgICAgICAgdW5hdXRoZW50aWNhdGVkOiByb2xlcy51bkF1dGgucm9sZUFybixcbiAgICAgICAgICAgIGF1dGhlbnRpY2F0ZWQ6IHJvbGVzLmF1dGgucm9sZUFybixcbiAgICAgICAgICB9LFxuICAgICAgICAgIHJvbGVNYXBwaW5nczoge1xuICAgICAgICAgICAgVXNlclBvb2xXZWJDbGllbnRSb2xlTWFwcGluZzoge1xuICAgICAgICAgICAgICB0eXBlOiAnVG9rZW4nLFxuICAgICAgICAgICAgICBhbWJpZ3VvdXNSb2xlUmVzb2x1dGlvbjogJ0F1dGhlbnRpY2F0ZWRSb2xlJyxcbiAgICAgICAgICAgICAgaWRlbnRpdHlQcm92aWRlcjogYGNvZ25pdG8taWRwLiR7cmVnaW9ufS5hbWF6b25hd3MuY29tLyR7dXNlclBvb2wudXNlclBvb2xJZH06JHt1c2VyUG9vbENsaWVudC51c2VyUG9vbENsaWVudElkfWAsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgaWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQuYWRkRGVwZW5kZW5jeShpZGVudGl0eVBvb2wpO1xuICAgIGlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50Lm5vZGUuYWRkRGVwZW5kZW5jeSh1c2VyUG9vbENsaWVudCk7XG4gICAgLy8gYWRkIGNvZ25pdG8gcHJvdmlkZXJcbiAgICBpZGVudGl0eVBvb2wuY29nbml0b0lkZW50aXR5UHJvdmlkZXJzID0gW1xuICAgICAge1xuICAgICAgICBjbGllbnRJZDogdXNlclBvb2xDbGllbnQudXNlclBvb2xDbGllbnRJZCxcbiAgICAgICAgcHJvdmlkZXJOYW1lOiBgY29nbml0by1pZHAuJHtyZWdpb259LmFtYXpvbmF3cy5jb20vJHt1c2VyUG9vbC51c2VyUG9vbElkfWAsXG4gICAgICB9LFxuICAgIF07XG4gICAgLy8gYWRkIG90aGVyIHByb3ZpZGVyc1xuICAgIGlkZW50aXR5UG9vbC5zdXBwb3J0ZWRMb2dpblByb3ZpZGVycyA9IHByb3ZpZGVyU2V0dXBSZXN1bHQub0F1dGhNYXBwaW5ncztcbiAgICByZXR1cm4ge1xuICAgICAgaWRlbnRpdHlQb29sLFxuICAgICAgaWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQsXG4gICAgICByb2xlcyxcbiAgICB9O1xuICB9O1xuXG4gIC8qKlxuICAgKiBQcm9jZXNzIHByb3BzIGludG8gVXNlclBvb2xQcm9wcyAoc2V0IGRlZmF1bHRzIGlmIG5lZWRlZClcbiAgICovXG4gIHByaXZhdGUgZ2V0VXNlclBvb2xQcm9wcyA9IChwcm9wczogQXV0aFByb3BzKTogVXNlclBvb2xQcm9wcyA9PiB7XG4gICAgY29uc3QgZW1haWxFbmFibGVkID0gcHJvcHMubG9naW5XaXRoLmVtYWlsID8gdHJ1ZSA6IGZhbHNlO1xuICAgIGNvbnN0IHBob25lRW5hYmxlZCA9IHByb3BzLmxvZ2luV2l0aC5waG9uZSA/IHRydWUgOiBmYWxzZTtcbiAgICBjb25zdCBvbmVPZkVtYWlsT3JQaG9uZSA9IGVtYWlsRW5hYmxlZCB8fCBwaG9uZUVuYWJsZWQ7XG4gICAgaWYgKCFvbmVPZkVtYWlsT3JQaG9uZSkge1xuICAgICAgdGhyb3cgRXJyb3IoJ0F0IGxlYXN0IG9uZSBvZiBlbWFpbCBvciBwaG9uZSBtdXN0IGJlIGVuYWJsZWQuJyk7XG4gICAgfVxuICAgIGxldCB1c2VyVmVyaWZpY2F0aW9uU2V0dGluZ3M6IGNvZ25pdG8uVXNlclZlcmlmaWNhdGlvbkNvbmZpZyA9IHt9O1xuICAgIC8vIGV4dHJhY3QgZW1haWwgc2V0dGluZ3MgaWYgc2V0dGluZ3Mgb2JqZWN0IGlzIGRlZmluZWRcbiAgICBpZiAodHlwZW9mIHByb3BzLmxvZ2luV2l0aC5lbWFpbCA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGNvbnN0IGVtYWlsU2V0dGluZ3MgPSBwcm9wcy5sb2dpbldpdGguZW1haWw7XG4gICAgICAvLyB2ZXJpZnkgZW1haWwgYm9keSBhbmQgaW5qZWN0IHRoZSBhY3R1YWwgdGVtcGxhdGUgdmFsdWVzIHdoaWNoIGNvZ25pdG8gdXNlc1xuICAgICAgY29uc3QgZW1haWxCb2R5OiBzdHJpbmcgfCB1bmRlZmluZWQgPSB0aGlzLnZlcmlmeUVtYWlsQm9keShlbWFpbFNldHRpbmdzKTtcbiAgICAgIHVzZXJWZXJpZmljYXRpb25TZXR0aW5ncyA9IHtcbiAgICAgICAgZW1haWxCb2R5OiBlbWFpbEJvZHksXG4gICAgICAgIGVtYWlsU3R5bGU6IHRoaXMuZ2V0RW1haWxWZXJpZmljYXRpb25TdHlsZShcbiAgICAgICAgICBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsU3R5bGVcbiAgICAgICAgKSxcbiAgICAgICAgZW1haWxTdWJqZWN0OiBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsU3ViamVjdCxcbiAgICAgIH07XG4gICAgfVxuICAgIC8vIGV4dHJhY3QgcGhvbmUgc2V0dGluZ3MgaWYgc2V0dGluZ3Mgb2JqZWN0IGlzIGRlZmluZWRcbiAgICBpZiAodHlwZW9mIHByb3BzLmxvZ2luV2l0aC5waG9uZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGNvbnN0IHBob25lU2V0dGluZ3MgPSBwcm9wcy5sb2dpbldpdGgucGhvbmU7XG4gICAgICBsZXQgc21zTWVzc2FnZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgICAgaWYgKFxuICAgICAgICBwaG9uZVNldHRpbmdzLnZlcmlmaWNhdGlvbk1lc3NhZ2UgJiZcbiAgICAgICAgdHlwZW9mIHBob25lU2V0dGluZ3MudmVyaWZpY2F0aW9uTWVzc2FnZSA9PT0gJ2Z1bmN0aW9uJ1xuICAgICAgKSB7XG4gICAgICAgIC8vIHZhbGlkYXRlIHNtcyBtZXNzYWdlIHN0cnVjdHVyZVxuICAgICAgICBzbXNNZXNzYWdlID0gcGhvbmVTZXR0aW5ncy52ZXJpZmljYXRpb25NZXNzYWdlKFxuICAgICAgICAgICgpID0+IFZFUklGSUNBVElPTl9TTVNfUExBQ0VIT0xERVJTLkNPREVcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKCFzbXNNZXNzYWdlLmluY2x1ZGVzKFZFUklGSUNBVElPTl9TTVNfUExBQ0VIT0xERVJTLkNPREUpKSB7XG4gICAgICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgICAgICBcIkludmFsaWQgcGhvbmUgc2V0dGluZ3MuIFByb3BlcnR5ICd2ZXJpZmljYXRpb25NZXNzYWdlJyBtdXN0IHV0aWxpemUgdGhlICdjb2RlJyBwYXJhbWV0ZXIgYXQgbGVhc3Qgb25jZSBhcyBhIHBsYWNlaG9sZGVyIGZvciB0aGUgdmVyaWZpY2F0aW9uIGNvZGUuXCJcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB1c2VyVmVyaWZpY2F0aW9uU2V0dGluZ3MgPSB7XG4gICAgICAgIC4uLnVzZXJWZXJpZmljYXRpb25TZXR0aW5ncyxcbiAgICAgICAgc21zTWVzc2FnZTogc21zTWVzc2FnZSxcbiAgICAgIH07XG4gICAgfVxuICAgIGNvbnN0IG1mYVR5cGUgPSB0aGlzLmdldE1GQVR5cGUocHJvcHMubXVsdGlmYWN0b3IpO1xuICAgIGNvbnN0IG1mYU1vZGUgPSB0aGlzLmdldE1GQU1vZGUocHJvcHMubXVsdGlmYWN0b3IpO1xuXG4gICAgLy8gSWYgcGhvbmUgbG9naW4gaXMgZW5hYmxlZCBhbG9uZyB3aXRoIE1GQSwgY29nbml0byByZXF1aXJlcyB0aGF0IG1mYSBTTVMgdHlwZSB0byBiZSBlbmFibGVkLlxuICAgIGlmIChwaG9uZUVuYWJsZWQgJiYgbWZhTW9kZSAmJiBtZmFNb2RlICE9PSAnT0ZGJyAmJiAhbWZhVHlwZT8uc21zKSB7XG4gICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgJ0ludmFsaWQgTUZBIHNldHRpbmdzLiBTTVMgbXVzdCBiZSBlbmFibGVkIGluIG11bHRpRmFjdG9yIGlmIGxvZ2luV2l0aCBwaG9uZSBpcyBlbmFibGVkJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCB1c2VyUG9vbFByb3BzOiBVc2VyUG9vbFByb3BzID0ge1xuICAgICAgc2lnbkluQ2FzZVNlbnNpdGl2ZTogREVGQVVMVFMuU0lHTl9JTl9DQVNFX1NFTlNJVElWRSxcbiAgICAgIHNpZ25JbkFsaWFzZXM6IHtcbiAgICAgICAgcGhvbmU6IHBob25lRW5hYmxlZCxcbiAgICAgICAgZW1haWw6IGVtYWlsRW5hYmxlZCxcbiAgICAgIH0sXG4gICAgICBrZWVwT3JpZ2luYWw6IHtcbiAgICAgICAgZW1haWw6IGVtYWlsRW5hYmxlZCxcbiAgICAgICAgcGhvbmU6IHBob25lRW5hYmxlZCxcbiAgICAgIH0sXG4gICAgICBhdXRvVmVyaWZ5OiB7XG4gICAgICAgIGVtYWlsOiBlbWFpbEVuYWJsZWQsXG4gICAgICAgIHBob25lOiBwaG9uZUVuYWJsZWQsXG4gICAgICB9LFxuICAgICAgdXNlclZlcmlmaWNhdGlvbjogdXNlclZlcmlmaWNhdGlvblNldHRpbmdzLFxuICAgICAgcGFzc3dvcmRQb2xpY3k6IERFRkFVTFRTLlBBU1NXT1JEX1BPTElDWSxcbiAgICAgIHN0YW5kYXJkQXR0cmlidXRlczoge1xuICAgICAgICBlbWFpbDogREVGQVVMVFMuSVNfUkVRVUlSRURfQVRUUklCVVRFLmVtYWlsKGVtYWlsRW5hYmxlZCksXG4gICAgICAgIHBob25lTnVtYmVyOiBERUZBVUxUUy5JU19SRVFVSVJFRF9BVFRSSUJVVEUucGhvbmVOdW1iZXIocGhvbmVFbmFibGVkKSxcbiAgICAgICAgLi4uKHByb3BzLnVzZXJBdHRyaWJ1dGVzID8gcHJvcHMudXNlckF0dHJpYnV0ZXMgOiB7fSksXG4gICAgICB9LFxuICAgICAgc2VsZlNpZ25VcEVuYWJsZWQ6IERFRkFVTFRTLkFMTE9XX1NFTEZfU0lHTl9VUCxcbiAgICAgIG1mYTogbWZhTW9kZSxcbiAgICAgIG1mYU1lc3NhZ2U6IHRoaXMuZ2V0TUZBTWVzc2FnZShwcm9wcy5tdWx0aWZhY3RvciksXG4gICAgICBtZmFTZWNvbmRGYWN0b3I6IG1mYVR5cGUsXG4gICAgICBhY2NvdW50UmVjb3Zlcnk6IHRoaXMuZ2V0QWNjb3VudFJlY292ZXJ5U2V0dGluZyhcbiAgICAgICAgZW1haWxFbmFibGVkLFxuICAgICAgICBwaG9uZUVuYWJsZWQsXG4gICAgICAgIHByb3BzLmFjY291bnRSZWNvdmVyeVxuICAgICAgKSxcbiAgICAgIHJlbW92YWxQb2xpY3k6IFJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICAgIHVzZXJJbnZpdGF0aW9uOlxuICAgICAgICB0eXBlb2YgcHJvcHMubG9naW5XaXRoLmVtYWlsICE9PSAnYm9vbGVhbidcbiAgICAgICAgICA/IHRoaXMuZ2V0VXNlckludml0YXRpb25TZXR0aW5ncyhcbiAgICAgICAgICAgICAgcHJvcHMubG9naW5XaXRoLmVtYWlsPy51c2VySW52aXRhdGlvblxuICAgICAgICAgICAgKVxuICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgIH07XG4gICAgcmV0dXJuIHVzZXJQb29sUHJvcHM7XG4gIH07XG5cbiAgLyoqXG4gICAqIFBhcnNlcyB0aGUgdXNlciBpbnZpdGF0aW9uIHNldHRpbmdzIGFuZCBpbnNlcnRzIGNvZGVzL3VzZXJuYW1lcyB3aGVyZSBuZWNlc3NhcnkuXG4gICAqIEBwYXJhbSBzZXR0aW5ncyB0aGUgaW52aXRhdGlvbiBzZXR0aW5nc1xuICAgKiBAcmV0dXJucyBjb2duaXRvLlVzZXJJbnZpdGF0aW9uQ29uZmlnIHwgdW5kZWZpbmVkXG4gICAqL1xuICBwcml2YXRlIGdldFVzZXJJbnZpdGF0aW9uU2V0dGluZ3MoXG4gICAgc2V0dGluZ3M6IEVtYWlsTG9naW5TZXR0aW5nc1sndXNlckludml0YXRpb24nXVxuICApOiBjb2duaXRvLlVzZXJJbnZpdGF0aW9uQ29uZmlnIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoIXNldHRpbmdzKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgZW1haWxTdWJqZWN0OiBzZXR0aW5ncy5lbWFpbFN1YmplY3QsXG4gICAgICBlbWFpbEJvZHk6IHNldHRpbmdzLmVtYWlsQm9keVxuICAgICAgICA/IHNldHRpbmdzLmVtYWlsQm9keShcbiAgICAgICAgICAgICgpID0+IElOVklUQVRJT05fUExBQ0VIT0xERVJTLlVTRVJOQU1FLFxuICAgICAgICAgICAgKCkgPT4gSU5WSVRBVElPTl9QTEFDRUhPTERFUlMuQ09ERVxuICAgICAgICAgIClcbiAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICBzbXNNZXNzYWdlOiBzZXR0aW5ncy5zbXNNZXNzYWdlXG4gICAgICAgID8gc2V0dGluZ3Muc21zTWVzc2FnZShcbiAgICAgICAgICAgICgpID0+IElOVklUQVRJT05fUExBQ0VIT0xERVJTLlVTRVJOQU1FLFxuICAgICAgICAgICAgKCkgPT4gSU5WSVRBVElPTl9QTEFDRUhPTERFUlMuQ09ERVxuICAgICAgICAgIClcbiAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZnkgdGhlIGVtYWlsIGJvZHkgZGVwZW5kaW5nIG9uIGlmICdDT0RFJyBvciAnTElOSycgc3R5bGUgaXMgdXNlZC5cbiAgICogVGhpcyBlbnN1cmVzIHRoYXQgdGhlIHRlbXBsYXRlIGNvbnRhaW5zIHRoZSBuZWNlc3NhcnkgcGxhY2Vob2xkZXJzIGZvciBDb2duaXRvIHRvIGluc2VydCB2ZXJpZmljYXRpb24gY29kZXMgb3IgbGlua3MuXG4gICAqIEBwYXJhbSBlbWFpbFNldHRpbmdzIHRoZSBwcm92aWRlZCBlbWFpbCBzZXR0aW5nc1xuICAgKiBAcmV0dXJucyBlbWFpbEJvZHlcbiAgICovXG4gIHByaXZhdGUgdmVyaWZ5RW1haWxCb2R5KFxuICAgIGVtYWlsU2V0dGluZ3M6IEVtYWlsTG9naW5TZXR0aW5nc1xuICApOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIGxldCBlbWFpbEJvZHk6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBpZiAoXG4gICAgICBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsQm9keSAmJlxuICAgICAgZW1haWxTZXR0aW5ncy52ZXJpZmljYXRpb25FbWFpbFN0eWxlICE9PSAnTElOSydcbiAgICApIHtcbiAgICAgIGVtYWlsQm9keSA9IGVtYWlsU2V0dGluZ3MudmVyaWZpY2F0aW9uRW1haWxCb2R5KFxuICAgICAgICAoKSA9PiBWRVJJRklDQVRJT05fRU1BSUxfUExBQ0VIT0xERVJTLkNPREVcbiAgICAgICk7XG4gICAgICBpZiAoIWVtYWlsQm9keS5pbmNsdWRlcyhWRVJJRklDQVRJT05fRU1BSUxfUExBQ0VIT0xERVJTLkNPREUpKSB7XG4gICAgICAgIHRocm93IEVycm9yKFxuICAgICAgICAgIFwiSW52YWxpZCBlbWFpbCBzZXR0aW5ncy4gUHJvcGVydHkgJ3ZlcmlmaWNhdGlvbkVtYWlsQm9keScgbXVzdCB1dGlsaXplIHRoZSAnY29kZScgcGFyYW1ldGVyIGF0IGxlYXN0IG9uY2UgYXMgYSBwbGFjZWhvbGRlciBmb3IgdGhlIHZlcmlmaWNhdGlvbiBjb2RlLlwiXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChcbiAgICAgIGVtYWlsU2V0dGluZ3MudmVyaWZpY2F0aW9uRW1haWxCb2R5ICYmXG4gICAgICBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsU3R5bGUgPT09ICdMSU5LJ1xuICAgICkge1xuICAgICAgbGV0IGxpbmtUZXh0OiBzdHJpbmcgPSAnJztcbiAgICAgIGVtYWlsQm9keSA9IGVtYWlsU2V0dGluZ3MudmVyaWZpY2F0aW9uRW1haWxCb2R5KCh0ZXh0Pzogc3RyaW5nKSA9PiB7XG4gICAgICAgIGxpbmtUZXh0ID0gdGV4dFxuICAgICAgICAgID8gYHsjIyR7dGV4dH0jI31gXG4gICAgICAgICAgOiBWRVJJRklDQVRJT05fRU1BSUxfUExBQ0VIT0xERVJTLkxJTks7XG4gICAgICAgIHJldHVybiBsaW5rVGV4dDtcbiAgICAgIH0pO1xuICAgICAgaWYgKGxpbmtUZXh0ID09PSAnJyB8fCAhZW1haWxCb2R5LmluY2x1ZGVzKGxpbmtUZXh0KSkge1xuICAgICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgICBcIkludmFsaWQgZW1haWwgc2V0dGluZ3MuIFByb3BlcnR5ICd2ZXJpZmljYXRpb25FbWFpbEJvZHknIG11c3QgdXRpbGl6ZSB0aGUgJ2xpbmsnIHBhcmFtZXRlciBhdCBsZWFzdCBvbmNlIGFzIGEgcGxhY2Vob2xkZXIgZm9yIHRoZSB2ZXJpZmljYXRpb24gbGluay5cIlxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZW1haWxCb2R5O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBlbWFpbCB2ZXJpZmljYXRpb24gc3R5bGUgZnJvbSB1c2VyIHByb3BzXG4gICAqIEBwYXJhbSB2ZXJpZmljYXRpb25FbWFpbFN0eWxlIC0gc3RyaW5nIHZhbHVlXG4gICAqIEByZXR1cm5zIHZlcmlmaWNhdGlvbkVtYWlsU3R5bGUgLSBlbnVtIHZhbHVlXG4gICAqL1xuICBwcml2YXRlIGdldEVtYWlsVmVyaWZpY2F0aW9uU3R5bGUgPSAoXG4gICAgdmVyaWZpY2F0aW9uRW1haWxTdHlsZTogJ0NPREUnIHwgJ0xJTksnIHwgdW5kZWZpbmVkXG4gICk6IGNvZ25pdG8uVmVyaWZpY2F0aW9uRW1haWxTdHlsZSB8IHVuZGVmaW5lZCA9PiB7XG4gICAgaWYgKHZlcmlmaWNhdGlvbkVtYWlsU3R5bGUgPT09ICdDT0RFJykge1xuICAgICAgcmV0dXJuIGNvZ25pdG8uVmVyaWZpY2F0aW9uRW1haWxTdHlsZS5DT0RFO1xuICAgIH0gZWxzZSBpZiAodmVyaWZpY2F0aW9uRW1haWxTdHlsZSA9PT0gJ0xJTksnKSB7XG4gICAgICByZXR1cm4gY29nbml0by5WZXJpZmljYXRpb25FbWFpbFN0eWxlLkxJTks7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIERldGVybWluZSB0aGUgYWNjb3VudCByZWNvdmVyeSBvcHRpb24gYmFzZWQgb24gZW5hYmxlZCBsb2dpbiBtZXRob2RzLlxuICAgKiBAcGFyYW0gZW1haWxFbmFibGVkIC0gaXMgZW1haWwgZW5hYmxlZFxuICAgKiBAcGFyYW0gcGhvbmVFbmFibGVkIC0gaXMgcGhvbmUgZW5hYmxlZFxuICAgKiBAcGFyYW0gYWNjb3VudFJlY292ZXJ5TWV0aG9kQXNTdHJpbmcgLSB0aGUgdXNlciBwcm92aWRlZCBhY2NvdW50IHJlY292ZXJ5IHNldHRpbmdcbiAgICogQHJldHVybnMgYWNjb3VudCByZWNvdmVyeSBzZXR0aW5nIGVudW0gdmFsdWVcbiAgICovXG4gIHByaXZhdGUgZ2V0QWNjb3VudFJlY292ZXJ5U2V0dGluZyA9IChcbiAgICBlbWFpbEVuYWJsZWQ6IGJvb2xlYW4sXG4gICAgcGhvbmVFbmFibGVkOiBib29sZWFuLFxuICAgIGFjY291bnRSZWNvdmVyeU1ldGhvZEFzU3RyaW5nOiBBdXRoUHJvcHNbJ2FjY291bnRSZWNvdmVyeSddXG4gICk6IGNvZ25pdG8uQWNjb3VudFJlY292ZXJ5IHwgdW5kZWZpbmVkID0+IHtcbiAgICBjb25zdCBhY2NvdW50UmVjb3ZlcnkgPSB0aGlzLmNvbnZlcnRBY2NvdW50UmVjb3ZlcnlTdHJpbmdUb0VudW0oXG4gICAgICBhY2NvdW50UmVjb3ZlcnlNZXRob2RBc1N0cmluZ1xuICAgICk7XG4gICAgaWYgKGFjY291bnRSZWNvdmVyeSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gYWNjb3VudFJlY292ZXJ5O1xuICAgIH1cbiAgICAvLyBzZXQgZGVmYXVsdCBiYXNlZCBvbiBlbmFibGVkIGxvZ2luIG1ldGhvZHNcbiAgICBpZiAocGhvbmVFbmFibGVkICYmIGVtYWlsRW5hYmxlZCkge1xuICAgICAgcmV0dXJuIGNvZ25pdG8uQWNjb3VudFJlY292ZXJ5LkVNQUlMX09OTFk7XG4gICAgfVxuICAgIGlmIChwaG9uZUVuYWJsZWQpIHtcbiAgICAgIHJldHVybiBjb2duaXRvLkFjY291bnRSZWNvdmVyeS5QSE9ORV9PTkxZX1dJVEhPVVRfTUZBO1xuICAgIH1cbiAgICBpZiAoZW1haWxFbmFibGVkKSB7XG4gICAgICByZXR1cm4gY29nbml0by5BY2NvdW50UmVjb3ZlcnkuRU1BSUxfT05MWTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfTtcblxuICAvKipcbiAgICogQ29udmVydCB1c2VyIGZyaWVuZGx5IE1mYSBtb2RlIHRvIGNvZ25pdG8gTWZhIE1vZGUuXG4gICAqIFRoaXMgZWxpbWluYXRlcyB0aGUgbmVlZCBmb3IgdXNlcnMgdG8gaW1wb3J0IGNvZ25pdG8uTWZhLlxuICAgKiBAcGFyYW0gbWZhIC0gTUZBIHNldHRpbmdzXG4gICAqIEByZXR1cm5zIGNvZ25pdG8gTUZBIGVuZm9yY2VtZW50IG1vZGVcbiAgICovXG4gIHByaXZhdGUgZ2V0TUZBTW9kZSA9IChtZmE6IEF1dGhQcm9wc1snbXVsdGlmYWN0b3InXSk6IE1mYSB8IHVuZGVmaW5lZCA9PiB7XG4gICAgaWYgKG1mYSkge1xuICAgICAgc3dpdGNoIChtZmEubW9kZSkge1xuICAgICAgICBjYXNlICdPRkYnOlxuICAgICAgICAgIHJldHVybiBNZmEuT0ZGO1xuICAgICAgICBjYXNlICdPUFRJT05BTCc6XG4gICAgICAgICAgcmV0dXJuIE1mYS5PUFRJT05BTDtcbiAgICAgICAgY2FzZSAnUkVRVUlSRUQnOlxuICAgICAgICAgIHJldHVybiBNZmEuUkVRVUlSRUQ7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIENvbnZlcnQgdXNlciBmcmllbmRseSBNZmEgdHlwZSB0byBjb2duaXRvIE1mYSB0eXBlLlxuICAgKiBUaGlzIGVsaW1pbmF0ZXMgdGhlIG5lZWQgZm9yIHVzZXJzIHRvIGltcG9ydCBjb2duaXRvLk1mYS5cbiAgICogQHBhcmFtIG1mYSAtIE1GQSBzZXR0aW5nc1xuICAgKiBAcmV0dXJucyBjb2duaXRvIE1GQSB0eXBlIChzbXMgb3IgdG90cClcbiAgICovXG4gIHByaXZhdGUgZ2V0TUZBVHlwZSA9IChcbiAgICBtZmE6IEF1dGhQcm9wc1snbXVsdGlmYWN0b3InXVxuICApOiBNZmFTZWNvbmRGYWN0b3IgfCB1bmRlZmluZWQgPT4ge1xuICAgIHJldHVybiB0eXBlb2YgbWZhID09PSAnb2JqZWN0JyAmJiBtZmEubW9kZSAhPT0gJ09GRidcbiAgICAgID8ge1xuICAgICAgICAgIHNtczogbWZhLnNtcyA/IHRydWUgOiBmYWxzZSxcbiAgICAgICAgICBvdHA6IG1mYS50b3RwID8gdHJ1ZSA6IGZhbHNlLFxuICAgICAgICB9XG4gICAgICA6IHVuZGVmaW5lZDtcbiAgfTtcblxuICAvKipcbiAgICogQ29udmVydCB1c2VyIGZyaWVuZGx5IGFjY291bnQgcmVjb3ZlcnkgbWV0aG9kIHRvIGNvZ25pdG8gQWNjb3VudFJlY292ZXIgZW51bS5cbiAgICogVGhpcyBlbGltaW5hdGVzIHRoZSBuZWVkIGZvciB1c2VycyB0byBpbXBvcnQgY29nbml0by5BY2NvdW50UmVjb3ZlcnkuXG4gICAqIEBwYXJhbSBtZXRob2QgLSBhY2NvdW50IHJlY292ZXJ5IG1ldGhvZCBhcyBhIHN0cmluZyB2YWx1ZVxuICAgKiBAcmV0dXJucyBjb2duaXRvLkFjY291bnRSZWNvdmVyeSBlbnVtIHZhbHVlXG4gICAqL1xuICBwcml2YXRlIGNvbnZlcnRBY2NvdW50UmVjb3ZlcnlTdHJpbmdUb0VudW0gPSAoXG4gICAgbWV0aG9kOiBBdXRoUHJvcHNbJ2FjY291bnRSZWNvdmVyeSddXG4gICk6IGNvZ25pdG8uQWNjb3VudFJlY292ZXJ5IHwgdW5kZWZpbmVkID0+IHtcbiAgICBpZiAobWV0aG9kICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBjb2duaXRvLkFjY291bnRSZWNvdmVyeVttZXRob2RdO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9O1xuXG4gIC8qKlxuICAgKiBFeHRyYWN0IHRoZSBNRkEgbWVzc2FnZSBzZXR0aW5ncyBhbmQgcGVyZm9ybSB2YWxpZGF0aW9uLlxuICAgKiBAcGFyYW0gbWZhIC0gTUZBIHNldHRpbmdzXG4gICAqIEByZXR1cm5zIG1mYSBtZXNzYWdlXG4gICAqL1xuICBwcml2YXRlIGdldE1GQU1lc3NhZ2UgPSAoXG4gICAgbWZhOiBBdXRoUHJvcHNbJ211bHRpZmFjdG9yJ11cbiAgKTogc3RyaW5nIHwgdW5kZWZpbmVkID0+IHtcbiAgICBpZiAobWZhICYmIG1mYS5tb2RlICE9PSAnT0ZGJyAmJiB0eXBlb2YgbWZhLnNtcyA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBtZmEuc21zLnNtc01lc3NhZ2UoKCkgPT4gTUZBX1NNU19QTEFDRUhPTERFUlMuQ09ERSk7XG4gICAgICBpZiAoIW1lc3NhZ2UuaW5jbHVkZXMoTUZBX1NNU19QTEFDRUhPTERFUlMuQ09ERSkpIHtcbiAgICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgICAgXCJJbnZhbGlkIE1GQSBzZXR0aW5ncy4gUHJvcGVydHkgJ3Ntc01lc3NhZ2UnIG11c3QgdXRpbGl6ZSB0aGUgJ2NvZGUnIHBhcmFtZXRlciBhdCBsZWFzdCBvbmNlIGFzIGEgcGxhY2Vob2xkZXIgZm9yIHRoZSB2ZXJpZmljYXRpb24gY29kZS5cIlxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIG1lc3NhZ2U7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIFNldHVwIEV4dGVybmFsIFByb3ZpZGVycyAoT0F1dGgvT0lEQy9TQU1MKSBhbmQgcmVsYXRlZCBzZXR0aW5nc1xuICAgKiBzdWNoIGFzIE9BdXRoIHNldHRpbmdzIGFuZCBVc2VyIFBvb2wgRG9tYWluc1xuICAgKi9cbiAgcHJpdmF0ZSBzZXR1cEV4dGVybmFsUHJvdmlkZXJzID0gKFxuICAgIHVzZXJQb29sOiBVc2VyUG9vbCxcbiAgICBsb2dpbk9wdGlvbnM6IEF1dGhQcm9wc1snbG9naW5XaXRoJ11cbiAgKTogSWRlbnRpdHlQcm92aWRlclNldHVwUmVzdWx0ID0+IHtcbiAgICAvKipcbiAgICAgKiBJZiBlbWFpbCBpcyBlbmFibGVkLCBhbmQgaXMgdGhlIG9ubHkgcmVxdWlyZWQgYXR0cmlidXRlLCB3ZSBhcmUgYWJsZSB0b1xuICAgICAqIGF1dG9tYXRpY2FsbHkgbWFwIHRoZSBlbWFpbCBhdHRyaWJ1dGUgZnJvbSBleHRlcm5hbCBwcm92aWRlcnMsIGV4Y2x1ZGluZyBTQU1MLlxuICAgICAqL1xuICAgIGNvbnN0IHNob3VsZE1hcEVtYWlsQXR0cmlidXRlcyA9IGxvZ2luT3B0aW9ucy5lbWFpbCAmJiAhbG9naW5PcHRpb25zLnBob25lO1xuICAgIGNvbnN0IHJlc3VsdDogSWRlbnRpdHlQcm92aWRlclNldHVwUmVzdWx0ID0ge1xuICAgICAgb0F1dGhNYXBwaW5nczoge30sXG4gICAgICBvQXV0aFNldHRpbmdzOiB7XG4gICAgICAgIGZsb3dzOiBERUZBVUxUUy5PQVVUSF9GTE9XUyxcbiAgICAgIH0sXG4gICAgfTtcbiAgICAvLyBleHRlcm5hbCBwcm92aWRlcnNcbiAgICBjb25zdCBleHRlcm5hbCA9IGxvZ2luT3B0aW9ucy5leHRlcm5hbFByb3ZpZGVycztcbiAgICBpZiAoIWV4dGVybmFsKSB7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgICAvLyBtYWtlIHN1cmUgbG9nb3V0L2NhbGxiYWNrIHVybHMgYXJlIG5vdCBlbXB0eVxuICAgIGlmIChleHRlcm5hbC5sb2dvdXRVcmxzICYmIGV4dGVybmFsLmxvZ291dFVybHMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgJ1lvdSBtdXN0IGRlZmluZSBsb2dvdXRVcmxzIHdoZW4gY29uZmlndXJpbmcgZXh0ZXJuYWwgbG9naW4gcHJvdmlkZXJzLidcbiAgICAgICk7XG4gICAgfVxuICAgIGlmIChleHRlcm5hbC5jYWxsYmFja1VybHMgJiYgZXh0ZXJuYWwuY2FsbGJhY2tVcmxzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgICdZb3UgbXVzdCBkZWZpbmUgY2FsbGJhY2tVcmxzIHdoZW4gY29uZmlndXJpbmcgZXh0ZXJuYWwgbG9naW4gcHJvdmlkZXJzLidcbiAgICAgICk7XG4gICAgfVxuICAgIGlmIChleHRlcm5hbC5nb29nbGUpIHtcbiAgICAgIGNvbnN0IGdvb2dsZVByb3BzID0gZXh0ZXJuYWwuZ29vZ2xlO1xuICAgICAgcmVzdWx0Lmdvb2dsZSA9IG5ldyBjb2duaXRvLlVzZXJQb29sSWRlbnRpdHlQcm92aWRlckdvb2dsZShcbiAgICAgICAgdGhpcyxcbiAgICAgICAgYCR7dGhpcy5uYW1lfUdvb2dsZUlkUGAsXG4gICAgICAgIHtcbiAgICAgICAgICB1c2VyUG9vbCxcbiAgICAgICAgICBjbGllbnRJZDogZ29vZ2xlUHJvcHMuY2xpZW50SWQsXG4gICAgICAgICAgY2xpZW50U2VjcmV0VmFsdWU6IGdvb2dsZVByb3BzLmNsaWVudFNlY3JldCxcbiAgICAgICAgICBhdHRyaWJ1dGVNYXBwaW5nOiB7XG4gICAgICAgICAgICAuLi4oc2hvdWxkTWFwRW1haWxBdHRyaWJ1dGVzXG4gICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgZW1haWw6IFByb3ZpZGVyQXR0cmlidXRlLkdPT0dMRV9FTUFJTCxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIDogdW5kZWZpbmVkKSxcbiAgICAgICAgICAgIC4uLnRoaXMuY29udmVydFRvQ29nbml0b0F0dHJpYnV0ZU1hcHBpbmcoXG4gICAgICAgICAgICAgIGdvb2dsZVByb3BzLmF0dHJpYnV0ZU1hcHBpbmdcbiAgICAgICAgICAgICksXG4gICAgICAgICAgfSxcbiAgICAgICAgICBzY29wZXM6IGdvb2dsZVByb3BzLnNjb3BlcyxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIHJlc3VsdC5vQXV0aE1hcHBpbmdzW29hdXRoUHJvdmlkZXJUb1Byb3ZpZGVyRG9tYWluTWFwLmdvb2dsZV0gPVxuICAgICAgICBleHRlcm5hbC5nb29nbGUuY2xpZW50SWQ7XG4gICAgfVxuICAgIGlmIChleHRlcm5hbC5mYWNlYm9vaykge1xuICAgICAgcmVzdWx0LmZhY2Vib29rID0gbmV3IGNvZ25pdG8uVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyRmFjZWJvb2soXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3RoaXMubmFtZX1GYWNlYm9va0lEUGAsXG4gICAgICAgIHtcbiAgICAgICAgICB1c2VyUG9vbCxcbiAgICAgICAgICAuLi5leHRlcm5hbC5mYWNlYm9vayxcbiAgICAgICAgICBhdHRyaWJ1dGVNYXBwaW5nOiB7XG4gICAgICAgICAgICAuLi4oc2hvdWxkTWFwRW1haWxBdHRyaWJ1dGVzXG4gICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgZW1haWw6IFByb3ZpZGVyQXR0cmlidXRlLkZBQ0VCT09LX0VNQUlMLFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgOiB1bmRlZmluZWQpLFxuICAgICAgICAgICAgLi4udGhpcy5jb252ZXJ0VG9Db2duaXRvQXR0cmlidXRlTWFwcGluZyhcbiAgICAgICAgICAgICAgZXh0ZXJuYWwuZmFjZWJvb2suYXR0cmlidXRlTWFwcGluZ1xuICAgICAgICAgICAgKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9XG4gICAgICApO1xuICAgICAgcmVzdWx0Lm9BdXRoTWFwcGluZ3Nbb2F1dGhQcm92aWRlclRvUHJvdmlkZXJEb21haW5NYXAuZmFjZWJvb2tdID1cbiAgICAgICAgZXh0ZXJuYWwuZmFjZWJvb2suY2xpZW50SWQ7XG4gICAgfVxuICAgIGlmIChleHRlcm5hbC5sb2dpbldpdGhBbWF6b24pIHtcbiAgICAgIHJlc3VsdC5hbWF6b24gPSBuZXcgY29nbml0by5Vc2VyUG9vbElkZW50aXR5UHJvdmlkZXJBbWF6b24oXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3RoaXMubmFtZX1BbWF6b25JRFBgLFxuICAgICAgICB7XG4gICAgICAgICAgdXNlclBvb2wsXG4gICAgICAgICAgLi4uZXh0ZXJuYWwubG9naW5XaXRoQW1hem9uLFxuICAgICAgICAgIGF0dHJpYnV0ZU1hcHBpbmc6IHtcbiAgICAgICAgICAgIC4uLihzaG91bGRNYXBFbWFpbEF0dHJpYnV0ZXNcbiAgICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICBlbWFpbDogUHJvdmlkZXJBdHRyaWJ1dGUuQU1BWk9OX0VNQUlMLFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgOiB1bmRlZmluZWQpLFxuICAgICAgICAgICAgLi4udGhpcy5jb252ZXJ0VG9Db2duaXRvQXR0cmlidXRlTWFwcGluZyhcbiAgICAgICAgICAgICAgZXh0ZXJuYWwubG9naW5XaXRoQW1hem9uLmF0dHJpYnV0ZU1hcHBpbmdcbiAgICAgICAgICAgICksXG4gICAgICAgICAgfSxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIHJlc3VsdC5vQXV0aE1hcHBpbmdzW29hdXRoUHJvdmlkZXJUb1Byb3ZpZGVyRG9tYWluTWFwLmFtYXpvbl0gPVxuICAgICAgICBleHRlcm5hbC5sb2dpbldpdGhBbWF6b24uY2xpZW50SWQ7XG4gICAgfVxuICAgIGlmIChleHRlcm5hbC5zaWduSW5XaXRoQXBwbGUpIHtcbiAgICAgIHJlc3VsdC5hcHBsZSA9IG5ldyBjb2duaXRvLlVzZXJQb29sSWRlbnRpdHlQcm92aWRlckFwcGxlKFxuICAgICAgICB0aGlzLFxuICAgICAgICBgJHt0aGlzLm5hbWV9QXBwbGVJRFBgLFxuICAgICAgICB7XG4gICAgICAgICAgdXNlclBvb2wsXG4gICAgICAgICAgLi4uZXh0ZXJuYWwuc2lnbkluV2l0aEFwcGxlLFxuICAgICAgICAgIGF0dHJpYnV0ZU1hcHBpbmc6IHtcbiAgICAgICAgICAgIC4uLihzaG91bGRNYXBFbWFpbEF0dHJpYnV0ZXNcbiAgICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICBlbWFpbDogUHJvdmlkZXJBdHRyaWJ1dGUuQVBQTEVfRU1BSUwsXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICA6IHVuZGVmaW5lZCksXG4gICAgICAgICAgICAuLi50aGlzLmNvbnZlcnRUb0NvZ25pdG9BdHRyaWJ1dGVNYXBwaW5nKFxuICAgICAgICAgICAgICBleHRlcm5hbC5zaWduSW5XaXRoQXBwbGUuYXR0cmlidXRlTWFwcGluZ1xuICAgICAgICAgICAgKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9XG4gICAgICApO1xuICAgICAgcmVzdWx0Lm9BdXRoTWFwcGluZ3Nbb2F1dGhQcm92aWRlclRvUHJvdmlkZXJEb21haW5NYXAuYXBwbGVdID1cbiAgICAgICAgZXh0ZXJuYWwuc2lnbkluV2l0aEFwcGxlLmNsaWVudElkO1xuICAgIH1cbiAgICBpZiAoZXh0ZXJuYWwub2lkYyAmJiBleHRlcm5hbC5vaWRjLmxlbmd0aCA+IDApIHtcbiAgICAgIHJlc3VsdC5vaWRjID0gW107XG4gICAgICBleHRlcm5hbC5vaWRjLmZvckVhY2goKHByb3ZpZGVyLCBpbmRleCkgPT4ge1xuICAgICAgICBjb25zdCByZXF1ZXN0TWV0aG9kID1cbiAgICAgICAgICBwcm92aWRlci5hdHRyaWJ1dGVSZXF1ZXN0TWV0aG9kID09PSB1bmRlZmluZWRcbiAgICAgICAgICAgID8gJ0dFVCcgLy8gZGVmYXVsdCBpZiBub3QgZGVmaW5lZFxuICAgICAgICAgICAgOiBwcm92aWRlci5hdHRyaWJ1dGVSZXF1ZXN0TWV0aG9kO1xuICAgICAgICBjb25zdCBnZW5lcmF0ZWRQcm92aWRlciA9IG5ldyBjb2duaXRvLlVzZXJQb29sSWRlbnRpdHlQcm92aWRlck9pZGMoXG4gICAgICAgICAgdGhpcyxcbiAgICAgICAgICBgJHt0aGlzLm5hbWV9JHtwcm92aWRlci5uYW1lID8/IGluZGV4fU9pZGNJRFBgLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHVzZXJQb29sLFxuICAgICAgICAgICAgYXR0cmlidXRlUmVxdWVzdE1ldGhvZDpcbiAgICAgICAgICAgICAgcmVxdWVzdE1ldGhvZCA9PT0gJ0dFVCdcbiAgICAgICAgICAgICAgICA/IE9pZGNBdHRyaWJ1dGVSZXF1ZXN0TWV0aG9kLkdFVFxuICAgICAgICAgICAgICAgIDogT2lkY0F0dHJpYnV0ZVJlcXVlc3RNZXRob2QuUE9TVCxcbiAgICAgICAgICAgIGNsaWVudElkOiBwcm92aWRlci5jbGllbnRJZCxcbiAgICAgICAgICAgIGNsaWVudFNlY3JldDogcHJvdmlkZXIuY2xpZW50U2VjcmV0LFxuICAgICAgICAgICAgZW5kcG9pbnRzOiBwcm92aWRlci5lbmRwb2ludHMsXG4gICAgICAgICAgICBpZGVudGlmaWVyczogcHJvdmlkZXIuaWRlbnRpZmllcnMsXG4gICAgICAgICAgICBpc3N1ZXJVcmw6IHByb3ZpZGVyLmlzc3VlclVybCxcbiAgICAgICAgICAgIG5hbWU6IHByb3ZpZGVyLm5hbWUsXG4gICAgICAgICAgICBzY29wZXM6IHByb3ZpZGVyLnNjb3BlcyxcbiAgICAgICAgICAgIGF0dHJpYnV0ZU1hcHBpbmc6IHtcbiAgICAgICAgICAgICAgLi4uKHNob3VsZE1hcEVtYWlsQXR0cmlidXRlc1xuICAgICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgICBlbWFpbDoge1xuICAgICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWU6ICdlbWFpbCcsXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgOiB1bmRlZmluZWQpLFxuICAgICAgICAgICAgICAuLi50aGlzLmNvbnZlcnRUb0NvZ25pdG9BdHRyaWJ1dGVNYXBwaW5nKFxuICAgICAgICAgICAgICAgIHByb3ZpZGVyLmF0dHJpYnV0ZU1hcHBpbmdcbiAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgICByZXN1bHQub2lkYz8ucHVzaChnZW5lcmF0ZWRQcm92aWRlcik7XG4gICAgICB9KTtcbiAgICB9XG4gICAgaWYgKGV4dGVybmFsLnNhbWwpIHtcbiAgICAgIGNvbnN0IHNhbWwgPSBleHRlcm5hbC5zYW1sO1xuICAgICAgcmVzdWx0LnNhbWwgPSBuZXcgY29nbml0by5Vc2VyUG9vbElkZW50aXR5UHJvdmlkZXJTYW1sKFxuICAgICAgICB0aGlzLFxuICAgICAgICBgJHt0aGlzLm5hbWV9U2FtbElEUGAsXG4gICAgICAgIHtcbiAgICAgICAgICB1c2VyUG9vbCxcbiAgICAgICAgICBhdHRyaWJ1dGVNYXBwaW5nOiB0aGlzLmNvbnZlcnRUb0NvZ25pdG9BdHRyaWJ1dGVNYXBwaW5nKFxuICAgICAgICAgICAgc2FtbC5hdHRyaWJ1dGVNYXBwaW5nXG4gICAgICAgICAgKSxcbiAgICAgICAgICBpZGVudGlmaWVyczogc2FtbC5pZGVudGlmaWVycyxcbiAgICAgICAgICBpZHBTaWdub3V0OiBzYW1sLmlkcFNpZ25vdXQsXG4gICAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICAgIG1ldGFkYXRhQ29udGVudDogc2FtbC5tZXRhZGF0YS5tZXRhZGF0YUNvbnRlbnQsXG4gICAgICAgICAgICBtZXRhZGF0YVR5cGU6XG4gICAgICAgICAgICAgIHNhbWwubWV0YWRhdGEubWV0YWRhdGFUeXBlID09PSAnRklMRSdcbiAgICAgICAgICAgICAgICA/IFVzZXJQb29sSWRlbnRpdHlQcm92aWRlclNhbWxNZXRhZGF0YVR5cGUuRklMRVxuICAgICAgICAgICAgICAgIDogVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyU2FtbE1ldGFkYXRhVHlwZS5VUkwsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBuYW1lOiBzYW1sLm5hbWUsXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQWx3YXlzIGdlbmVyYXRlIGEgZG9tYWluIHByZWZpeCBpZiBleHRlcm5hbCBwcm92aWRlciBpcyBjb25maWd1cmVkXG4gICAgaWYgKHRoaXMuZG9tYWluUHJlZml4KSB7XG4gICAgICB0aGlzLnVzZXJQb29sLmFkZERvbWFpbihgJHt0aGlzLm5hbWV9VXNlclBvb2xEb21haW5gLCB7XG4gICAgICAgIGNvZ25pdG9Eb21haW46IHsgZG9tYWluUHJlZml4OiB0aGlzLmRvbWFpblByZWZpeCB9LFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0NvZ25pdG8gRG9tYWluIFByZWZpeCBpcyBtaXNzaW5nIHdoZW4gZXh0ZXJuYWwgcHJvdmlkZXJzIGFyZSBjb25maWd1cmVkLidcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gb2F1dGggc2V0dGluZ3MgZm9yIHRoZSBVc2VyUG9vbCBjbGllbnRcbiAgICByZXN1bHQub0F1dGhTZXR0aW5ncyA9IHtcbiAgICAgIGNhbGxiYWNrVXJsczogZXh0ZXJuYWwuY2FsbGJhY2tVcmxzLFxuICAgICAgbG9nb3V0VXJsczogZXh0ZXJuYWwubG9nb3V0VXJscyxcbiAgICAgIHNjb3BlczogZXh0ZXJuYWwuc2NvcGVzXG4gICAgICAgID8gdGhpcy5nZXRPQXV0aFNjb3BlcyhleHRlcm5hbC5zY29wZXMpXG4gICAgICAgIDogREVGQVVMVF9PQVVUSF9TQ09QRVMsXG4gICAgICBmbG93czogREVGQVVMVFMuT0FVVEhfRkxPV1MsXG4gICAgfTtcblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIENvbnZlcnRzIHRoZSBzaW1wbGlmaWVkIG1hcHBpbmcgdHlwZSB0byBjb2duaXRvLkF0dHJpYnV0ZU1hcHBpbmcuXG4gICAqIEBwYXJhbSBtYXBwaW5nIHRoZSBBdHRyaWJ1dGVNYXBwaW5nIHRvIGNvbnZlcnQgdG8gYSBjb2duaXRvLkF0dHJpYnV0ZU1hcHBpbmdcbiAgICogQHJldHVybnMgY29nbml0by5BdHRyaWJ1dGVNYXBwaW5nXG4gICAqL1xuICBwcml2YXRlIGNvbnZlcnRUb0NvZ25pdG9BdHRyaWJ1dGVNYXBwaW5nID0gKFxuICAgIG1hcHBpbmc/OiBBdHRyaWJ1dGVNYXBwaW5nXG4gICk6IGNvZ25pdG8uQXR0cmlidXRlTWFwcGluZyB8IHVuZGVmaW5lZCA9PiB7XG4gICAgaWYgKCFtYXBwaW5nKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQ6IFJlY29yZDxcbiAgICAgIHN0cmluZyxcbiAgICAgIHwgUHJvdmlkZXJBdHRyaWJ1dGVcbiAgICAgIHwge1xuICAgICAgICAgIFtrZXk6IHN0cmluZ106IFByb3ZpZGVyQXR0cmlidXRlO1xuICAgICAgICB9XG4gICAgPiA9IHt9O1xuICAgIGZvciAoY29uc3QgW2F0dHJOYW1lLCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMobWFwcGluZykpIHtcbiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHJlc3VsdFthdHRyTmFtZV0gPSB7XG4gICAgICAgICAgYXR0cmlidXRlTmFtZTogdmFsdWUsXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiBhdHRyTmFtZSA9PT0gJ2N1c3RvbScpIHtcbiAgICAgICAgLy8gZGVhbGluZyB3aXRoIGN1c3RvbSBhdHRyaWJ1dGVzXG4gICAgICAgIGNvbnN0IGN1c3RvbUF0dHJpYnV0ZXM6IFJlY29yZDxzdHJpbmcsIFByb3ZpZGVyQXR0cmlidXRlPiA9IHt9O1xuICAgICAgICBmb3IgKGNvbnN0IFtjdXN0b21LZXksIGF0dHJOYW1lXSBvZiBPYmplY3QuZW50cmllcyh2YWx1ZSkpIHtcbiAgICAgICAgICBjdXN0b21BdHRyaWJ1dGVzW2N1c3RvbUtleV0gPSB7XG4gICAgICAgICAgICBhdHRyaWJ1dGVOYW1lOiBhdHRyTmFtZSxcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIHJlc3VsdFthdHRyTmFtZV0gPSBjdXN0b21BdHRyaWJ1dGVzO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xuICAvKipcbiAgICogQ29udmVydCBzY29wZXMgZnJvbSBzdHJpbmcgbGlzdCB0byBPQXV0aFNjb3Blcy5cbiAgICogQHBhcmFtIHNjb3BlcyAtIHNjb3BlIGxpc3RcbiAgICogQHJldHVybnMgY29nbml0byBPQXV0aFNjb3Blc1xuICAgKi9cbiAgcHJpdmF0ZSBnZXRPQXV0aFNjb3BlcyA9IChcbiAgICBzY29wZXM6IEV4dGVybmFsUHJvdmlkZXJPcHRpb25zWydzY29wZXMnXVxuICApOiBjb2duaXRvLk9BdXRoU2NvcGVbXSA9PiB7XG4gICAgaWYgKHNjb3BlcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdDogY29nbml0by5PQXV0aFNjb3BlW10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IHNjb3BlIG9mIHNjb3Blcykge1xuICAgICAgcmVzdWx0LnB1c2goY29nbml0by5PQXV0aFNjb3BlW3Njb3BlXSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIFN0b3JlcyBhdXRoIG91dHB1dCB1c2luZyB0aGUgcHJvdmlkZWQgc3RyYXRlZ3lcbiAgICovXG4gIHByaXZhdGUgc3RvcmVPdXRwdXQgPSAoXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PEF1dGhPdXRwdXQ+ID0gbmV3IFN0YWNrTWV0YWRhdGFCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5KFxuICAgICAgU3RhY2sub2YodGhpcylcbiAgICApXG4gICk6IHZvaWQgPT4ge1xuICAgIGNvbnN0IGNmblVzZXJQb29sID0gdGhpcy5yZXNvdXJjZXMuY2ZuUmVzb3VyY2VzLmNmblVzZXJQb29sO1xuICAgIGNvbnN0IGNmblVzZXJQb29sQ2xpZW50ID0gdGhpcy5yZXNvdXJjZXMuY2ZuUmVzb3VyY2VzLmNmblVzZXJQb29sQ2xpZW50O1xuICAgIGNvbnN0IGNmbklkZW50aXR5UG9vbCA9IHRoaXMucmVzb3VyY2VzLmNmblJlc291cmNlcy5jZm5JZGVudGl0eVBvb2w7XG4gICAgLy8gdGhlc2UgcHJvcGVydGllcyBjYW5ub3QgYmUgb3ZlcndyaXR0ZW5cbiAgICBjb25zdCBvdXRwdXQ6IEF1dGhPdXRwdXRbJ3BheWxvYWQnXSA9IHtcbiAgICAgIHVzZXJQb29sSWQ6IHRoaXMucmVzb3VyY2VzLnVzZXJQb29sLnVzZXJQb29sSWQsXG4gICAgICB3ZWJDbGllbnRJZDogdGhpcy5yZXNvdXJjZXMudXNlclBvb2xDbGllbnQudXNlclBvb2xDbGllbnRJZCxcbiAgICAgIGlkZW50aXR5UG9vbElkOiBjZm5JZGVudGl0eVBvb2wucmVmLFxuICAgICAgYXV0aFJlZ2lvbjogU3RhY2sub2YodGhpcykucmVnaW9uLFxuICAgIH07XG5cbiAgICAvLyB0aGUgcHJvcGVydGllcyBiZWxvdyB0aGlzIGxpbmUgY2FuIGJlIG92ZXJ3cml0dGVuLCBzbyB0aGV5IGFyZSBleHBvc2VkIHZpYSBjZGsgTEFaWVxuICAgIG91dHB1dC5hbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMgPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PlxuICAgICAgICBjZm5JZGVudGl0eVBvb2wuYWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzID09PSB0cnVlXG4gICAgICAgICAgPyAndHJ1ZSdcbiAgICAgICAgICA6ICdmYWxzZScsXG4gICAgfSk7XG5cbiAgICAvLyBleHRyYWN0IHNpZ251cEF0dHJpYnV0ZXMgZnJvbSBVc2VyUG9vbCBzY2hlbWEncyByZXF1aXJlZCBhdHRyaWJ1dGVzXG4gICAgb3V0cHV0LnNpZ251cEF0dHJpYnV0ZXMgPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIGlmICghY2ZuVXNlclBvb2wuc2NoZW1hKSB7XG4gICAgICAgICAgcmV0dXJuICdbXSc7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KFxuICAgICAgICAgIChjZm5Vc2VyUG9vbC5zY2hlbWEgYXMgQ2ZuVXNlclBvb2wuU2NoZW1hQXR0cmlidXRlUHJvcGVydHlbXSlcbiAgICAgICAgICAgIC5maWx0ZXIoKGF0dHJpYnV0ZSkgPT4gYXR0cmlidXRlLnJlcXVpcmVkICYmIGF0dHJpYnV0ZS5uYW1lKVxuICAgICAgICAgICAgLm1hcCgoYXR0cmlidXRlKSA9PiBhdHRyaWJ1dGUubmFtZT8udG9Mb3dlckNhc2UoKSlcbiAgICAgICAgKTtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBleHRyYWN0IHVzZXJuYW1lQXR0cmlidXRlcyBmcm9tIFVzZXJQb29sJ3MgdXNlcm5hbWVBdHRyaWJ1dGVzXG4gICAgb3V0cHV0LnVzZXJuYW1lQXR0cmlidXRlcyA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+IHtcbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KFxuICAgICAgICAgIGNmblVzZXJQb29sLnVzZXJuYW1lQXR0cmlidXRlcz8ubWFwKChhdHRyKSA9PiBhdHRyLnRvTG93ZXJDYXNlKCkpIHx8XG4gICAgICAgICAgICBbXVxuICAgICAgICApO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIGV4dHJhY3QgdmVyaWZpY2F0aW9uTWVjaGFuaXNtcyBmcm9tIFVzZXJQb29sJ3MgYXV0b1ZlcmlmaWVkQXR0cmlidXRlc1xuICAgIG91dHB1dC52ZXJpZmljYXRpb25NZWNoYW5pc21zID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoY2ZuVXNlclBvb2wuYXV0b1ZlcmlmaWVkQXR0cmlidXRlcyA/PyBbXSk7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gZXh0cmFjdCB0aGUgcGFzc3dvcmRQb2xpY3kgZnJvbSB0aGUgVXNlclBvb2wgcG9saWNpZXNcbiAgICBvdXRwdXQucGFzc3dvcmRQb2xpY3lNaW5MZW5ndGggPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIGlmICghY2ZuVXNlclBvb2wucG9saWNpZXMpIHtcbiAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcG9saWN5ID0gKGNmblVzZXJQb29sLnBvbGljaWVzIGFzIENmblVzZXJQb29sLlBvbGljaWVzUHJvcGVydHkpXG4gICAgICAgICAgLnBhc3N3b3JkUG9saWN5IGFzIENmblVzZXJQb29sLlBhc3N3b3JkUG9saWN5UHJvcGVydHk7XG4gICAgICAgIHJldHVybiBwb2xpY3kubWluaW11bUxlbmd0aD8udG9TdHJpbmcoKTtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBvdXRwdXQucGFzc3dvcmRQb2xpY3lSZXF1aXJlbWVudHMgPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIGlmICghY2ZuVXNlclBvb2wucG9saWNpZXMpIHtcbiAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcG9saWN5ID0gKGNmblVzZXJQb29sLnBvbGljaWVzIGFzIENmblVzZXJQb29sLlBvbGljaWVzUHJvcGVydHkpXG4gICAgICAgICAgLnBhc3N3b3JkUG9saWN5IGFzIENmblVzZXJQb29sLlBhc3N3b3JkUG9saWN5UHJvcGVydHk7XG4gICAgICAgIGNvbnN0IHJlcXVpcmVtZW50cyA9IFtdO1xuICAgICAgICBwb2xpY3kucmVxdWlyZU51bWJlcnMgJiYgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX05VTUJFUlMnKTtcbiAgICAgICAgcG9saWN5LnJlcXVpcmVMb3dlcmNhc2UgJiYgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX0xPV0VSQ0FTRScpO1xuICAgICAgICBwb2xpY3kucmVxdWlyZVVwcGVyY2FzZSAmJiByZXF1aXJlbWVudHMucHVzaCgnUkVRVUlSRVNfVVBQRVJDQVNFJyk7XG4gICAgICAgIHBvbGljeS5yZXF1aXJlU3ltYm9scyAmJiByZXF1aXJlbWVudHMucHVzaCgnUkVRVUlSRVNfU1lNQk9MUycpO1xuICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkocmVxdWlyZW1lbnRzKTtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBleHRyYWN0IHRoZSBNRkEgY29uZmlndXJhdGlvbiBzZXR0aW5nIGZyb20gdGhlIFVzZXJQb29sIHJlc291cmNlXG4gICAgb3V0cHV0Lm1mYUNvbmZpZ3VyYXRpb24gPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIHJldHVybiBjZm5Vc2VyUG9vbC5tZmFDb25maWd1cmF0aW9uID8/ICdPRkYnO1xuICAgICAgfSxcbiAgICB9KTtcbiAgICAvLyBleHRyYWN0IHRoZSBNRkEgdHlwZXMgZnJvbSB0aGUgVXNlclBvb2wgcmVzb3VyY2VcbiAgICBvdXRwdXQubWZhVHlwZXMgPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIGNvbnN0IG1mYVR5cGVzOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICAoY2ZuVXNlclBvb2wuZW5hYmxlZE1mYXMgPz8gW10pLmZvckVhY2goKHR5cGUpID0+IHtcbiAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NNU19NRkEnKSB7XG4gICAgICAgICAgICBtZmFUeXBlcy5wdXNoKCdTTVMnKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHR5cGUgPT09ICdTT0ZUV0FSRV9UT0tFTl9NRkEnKSB7XG4gICAgICAgICAgICBtZmFUeXBlcy5wdXNoKCdUT1RQJyk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG1mYVR5cGVzKTtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBleHRyYWN0IHNvY2lhbCBwcm92aWRlcnMgZnJvbSBVc2VyUG9vbCByZXNvdXJjZVxuICAgIG91dHB1dC5zb2NpYWxQcm92aWRlcnMgPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIGNvbnN0IG91dHB1dFByb3ZpZGVyczogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgY29uc3QgdXNlclBvb2xQcm92aWRlcnMgPSB0aGlzLnJlc291cmNlcy51c2VyUG9vbC5pZGVudGl0eVByb3ZpZGVycztcbiAgICAgICAgaWYgKCF1c2VyUG9vbFByb3ZpZGVycyB8fCB1c2VyUG9vbFByb3ZpZGVycy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChjb25zdCBwcm92aWRlciBvZiB1c2VyUG9vbFByb3ZpZGVycykge1xuICAgICAgICAgIGNvbnN0IHByb3ZpZGVyUmVzb3VyY2UgPSBwcm92aWRlci5ub2RlLmZpbmRDaGlsZChcbiAgICAgICAgICAgICdSZXNvdXJjZSdcbiAgICAgICAgICApIGFzIENmblVzZXJQb29sSWRlbnRpdHlQcm92aWRlcjtcbiAgICAgICAgICBpZiAoIShwcm92aWRlclJlc291cmNlIGluc3RhbmNlb2YgQ2ZuVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyKSkge1xuICAgICAgICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgICAgICAgICdDb3VsZCBub3QgZmluZCB0aGUgQ2ZuVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyIHJlc291cmNlIGluIHRoZSBzdGFjay4nXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCBwcm92aWRlclR5cGUgPSBwcm92aWRlclJlc291cmNlLnByb3ZpZGVyVHlwZTtcbiAgICAgICAgICBjb25zdCBwcm92aWRlck5hbWUgPSBwcm92aWRlclJlc291cmNlLnByb3ZpZGVyTmFtZTtcbiAgICAgICAgICBpZiAocHJvdmlkZXJUeXBlID09PSAnR29vZ2xlJykge1xuICAgICAgICAgICAgb3V0cHV0UHJvdmlkZXJzLnB1c2goJ0dPT0dMRScpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocHJvdmlkZXJUeXBlID09PSAnRmFjZWJvb2snKSB7XG4gICAgICAgICAgICBvdXRwdXRQcm92aWRlcnMucHVzaCgnRkFDRUJPT0snKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHByb3ZpZGVyVHlwZSA9PT0gJ1NpZ25JbldpdGhBcHBsZScpIHtcbiAgICAgICAgICAgIG91dHB1dFByb3ZpZGVycy5wdXNoKCdTSUdOX0lOX1dJVEhfQVBQTEUnKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHByb3ZpZGVyVHlwZSA9PT0gJ0xvZ2luV2l0aEFtYXpvbicpIHtcbiAgICAgICAgICAgIG91dHB1dFByb3ZpZGVycy5wdXNoKCdMT0dJTl9XSVRIX0FNQVpPTicpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocHJvdmlkZXJUeXBlID09PSAnT0lEQycpIHtcbiAgICAgICAgICAgIG91dHB1dFByb3ZpZGVycy5wdXNoKHByb3ZpZGVyTmFtZSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChwcm92aWRlclR5cGUgPT09ICdTQU1MJykge1xuICAgICAgICAgICAgb3V0cHV0UHJvdmlkZXJzLnB1c2gocHJvdmlkZXJOYW1lKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG91dHB1dFByb3ZpZGVycyk7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgb3V0cHV0Lm9hdXRoQ29nbml0b0RvbWFpbiA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+IHtcbiAgICAgICAgY29uc3QgdXNlclBvb2xEb21haW4gPVxuICAgICAgICAgIHRoaXMucmVzb3VyY2VzLnVzZXJQb29sLm5vZGUudHJ5RmluZENoaWxkKCdVc2VyUG9vbERvbWFpbicpO1xuICAgICAgICBpZiAoIXVzZXJQb29sRG9tYWluKSB7XG4gICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgICAgIGlmICghKHVzZXJQb29sRG9tYWluIGluc3RhbmNlb2YgVXNlclBvb2xEb21haW4pKSB7XG4gICAgICAgICAgdGhyb3cgRXJyb3IoJ0NvdWxkIG5vdCBmaW5kIFVzZXJQb29sRG9tYWluIHJlc291cmNlIGluIHRoZSBzdGFjay4nKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYCR7dXNlclBvb2xEb21haW4uZG9tYWluTmFtZX0uYXV0aC4ke1xuICAgICAgICAgIFN0YWNrLm9mKHRoaXMpLnJlZ2lvblxuICAgICAgICB9LmFtYXpvbmNvZ25pdG8uY29tYDtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBvdXRwdXQub2F1dGhTY29wZSA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+IHtcbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGNmblVzZXJQb29sQ2xpZW50LmFsbG93ZWRPQXV0aFNjb3BlcyA/PyBbXSk7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgb3V0cHV0Lm9hdXRoUmVkaXJlY3RTaWduSW4gPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIHJldHVybiBjZm5Vc2VyUG9vbENsaWVudC5jYWxsYmFja1VyTHNcbiAgICAgICAgICA/IGNmblVzZXJQb29sQ2xpZW50LmNhbGxiYWNrVXJMcy5qb2luKCcsJylcbiAgICAgICAgICA6ICcnO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIG91dHB1dC5vYXV0aFJlZGlyZWN0U2lnbk91dCA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+IHtcbiAgICAgICAgcmV0dXJuIGNmblVzZXJQb29sQ2xpZW50LmxvZ291dFVyTHNcbiAgICAgICAgICA/IGNmblVzZXJQb29sQ2xpZW50LmxvZ291dFVyTHMuam9pbignLCcpXG4gICAgICAgICAgOiAnJztcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBvdXRwdXQub2F1dGhSZXNwb25zZVR5cGUgPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIHJldHVybiBjZm5Vc2VyUG9vbENsaWVudC5hbGxvd2VkT0F1dGhGbG93c1xuICAgICAgICAgID8gY2ZuVXNlclBvb2xDbGllbnQuYWxsb3dlZE9BdXRoRmxvd3Muam9pbignLCcpXG4gICAgICAgICAgOiAnJztcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBvdXRwdXQub2F1dGhDbGllbnRJZCA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+IHtcbiAgICAgICAgcmV0dXJuIGNmblVzZXJQb29sQ2xpZW50LnJlZjtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3kuYWRkQmFja2VuZE91dHB1dEVudHJ5KGF1dGhPdXRwdXRLZXksIHtcbiAgICAgIHZlcnNpb246ICcxJyxcbiAgICAgIHBheWxvYWQ6IG91dHB1dCxcbiAgICB9KTtcbiAgfTtcbn1cbiJdfQ==