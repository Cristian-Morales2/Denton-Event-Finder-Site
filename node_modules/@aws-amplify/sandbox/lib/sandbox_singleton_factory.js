import { PackageManagerControllerFactory, } from '@aws-amplify/cli-core';
import { FileWatchingSandbox } from './file_watching_sandbox.js';
import { BackendDeployerFactory } from '@aws-amplify/backend-deployer';
import { AmplifySandboxExecutor } from './sandbox_executor.js';
import { SSMClient } from '@aws-sdk/client-ssm';
import { getSecretClient } from '@aws-amplify/backend-secret';
/**
 * Factory to create a new sandbox
 */
export class SandboxSingletonFactory {
    sandboxIdResolver;
    printer;
    format;
    instance;
    /**
     * sandboxIdResolver allows sandbox to lazily load the sandbox backend id on demand
     */
    constructor(sandboxIdResolver, printer, format) {
        this.sandboxIdResolver = sandboxIdResolver;
        this.printer = printer;
        this.format = format;
    }
    /**
     * Returns a singleton instance of a Sandbox
     */
    getInstance = async () => {
        if (!this.instance) {
            const packageManagerControllerFactory = new PackageManagerControllerFactory(process.cwd(), this.printer);
            const backendDeployerFactory = new BackendDeployerFactory(packageManagerControllerFactory.getPackageManagerController(), this.format);
            this.instance = new FileWatchingSandbox(this.sandboxIdResolver, new AmplifySandboxExecutor(backendDeployerFactory.getInstance(), getSecretClient(), this.printer), new SSMClient(), this.printer);
        }
        return this.instance;
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2FuZGJveF9zaW5nbGV0b25fZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zYW5kYm94X3NpbmdsZXRvbl9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCwrQkFBK0IsR0FFaEMsTUFBTSx1QkFBdUIsQ0FBQztBQUMvQixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUVqRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUN2RSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDaEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBRTlEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLHVCQUF1QjtJQU1mO0lBQ0E7SUFDQTtJQVBYLFFBQVEsQ0FBc0I7SUFDdEM7O09BRUc7SUFDSCxZQUNtQixpQkFBMkMsRUFDM0MsT0FBZ0IsRUFDaEIsTUFBYztRQUZkLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBMEI7UUFDM0MsWUFBTyxHQUFQLE9BQU8sQ0FBUztRQUNoQixXQUFNLEdBQU4sTUFBTSxDQUFRO0lBQzlCLENBQUM7SUFFSjs7T0FFRztJQUNILFdBQVcsR0FBRyxLQUFLLElBQXNCLEVBQUU7UUFDekMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDbEIsTUFBTSwrQkFBK0IsR0FDbkMsSUFBSSwrQkFBK0IsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ25FLE1BQU0sc0JBQXNCLEdBQUcsSUFBSSxzQkFBc0IsQ0FDdkQsK0JBQStCLENBQUMsMkJBQTJCLEVBQUUsRUFDN0QsSUFBSSxDQUFDLE1BQU0sQ0FDWixDQUFDO1lBQ0YsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLG1CQUFtQixDQUNyQyxJQUFJLENBQUMsaUJBQWlCLEVBQ3RCLElBQUksc0JBQXNCLENBQ3hCLHNCQUFzQixDQUFDLFdBQVcsRUFBRSxFQUNwQyxlQUFlLEVBQUUsRUFDakIsSUFBSSxDQUFDLE9BQU8sQ0FDYixFQUNELElBQUksU0FBUyxFQUFFLEVBQ2YsSUFBSSxDQUFDLE9BQU8sQ0FDYixDQUFDO1NBQ0g7UUFDRCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDdkIsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBGb3JtYXQsXG4gIFBhY2thZ2VNYW5hZ2VyQ29udHJvbGxlckZhY3RvcnksXG4gIFByaW50ZXIsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9jbGktY29yZSc7XG5pbXBvcnQgeyBGaWxlV2F0Y2hpbmdTYW5kYm94IH0gZnJvbSAnLi9maWxlX3dhdGNoaW5nX3NhbmRib3guanMnO1xuaW1wb3J0IHsgQmFja2VuZElkU2FuZGJveFJlc29sdmVyLCBTYW5kYm94IH0gZnJvbSAnLi9zYW5kYm94LmpzJztcbmltcG9ydCB7IEJhY2tlbmREZXBsb3llckZhY3RvcnkgfSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1kZXBsb3llcic7XG5pbXBvcnQgeyBBbXBsaWZ5U2FuZGJveEV4ZWN1dG9yIH0gZnJvbSAnLi9zYW5kYm94X2V4ZWN1dG9yLmpzJztcbmltcG9ydCB7IFNTTUNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zc20nO1xuaW1wb3J0IHsgZ2V0U2VjcmV0Q2xpZW50IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtc2VjcmV0JztcblxuLyoqXG4gKiBGYWN0b3J5IHRvIGNyZWF0ZSBhIG5ldyBzYW5kYm94XG4gKi9cbmV4cG9ydCBjbGFzcyBTYW5kYm94U2luZ2xldG9uRmFjdG9yeSB7XG4gIHByaXZhdGUgaW5zdGFuY2U6IFNhbmRib3ggfCB1bmRlZmluZWQ7XG4gIC8qKlxuICAgKiBzYW5kYm94SWRSZXNvbHZlciBhbGxvd3Mgc2FuZGJveCB0byBsYXppbHkgbG9hZCB0aGUgc2FuZGJveCBiYWNrZW5kIGlkIG9uIGRlbWFuZFxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBzYW5kYm94SWRSZXNvbHZlcjogQmFja2VuZElkU2FuZGJveFJlc29sdmVyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJpbnRlcjogUHJpbnRlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGZvcm1hdDogRm9ybWF0XG4gICkge31cblxuICAvKipcbiAgICogUmV0dXJucyBhIHNpbmdsZXRvbiBpbnN0YW5jZSBvZiBhIFNhbmRib3hcbiAgICovXG4gIGdldEluc3RhbmNlID0gYXN5bmMgKCk6IFByb21pc2U8U2FuZGJveD4gPT4ge1xuICAgIGlmICghdGhpcy5pbnN0YW5jZSkge1xuICAgICAgY29uc3QgcGFja2FnZU1hbmFnZXJDb250cm9sbGVyRmFjdG9yeSA9XG4gICAgICAgIG5ldyBQYWNrYWdlTWFuYWdlckNvbnRyb2xsZXJGYWN0b3J5KHByb2Nlc3MuY3dkKCksIHRoaXMucHJpbnRlcik7XG4gICAgICBjb25zdCBiYWNrZW5kRGVwbG95ZXJGYWN0b3J5ID0gbmV3IEJhY2tlbmREZXBsb3llckZhY3RvcnkoXG4gICAgICAgIHBhY2thZ2VNYW5hZ2VyQ29udHJvbGxlckZhY3RvcnkuZ2V0UGFja2FnZU1hbmFnZXJDb250cm9sbGVyKCksXG4gICAgICAgIHRoaXMuZm9ybWF0XG4gICAgICApO1xuICAgICAgdGhpcy5pbnN0YW5jZSA9IG5ldyBGaWxlV2F0Y2hpbmdTYW5kYm94KFxuICAgICAgICB0aGlzLnNhbmRib3hJZFJlc29sdmVyLFxuICAgICAgICBuZXcgQW1wbGlmeVNhbmRib3hFeGVjdXRvcihcbiAgICAgICAgICBiYWNrZW5kRGVwbG95ZXJGYWN0b3J5LmdldEluc3RhbmNlKCksXG4gICAgICAgICAgZ2V0U2VjcmV0Q2xpZW50KCksXG4gICAgICAgICAgdGhpcy5wcmludGVyXG4gICAgICAgICksXG4gICAgICAgIG5ldyBTU01DbGllbnQoKSxcbiAgICAgICAgdGhpcy5wcmludGVyXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5pbnN0YW5jZTtcbiAgfTtcbn1cbiJdfQ==