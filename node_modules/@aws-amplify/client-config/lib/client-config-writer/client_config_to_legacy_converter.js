import { AmplifyFault } from '@aws-amplify/platform-core';
/**
 * Converts unified client config to the legacy format.
 */
export class ClientConfigLegacyConverter {
    /**
     * Converts client config to a shape consumable by legacy libraries.
     */
    convertToLegacyConfig = (clientConfig) => {
        // We can only convert from V1 of ClientConfig. For everything else, throw
        if (!this.isClientConfigV1(clientConfig)) {
            throw new AmplifyFault('UnsupportedClientConfigVersion', {
                message: 'Only version 1 of ClientConfig is supported.',
            });
        }
        let legacyConfig = {};
        // Gen2 backend constructs use the Stack's region and is identical. We use these to
        // populate the root level aws_project_region in legacy config.
        if (clientConfig.auth || clientConfig.data || clientConfig.storage) {
            legacyConfig.aws_project_region =
                clientConfig.auth?.aws_region ??
                    clientConfig.data?.aws_region ??
                    clientConfig.storage?.aws_region;
        }
        // Auth
        if (clientConfig.auth) {
            const authClientConfig = {
                aws_user_pools_id: clientConfig.auth.user_pool_id,
                aws_cognito_region: clientConfig.auth.aws_region,
                aws_user_pools_web_client_id: clientConfig.auth.user_pool_client_id,
                aws_cognito_identity_pool_id: clientConfig.auth.identity_pool_id,
            };
            if (clientConfig.auth.unauthenticated_identities_enabled) {
                authClientConfig.allowUnauthenticatedIdentities = clientConfig.auth
                    .unauthenticated_identities_enabled
                    ? 'true'
                    : 'false';
            }
            if (clientConfig.auth.mfa_methods) {
                authClientConfig.aws_cognito_mfa_types = clientConfig.auth.mfa_methods;
            }
            if (clientConfig.auth.mfa_configuration) {
                authClientConfig.aws_cognito_mfa_configuration =
                    clientConfig.auth.mfa_configuration;
            }
            if (clientConfig.auth.standard_required_attributes) {
                authClientConfig.aws_cognito_signup_attributes =
                    clientConfig.auth.standard_required_attributes?.map((attribute) => attribute.toUpperCase());
            }
            if (clientConfig.auth.username_attributes) {
                authClientConfig.aws_cognito_username_attributes =
                    clientConfig.auth.username_attributes?.map((attribute) => attribute.toUpperCase());
            }
            authClientConfig.aws_cognito_verification_mechanisms =
                clientConfig.auth.user_verification_types?.map((attribute) => attribute.toUpperCase());
            if (clientConfig.auth.password_policy) {
                authClientConfig.aws_cognito_password_protection_settings = {};
                if (clientConfig.auth.password_policy.min_length) {
                    authClientConfig.aws_cognito_password_protection_settings = {
                        passwordPolicyMinLength: clientConfig.auth.password_policy.min_length,
                    };
                }
                const requirements = [];
                if (clientConfig.auth.password_policy.require_numbers) {
                    requirements.push('REQUIRES_NUMBERS');
                }
                if (clientConfig.auth.password_policy.require_lowercase) {
                    requirements.push('REQUIRES_LOWERCASE');
                }
                if (clientConfig.auth.password_policy.require_uppercase) {
                    requirements.push('REQUIRES_UPPERCASE');
                }
                if (clientConfig.auth.password_policy.require_symbols) {
                    requirements.push('REQUIRES_SYMBOLS');
                }
                authClientConfig.aws_cognito_password_protection_settings.passwordPolicyCharacters =
                    requirements;
            }
            if (clientConfig.auth.oauth) {
                authClientConfig.oauth = {};
                authClientConfig.aws_cognito_social_providers =
                    clientConfig.auth.oauth.identity_providers.map((provider) => {
                        if (provider === 'SIGN_IN_WITH_APPLE') {
                            return 'APPLE';
                        }
                        if (provider === 'LOGIN_WITH_AMAZON') {
                            return 'AMAZON';
                        }
                        return provider;
                    });
                authClientConfig.oauth.domain = clientConfig.auth.oauth.domain;
                authClientConfig.oauth.scope = clientConfig.auth.oauth.scopes;
                authClientConfig.oauth.redirectSignIn =
                    clientConfig.auth.oauth.redirect_sign_in_uri.join(',');
                authClientConfig.oauth.redirectSignOut =
                    clientConfig.auth.oauth.redirect_sign_out_uri.join(',');
                authClientConfig.oauth.responseType =
                    clientConfig.auth.oauth.response_type;
            }
            legacyConfig = { ...legacyConfig, ...authClientConfig };
        }
        // Data category
        if (clientConfig.data) {
            const dataConfig = {
                aws_appsync_authenticationType: clientConfig.data.default_authorization_type,
                aws_appsync_region: clientConfig.data.aws_region,
                aws_appsync_graphqlEndpoint: clientConfig.data.url,
                modelIntrospection: clientConfig.data.model_introspection,
            };
            if (clientConfig.data.api_key) {
                dataConfig.aws_appsync_apiKey = clientConfig.data.api_key;
            }
            if (clientConfig.data.authorization_types) {
                dataConfig.aws_appsync_additionalAuthenticationTypes =
                    clientConfig.data.authorization_types.join(',');
            }
            legacyConfig = { ...legacyConfig, ...dataConfig };
        }
        // Storage category
        if (clientConfig.storage) {
            const storageConfig = {
                aws_user_files_s3_bucket: clientConfig.storage.bucket_name,
                aws_user_files_s3_bucket_region: clientConfig.storage.aws_region,
            };
            legacyConfig = { ...legacyConfig, ...storageConfig };
        }
        // Analytics category
        if (clientConfig.analytics && clientConfig.analytics.amazon_pinpoint) {
            const analyticsConfig = {
                Analytics: {
                    Pinpoint: {
                        appId: clientConfig.analytics.amazon_pinpoint.app_id,
                        region: clientConfig.analytics.amazon_pinpoint.aws_region,
                    },
                },
            };
            legacyConfig = { ...legacyConfig, ...analyticsConfig };
            legacyConfig.aws_mobile_analytics_app_id =
                clientConfig.analytics.amazon_pinpoint.app_id;
            legacyConfig.aws_mobile_analytics_app_region =
                clientConfig.analytics.amazon_pinpoint.aws_region;
        }
        // Geo category
        if (clientConfig.geo) {
            const geoConfig = {
                geo: {
                    amazon_location_service: {
                        region: clientConfig.geo.aws_region,
                    },
                },
            };
            if (clientConfig.geo.maps) {
                const mapsLegacyConfig = {};
                for (const mapName in clientConfig.geo.maps.items) {
                    if (clientConfig.geo.maps.items[mapName].style) {
                        mapsLegacyConfig[mapName] = {
                            style: clientConfig.geo.maps.items[mapName].style,
                        };
                    }
                }
                geoConfig.geo.amazon_location_service.maps = {
                    default: clientConfig.geo.maps.default,
                    items: mapsLegacyConfig,
                };
            }
            if (clientConfig.geo.search_indices) {
                geoConfig.geo.amazon_location_service.search_indices =
                    clientConfig.geo.search_indices;
            }
            if (clientConfig.geo.geofence_collections) {
                geoConfig.geo.amazon_location_service.geofenceCollections =
                    clientConfig.geo.geofence_collections;
            }
            legacyConfig = { ...legacyConfig, ...geoConfig };
        }
        // Notifications
        if (clientConfig.notifications) {
            const pinPointConfig = {
                AWSPinpoint: {
                    appId: clientConfig.notifications.amazon_pinpoint_app_id,
                    region: clientConfig.notifications.aws_region,
                },
            };
            const notificationConfig = {};
            notificationConfig.Notifications = {};
            for (const notificationChannel of clientConfig.notifications.channels) {
                switch (notificationChannel) {
                    case 'IN_APP_MESSAGING':
                        notificationConfig.Notifications.InAppMessaging = pinPointConfig;
                        break;
                    case 'FCM':
                        notificationConfig.Notifications.Push = pinPointConfig;
                        break;
                    case 'APNS':
                        // It's fine to overwrite APNS over FCM since they are the exact same config.
                        notificationConfig.Notifications.Push = pinPointConfig;
                        break;
                    case 'EMAIL':
                        notificationConfig.Notifications.EMAIL = pinPointConfig;
                        break;
                    case 'SMS':
                        notificationConfig.Notifications.SMS = pinPointConfig;
                        break;
                }
            }
            legacyConfig = { ...legacyConfig, ...notificationConfig };
        }
        // Custom
        if (clientConfig.custom) {
            legacyConfig.custom = clientConfig.custom;
        }
        return legacyConfig;
    };
    isClientConfigV1 = (clientConfig) => {
        return clientConfig.version === '1';
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50X2NvbmZpZ190b19sZWdhY3lfY29udmVydGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NsaWVudC1jb25maWctd3JpdGVyL2NsaWVudF9jb25maWdfdG9fbGVnYWN5X2NvbnZlcnRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFnQjFEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLDJCQUEyQjtJQUN0Qzs7T0FFRztJQUNILHFCQUFxQixHQUFHLENBQUMsWUFBMEIsRUFBc0IsRUFBRTtRQUN6RSwwRUFBMEU7UUFDMUUsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsRUFBRTtZQUN4QyxNQUFNLElBQUksWUFBWSxDQUFDLGdDQUFnQyxFQUFFO2dCQUN2RCxPQUFPLEVBQUUsOENBQThDO2FBQ3hELENBQUMsQ0FBQztTQUNKO1FBRUQsSUFBSSxZQUFZLEdBQXVCLEVBQUUsQ0FBQztRQUUxQyxtRkFBbUY7UUFDbkYsK0RBQStEO1FBQy9ELElBQUksWUFBWSxDQUFDLElBQUksSUFBSSxZQUFZLENBQUMsSUFBSSxJQUFJLFlBQVksQ0FBQyxPQUFPLEVBQUU7WUFDbEUsWUFBWSxDQUFDLGtCQUFrQjtnQkFDN0IsWUFBWSxDQUFDLElBQUksRUFBRSxVQUFVO29CQUM3QixZQUFZLENBQUMsSUFBSSxFQUFFLFVBQVU7b0JBQzdCLFlBQVksQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDO1NBQ3BDO1FBRUQsT0FBTztRQUNQLElBQUksWUFBWSxDQUFDLElBQUksRUFBRTtZQUNyQixNQUFNLGdCQUFnQixHQUFxQjtnQkFDekMsaUJBQWlCLEVBQUUsWUFBWSxDQUFDLElBQUksQ0FBQyxZQUFZO2dCQUNqRCxrQkFBa0IsRUFBRSxZQUFZLENBQUMsSUFBSSxDQUFDLFVBQVU7Z0JBQ2hELDRCQUE0QixFQUFFLFlBQVksQ0FBQyxJQUFJ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RyxjQUFjLENBQUM7d0JBQ3hELE1BQU07b0JBQ1IsS0FBSyxLQUFLO3dCQUNSLGtCQUFrQixDQUFDLGFBQWEsQ0FBQyxHQUFHLEdBQUcsY0FBYyxDQUFDO3dCQUN0RCxNQUFNO2lCQUNUO2FBQ0Y7WUFFRCxZQUFZLEdBQUcsRUFBRSxHQUFHLFlBQVksRUFBRSxHQUFHLGtCQUFrQixFQUFFLENBQUM7U0FDM0Q7UUFFRCxTQUFTO1FBQ1QsSUFBSSxZQUFZLENBQUMsTUFBTSxFQUFFO1lBQ3ZCLFlBQVksQ0FBQyxNQUFNLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQztTQUMzQztRQUVELE9BQU8sWUFBWSxDQUFDO0lBQ3RCLENBQUMsQ0FBQztJQUVGLGdCQUFnQixHQUFHLENBQ2pCLFlBQTBCLEVBQ29DLEVBQUU7UUFDaEUsT0FBTyxZQUFZLENBQUMsT0FBTyxLQUFLLEdBQUcsQ0FBQztJQUN0QyxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFtcGxpZnlGYXVsdCB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7XG4gIENsaWVudENvbmZpZyxcbiAgQ2xpZW50Q29uZmlnTGVnYWN5LFxuICBjbGllbnRDb25maWdUeXBlc1YxLFxufSBmcm9tICcuLi9jbGllbnQtY29uZmlnLXR5cGVzL2NsaWVudF9jb25maWcuanMnO1xuXG5pbXBvcnQge1xuICBBbmFseXRpY3NDbGllbnRDb25maWcsXG4gIEF1dGhDbGllbnRDb25maWcsXG4gIEdlb0NsaWVudENvbmZpZyxcbiAgR3JhcGhxbENsaWVudENvbmZpZyxcbiAgTm90aWZpY2F0aW9uc0NsaWVudENvbmZpZyxcbiAgU3RvcmFnZUNsaWVudENvbmZpZyxcbn0gZnJvbSAnLi4vaW5kZXguanMnO1xuXG4vKipcbiAqIENvbnZlcnRzIHVuaWZpZWQgY2xpZW50IGNvbmZpZyB0byB0aGUgbGVnYWN5IGZvcm1hdC5cbiAqL1xuZXhwb3J0IGNsYXNzIENsaWVudENvbmZpZ0xlZ2FjeUNvbnZlcnRlciB7XG4gIC8qKlxuICAgKiBDb252ZXJ0cyBjbGllbnQgY29uZmlnIHRvIGEgc2hhcGUgY29uc3VtYWJsZSBieSBsZWdhY3kgbGlicmFyaWVzLlxuICAgKi9cbiAgY29udmVydFRvTGVnYWN5Q29uZmlnID0gKGNsaWVudENvbmZpZzogQ2xpZW50Q29uZmlnKTogQ2xpZW50Q29uZmlnTGVnYWN5ID0+IHtcbiAgICAvLyBXZSBjYW4gb25seSBjb252ZXJ0IGZyb20gVjEgb2YgQ2xpZW50Q29uZmlnLiBGb3IgZXZlcnl0aGluZyBlbHNlLCB0aHJvd1xuICAgIGlmICghdGhpcy5pc0NsaWVudENvbmZpZ1YxKGNsaWVudENvbmZpZykpIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5RmF1bHQoJ1Vuc3VwcG9ydGVkQ2xpZW50Q29uZmlnVmVyc2lvbicsIHtcbiAgICAgICAgbWVzc2FnZTogJ09ubHkgdmVyc2lvbiAxIG9mIENsaWVudENvbmZpZyBpcyBzdXBwb3J0ZWQuJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGxldCBsZWdhY3lDb25maWc6IENsaWVudENvbmZpZ0xlZ2FjeSA9IHt9O1xuXG4gICAgLy8gR2VuMiBiYWNrZW5kIGNvbnN0cnVjdHMgdXNlIHRoZSBTdGFjaydzIHJlZ2lvbiBhbmQgaXMgaWRlbnRpY2FsLiBXZSB1c2UgdGhlc2UgdG9cbiAgICAvLyBwb3B1bGF0ZSB0aGUgcm9vdCBsZXZlbCBhd3NfcHJvamVjdF9yZWdpb24gaW4gbGVnYWN5IGNvbmZpZy5cbiAgICBpZiAoY2xpZW50Q29uZmlnLmF1dGggfHwgY2xpZW50Q29uZmlnLmRhdGEgfHwgY2xpZW50Q29uZmlnLnN0b3JhZ2UpIHtcbiAgICAgIGxlZ2FjeUNvbmZpZy5hd3NfcHJvamVjdF9yZWdpb24gPVxuICAgICAgICBjbGllbnRDb25maWcuYXV0aD8uYXdzX3JlZ2lvbiA/P1xuICAgICAgICBjbGllbnRDb25maWcuZGF0YT8uYXdzX3JlZ2lvbiA/P1xuICAgICAgICBjbGllbnRDb25maWcuc3RvcmFnZT8uYXdzX3JlZ2lvbjtcbiAgICB9XG5cbiAgICAvLyBBdXRoXG4gICAgaWYgKGNsaWVudENvbmZpZy5hdXRoKSB7XG4gICAgICBjb25zdCBhdXRoQ2xpZW50Q29uZmlnOiBBdXRoQ2xpZW50Q29uZmlnID0ge1xuICAgICAgICBhd3NfdXNlcl9wb29sc19pZDogY2xpZW50Q29uZmlnLmF1dGgudXNlcl9wb29sX2lkLFxuICAgICAgICBhd3NfY29nbml0b19yZWdpb246IGNsaWVudENvbmZpZy5hdXRoLmF3c19yZWdpb24sXG4gICAgICAgIGF3c191c2VyX3Bvb2xzX3dlYl9jbGllbnRfaWQ6IGNsaWVudENvbmZpZy5hdXRoLnVzZXJfcG9vbF9jbGllbnRfaWQsXG4gICAgICAgIGF3c19jb2duaXRvX2lkZW50aXR5X3Bvb2xfaWQ6IGNsaWVudENvbmZpZy5hdXRoLmlkZW50aXR5X3Bvb2xfaWQsXG4gICAgICB9O1xuXG4gICAgICBpZiAoY2xpZW50Q29uZmlnLmF1dGgudW5hdXRoZW50aWNhdGVkX2lkZW50aXRpZXNfZW5hYmxlZCkge1xuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLmFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyA9IGNsaWVudENvbmZpZy5hdXRoXG4gICAgICAgICAgLnVuYXV0aGVudGljYXRlZF9pZGVudGl0aWVzX2VuYWJsZWRcbiAgICAgICAgICA/ICd0cnVlJ1xuICAgICAgICAgIDogJ2ZhbHNlJztcbiAgICAgIH1cblxuICAgICAgaWYgKGNsaWVudENvbmZpZy5hdXRoLm1mYV9tZXRob2RzKSB7XG4gICAgICAgIGF1dGhDbGllbnRDb25maWcuYXdzX2NvZ25pdG9fbWZhX3R5cGVzID0gY2xpZW50Q29uZmlnLmF1dGgubWZhX21ldGhvZHM7XG4gICAgICB9XG5cbiAgICAgIGlmIChjbGllbnRDb25maWcuYXV0aC5tZmFfY29uZmlndXJhdGlvbikge1xuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLmF3c19jb2duaXRvX21mYV9jb25maWd1cmF0aW9uID1cbiAgICAgICAgICBjbGllbnRDb25maWcuYXV0aC5tZmFfY29uZmlndXJhdGlvbjtcbiAgICAgIH1cblxuICAgICAgaWYgKGNsaWVudENvbmZpZy5hdXRoLnN0YW5kYXJkX3JlcXVpcmVkX2F0dHJpYnV0ZXMpIHtcbiAgICAgICAgYXV0aENsaWVudENvbmZpZy5hd3NfY29nbml0b19zaWdudXBfYXR0cmlidXRlcyA9XG4gICAgICAgICAgY2xpZW50Q29uZmlnLmF1dGguc3RhbmRhcmRfcmVxdWlyZWRfYXR0cmlidXRlcz8ubWFwKChhdHRyaWJ1dGUpID0+XG4gICAgICAgICAgICBhdHRyaWJ1dGUudG9VcHBlckNhc2UoKVxuICAgICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGlmIChjbGllbnRDb25maWcuYXV0aC51c2VybmFtZV9hdHRyaWJ1dGVzKSB7XG4gICAgICAgIGF1dGhDbGllbnRDb25maWcuYXdzX2NvZ25pdG9fdXNlcm5hbWVfYXR0cmlidXRlcyA9XG4gICAgICAgICAgY2xpZW50Q29uZmlnLmF1dGgudXNlcm5hbWVfYXR0cmlidXRlcz8ubWFwKChhdHRyaWJ1dGUpID0+XG4gICAgICAgICAgICBhdHRyaWJ1dGUudG9VcHBlckNhc2UoKVxuICAgICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGF1dGhDbGllbnRDb25maWcuYXdzX2NvZ25pdG9fdmVyaWZpY2F0aW9uX21lY2hhbmlzbXMgPVxuICAgICAgICBjbGllbnRDb25maWcuYXV0aC51c2VyX3ZlcmlmaWNhdGlvbl90eXBlcz8ubWFwKChhdHRyaWJ1dGUpID0+XG4gICAgICAgICAgYXR0cmlidXRlLnRvVXBwZXJDYXNlKClcbiAgICAgICAgKTtcblxuICAgICAgaWYgKGNsaWVudENvbmZpZy5hdXRoLnBhc3N3b3JkX3BvbGljeSkge1xuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLmF3c19jb2duaXRvX3Bhc3N3b3JkX3Byb3RlY3Rpb25fc2V0dGluZ3MgPSB7fTtcbiAgICAgICAgaWYgKGNsaWVudENvbmZpZy5hdXRoLnBhc3N3b3JkX3BvbGljeS5taW5fbGVuZ3RoKSB7XG4gICAgICAgICAgYXV0aENsaWVudENvbmZpZy5hd3NfY29nbml0b19wYXNzd29yZF9wcm90ZWN0aW9uX3NldHRpbmdzID0ge1xuICAgICAgICAgICAgcGFzc3dvcmRQb2xpY3lNaW5MZW5ndGg6XG4gICAgICAgICAgICAgIGNsaWVudENvbmZpZy5hdXRoLnBhc3N3b3JkX3BvbGljeS5taW5fbGVuZ3RoLFxuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcmVxdWlyZW1lbnRzID0gW107XG4gICAgICAgIGlmIChjbGllbnRDb25maWcuYXV0aC5wYXNzd29yZF9wb2xpY3kucmVxdWlyZV9udW1iZXJzKSB7XG4gICAgICAgICAgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX05VTUJFUlMnKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY2xpZW50Q29uZmlnLmF1dGgucGFzc3dvcmRfcG9saWN5LnJlcXVpcmVfbG93ZXJjYXNlKSB7XG4gICAgICAgICAgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX0xPV0VSQ0FTRScpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjbGllbnRDb25maWcuYXV0aC5wYXNzd29yZF9wb2xpY3kucmVxdWlyZV91cHBlcmNhc2UpIHtcbiAgICAgICAgICByZXF1aXJlbWVudHMucHVzaCgnUkVRVUlSRVNfVVBQRVJDQVNFJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNsaWVudENvbmZpZy5hdXRoLnBhc3N3b3JkX3BvbGljeS5yZXF1aXJlX3N5bWJvbHMpIHtcbiAgICAgICAgICByZXF1aXJlbWVudHMucHVzaCgnUkVRVUlSRVNfU1lNQk9MUycpO1xuICAgICAgICB9XG4gICAgICAgIGF1dGhDbGllbnRDb25maWcuYXdzX2NvZ25pdG9fcGFzc3dvcmRfcHJvdGVjdGlvbl9zZXR0aW5ncy5wYXNzd29yZFBvbGljeUNoYXJhY3RlcnMgPVxuICAgICAgICAgIHJlcXVpcmVtZW50cztcbiAgICAgIH1cblxuICAgICAgaWYgKGNsaWVudENvbmZpZy5hdXRoLm9hdXRoKSB7XG4gICAgICAgIGF1dGhDbGllbnRDb25maWcub2F1dGggPSB7fTtcbiAgICAgICAgYXV0aENsaWVudENvbmZpZy5hd3NfY29nbml0b19zb2NpYWxfcHJvdmlkZXJzID1cbiAgICAgICAgICBjbGllbnRDb25maWcuYXV0aC5vYXV0aC5pZGVudGl0eV9wcm92aWRlcnMubWFwKChwcm92aWRlcikgPT4ge1xuICAgICAgICAgICAgaWYgKHByb3ZpZGVyID09PSAnU0lHTl9JTl9XSVRIX0FQUExFJykge1xuICAgICAgICAgICAgICByZXR1cm4gJ0FQUExFJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwcm92aWRlciA9PT0gJ0xPR0lOX1dJVEhfQU1BWk9OJykge1xuICAgICAgICAgICAgICByZXR1cm4gJ0FNQVpPTic7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcHJvdmlkZXI7XG4gICAgICAgICAgfSk7XG4gICAgICAgIGF1dGhDbGllbnRDb25maWcub2F1dGguZG9tYWluID0gY2xpZW50Q29uZmlnLmF1dGgub2F1dGguZG9tYWluO1xuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLm9hdXRoLnNjb3BlID0gY2xpZW50Q29uZmlnLmF1dGgub2F1dGguc2NvcGVzO1xuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLm9hdXRoLnJlZGlyZWN0U2lnbkluID1cbiAgICAgICAgICBjbGllbnRDb25maWcuYXV0aC5vYXV0aC5yZWRpcmVjdF9zaWduX2luX3VyaS5qb2luKCcsJyk7XG4gICAgICAgIGF1dGhDbGllbnRDb25maWcub2F1dGgucmVkaXJlY3RTaWduT3V0ID1cbiAgICAgICAgICBjbGllbnRDb25maWcuYXV0aC5vYXV0aC5yZWRpcmVjdF9zaWduX291dF91cmkuam9pbignLCcpO1xuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLm9hdXRoLnJlc3BvbnNlVHlwZSA9XG4gICAgICAgICAgY2xpZW50Q29uZmlnLmF1dGgub2F1dGgucmVzcG9uc2VfdHlwZTtcbiAgICAgIH1cblxuICAgICAgbGVnYWN5Q29uZmlnID0geyAuLi5sZWdhY3lDb25maWcsIC4uLmF1dGhDbGllbnRDb25maWcgfTtcbiAgICB9XG5cbiAgICAvLyBEYXRhIGNhdGVnb3J5XG4gICAgaWYgKGNsaWVudENvbmZpZy5kYXRhKSB7XG4gICAgICBjb25zdCBkYXRhQ29uZmlnOiBHcmFwaHFsQ2xpZW50Q29uZmlnID0ge1xuICAgICAgICBhd3NfYXBwc3luY19hdXRoZW50aWNhdGlvblR5cGU6XG4gICAgICAgICAgY2xpZW50Q29uZmlnLmRhdGEuZGVmYXVsdF9hdXRob3JpemF0aW9uX3R5cGUsXG4gICAgICAgIGF3c19hcHBzeW5jX3JlZ2lvbjogY2xpZW50Q29uZmlnLmRhdGEuYXdzX3JlZ2lvbixcbiAgICAgICAgYXdzX2FwcHN5bmNfZ3JhcGhxbEVuZHBvaW50OiBjbGllbnRDb25maWcuZGF0YS51cmwsXG4gICAgICAgIG1vZGVsSW50cm9zcGVjdGlvbjogY2xpZW50Q29uZmlnLmRhdGEubW9kZWxfaW50cm9zcGVjdGlvbixcbiAgICAgIH07XG5cbiAgICAgIGlmIChjbGllbnRDb25maWcuZGF0YS5hcGlfa2V5KSB7XG4gICAgICAgIGRhdGFDb25maWcuYXdzX2FwcHN5bmNfYXBpS2V5ID0gY2xpZW50Q29uZmlnLmRhdGEuYXBpX2tleTtcbiAgICAgIH1cblxuICAgICAgaWYgKGNsaWVudENvbmZpZy5kYXRhLmF1dGhvcml6YXRpb25fdHlwZXMpIHtcbiAgICAgICAgZGF0YUNvbmZpZy5hd3NfYXBwc3luY19hZGRpdGlvbmFsQXV0aGVudGljYXRpb25UeXBlcyA9XG4gICAgICAgICAgY2xpZW50Q29uZmlnLmRhdGEuYXV0aG9yaXphdGlvbl90eXBlcy5qb2luKCcsJyk7XG4gICAgICB9XG5cbiAgICAgIGxlZ2FjeUNvbmZpZyA9IHsgLi4ubGVnYWN5Q29uZmlnLCAuLi5kYXRhQ29uZmlnIH07XG4gICAgfVxuXG4gICAgLy8gU3RvcmFnZSBjYXRlZ29yeVxuICAgIGlmIChjbGllbnRDb25maWcuc3RvcmFnZSkge1xuICAgICAgY29uc3Qgc3RvcmFnZUNvbmZpZzogU3RvcmFnZUNsaWVudENvbmZpZyA9IHtcbiAgICAgICAgYXdzX3VzZXJfZmlsZXNfczNfYnVja2V0OiBjbGllbnRDb25maWcuc3RvcmFnZS5idWNrZXRfbmFtZSxcbiAgICAgICAgYXdzX3VzZXJfZmlsZXNfczNfYnVja2V0X3JlZ2lvbjogY2xpZW50Q29uZmlnLnN0b3JhZ2UuYXdzX3JlZ2lvbixcbiAgICAgIH07XG4gICAgICBsZWdhY3lDb25maWcgPSB7IC4uLmxlZ2FjeUNvbmZpZywgLi4uc3RvcmFnZUNvbmZpZyB9O1xuICAgIH1cblxuICAgIC8vIEFuYWx5dGljcyBjYXRlZ29yeVxuICAgIGlmIChjbGllbnRDb25maWcuYW5hbHl0aWNzICYmIGNsaWVudENvbmZpZy5hbmFseXRpY3MuYW1hem9uX3BpbnBvaW50KSB7XG4gICAgICBjb25zdCBhbmFseXRpY3NDb25maWc6IEFuYWx5dGljc0NsaWVudENvbmZpZyA9IHtcbiAgICAgICAgQW5hbHl0aWNzOiB7XG4gICAgICAgICAgUGlucG9pbnQ6IHtcbiAgICAgICAgICAgIGFwcElkOiBjbGllbnRDb25maWcuYW5hbHl0aWNzLmFtYXpvbl9waW5wb2ludC5hcHBfaWQsXG4gICAgICAgICAgICByZWdpb246IGNsaWVudENvbmZpZy5hbmFseXRpY3MuYW1hem9uX3BpbnBvaW50LmF3c19yZWdpb24sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgICBsZWdhY3lDb25maWcgPSB7IC4uLmxlZ2FjeUNvbmZpZywgLi4uYW5hbHl0aWNzQ29uZmlnIH07XG4gICAgICBsZWdhY3lDb25maWcuYXdzX21vYmlsZV9hbmFseXRpY3NfYXBwX2lkID1cbiAgICAgICAgY2xpZW50Q29uZmlnLmFuYWx5dGljcy5hbWF6b25fcGlucG9pbnQuYXBwX2lkO1xuICAgICAgbGVnYWN5Q29uZmlnLmF3c19tb2JpbGVfYW5hbHl0aWNzX2FwcF9yZWdpb24gPVxuICAgICAgICBjbGllbnRDb25maWcuYW5hbHl0aWNzLmFtYXpvbl9waW5wb2ludC5hd3NfcmVnaW9uO1xuICAgIH1cblxuICAgIC8vIEdlbyBjYXRlZ29yeVxuICAgIGlmIChjbGllbnRDb25maWcuZ2VvKSB7XG4gICAgICBjb25zdCBnZW9Db25maWc6IEdlb0NsaWVudENvbmZpZyA9IHtcbiAgICAgICAgZ2VvOiB7XG4gICAgICAgICAgYW1hem9uX2xvY2F0aW9uX3NlcnZpY2U6IHtcbiAgICAgICAgICAgIHJlZ2lvbjogY2xpZW50Q29uZmlnLmdlby5hd3NfcmVnaW9uLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9O1xuXG4gICAgICBpZiAoY2xpZW50Q29uZmlnLmdlby5tYXBzKSB7XG4gICAgICAgIGNvbnN0IG1hcHNMZWdhY3lDb25maWc6IFJlY29yZDxzdHJpbmcsIHsgc3R5bGU6IHN0cmluZyB9PiA9IHt9O1xuICAgICAgICBmb3IgKGNvbnN0IG1hcE5hbWUgaW4gY2xpZW50Q29uZmlnLmdlby5tYXBzLml0ZW1zKSB7XG4gICAgICAgICAgaWYgKGNsaWVudENvbmZpZy5nZW8ubWFwcy5pdGVtc1ttYXBOYW1lXS5zdHlsZSkge1xuICAgICAgICAgICAgbWFwc0xlZ2FjeUNvbmZpZ1ttYXBOYW1lXSA9IHtcbiAgICAgICAgICAgICAgc3R5bGU6IGNsaWVudENvbmZpZy5nZW8ubWFwcy5pdGVtc1ttYXBOYW1lXS5zdHlsZSEsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBnZW9Db25maWcuZ2VvIS5hbWF6b25fbG9jYXRpb25fc2VydmljZS5tYXBzID0ge1xuICAgICAgICAgIGRlZmF1bHQ6IGNsaWVudENvbmZpZy5nZW8ubWFwcy5kZWZhdWx0LFxuICAgICAgICAgIGl0ZW1zOiBtYXBzTGVnYWN5Q29uZmlnLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICBpZiAoY2xpZW50Q29uZmlnLmdlby5zZWFyY2hfaW5kaWNlcykge1xuICAgICAgICBnZW9Db25maWcuZ2VvIS5hbWF6b25fbG9jYXRpb25fc2VydmljZS5zZWFyY2hfaW5kaWNlcyA9XG4gICAgICAgICAgY2xpZW50Q29uZmlnLmdlby5zZWFyY2hfaW5kaWNlcztcbiAgICAgIH1cblxuICAgICAgaWYgKGNsaWVudENvbmZpZy5nZW8uZ2VvZmVuY2VfY29sbGVjdGlvbnMpIHtcbiAgICAgICAgZ2VvQ29uZmlnLmdlbyEuYW1hem9uX2xvY2F0aW9uX3NlcnZpY2UuZ2VvZmVuY2VDb2xsZWN0aW9ucyA9XG4gICAgICAgICAgY2xpZW50Q29uZmlnLmdlby5nZW9mZW5jZV9jb2xsZWN0aW9ucztcbiAgICAgIH1cblxuICAgICAgbGVnYWN5Q29uZmlnID0geyAuLi5sZWdhY3lDb25maWcsIC4uLmdlb0NvbmZpZyB9O1xuICAgIH1cblxuICAgIC8vIE5vdGlmaWNhdGlvbnNcbiAgICBpZiAoY2xpZW50Q29uZmlnLm5vdGlmaWNhdGlvbnMpIHtcbiAgICAgIGNvbnN0IHBpblBvaW50Q29uZmlnID0ge1xuICAgICAgICBBV1NQaW5wb2ludDoge1xuICAgICAgICAgIGFwcElkOiBjbGllbnRDb25maWcubm90aWZpY2F0aW9ucy5hbWF6b25fcGlucG9pbnRfYXBwX2lkLFxuICAgICAgICAgIHJlZ2lvbjogY2xpZW50Q29uZmlnLm5vdGlmaWNhdGlvbnMuYXdzX3JlZ2lvbixcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgICBjb25zdCBub3RpZmljYXRpb25Db25maWc6IE5vdGlmaWNhdGlvbnNDbGllbnRDb25maWcgPSB7fTtcbiAgICAgIG5vdGlmaWNhdGlvbkNvbmZpZy5Ob3RpZmljYXRpb25zID0ge307XG4gICAgICBmb3IgKGNvbnN0IG5vdGlmaWNhdGlvbkNoYW5uZWwgb2YgY2xpZW50Q29uZmlnLm5vdGlmaWNhdGlvbnMuY2hhbm5lbHMpIHtcbiAgICAgICAgc3dpdGNoIChub3RpZmljYXRpb25DaGFubmVsKSB7XG4gICAgICAgICAgY2FzZSAnSU5fQVBQX01FU1NBR0lORyc6XG4gICAgICAgICAgICBub3RpZmljYXRpb25Db25maWcuTm90aWZpY2F0aW9ucy5JbkFwcE1lc3NhZ2luZyA9IHBpblBvaW50Q29uZmlnO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnRkNNJzpcbiAgICAgICAgICAgIG5vdGlmaWNhdGlvbkNvbmZpZy5Ob3RpZmljYXRpb25zLlB1c2ggPSBwaW5Qb2ludENvbmZpZztcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ0FQTlMnOlxuICAgICAgICAgICAgLy8gSXQncyBmaW5lIHRvIG92ZXJ3cml0ZSBBUE5TIG92ZXIgRkNNIHNpbmNlIHRoZXkgYXJlIHRoZSBleGFjdCBzYW1lIGNvbmZpZy5cbiAgICAgICAgICAgIG5vdGlmaWNhdGlvbkNvbmZpZy5Ob3RpZmljYXRpb25zLlB1c2ggPSBwaW5Qb2ludENvbmZpZztcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ0VNQUlMJzpcbiAgICAgICAgICAgIG5vdGlmaWNhdGlvbkNvbmZpZy5Ob3RpZmljYXRpb25zLkVNQUlMID0gcGluUG9pbnRDb25maWc7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdTTVMnOlxuICAgICAgICAgICAgbm90aWZpY2F0aW9uQ29uZmlnLk5vdGlmaWNhdGlvbnMuU01TID0gcGluUG9pbnRDb25maWc7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBsZWdhY3lDb25maWcgPSB7IC4uLmxlZ2FjeUNvbmZpZywgLi4ubm90aWZpY2F0aW9uQ29uZmlnIH07XG4gICAgfVxuXG4gICAgLy8gQ3VzdG9tXG4gICAgaWYgKGNsaWVudENvbmZpZy5jdXN0b20pIHtcbiAgICAgIGxlZ2FjeUNvbmZpZy5jdXN0b20gPSBjbGllbnRDb25maWcuY3VzdG9tO1xuICAgIH1cblxuICAgIHJldHVybiBsZWdhY3lDb25maWc7XG4gIH07XG5cbiAgaXNDbGllbnRDb25maWdWMSA9IChcbiAgICBjbGllbnRDb25maWc6IENsaWVudENvbmZpZ1xuICApOiBjbGllbnRDb25maWcgaXMgY2xpZW50Q29uZmlnVHlwZXNWMS5BV1NBbXBsaWZ5QmFja2VuZE91dHB1dHMgPT4ge1xuICAgIHJldHVybiBjbGllbnRDb25maWcudmVyc2lvbiA9PT0gJzEnO1xuICB9O1xufVxuIl19