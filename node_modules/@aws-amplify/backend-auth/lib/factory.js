import * as path from 'path';
import { UserPoolOperation } from 'aws-cdk-lib/aws-cognito';
import { AmplifyUserError, TagName } from '@aws-amplify/platform-core';
import { AmplifyAuth, } from '@aws-amplify/auth-construct';
import { translateToAuthConstructLoginWith } from './translate_auth_props.js';
import { authAccessBuilder as _authAccessBuilder } from './access_builder.js';
import { AuthAccessPolicyArbiterFactory } from './auth_access_policy_arbiter.js';
import { UserPoolAccessPolicyFactory } from './userpool_access_policy_factory.js';
import { Tags } from 'aws-cdk-lib';
/**
 * Singleton factory for AmplifyAuth that can be used in Amplify project files.
 *
 * Exported for testing purpose only & should NOT be exported out of the package.
 */
export class AmplifyAuthFactory {
    props;
    importStack;
    // publicly accessible for testing purpose only.
    static factoryCount = 0;
    provides = 'AuthResources';
    generator;
    /**
     * Set the properties that will be used to initialize AmplifyAuth
     */
    constructor(props, importStack = new Error().stack) {
        this.props = props;
        this.importStack = importStack;
        if (AmplifyAuthFactory.factoryCount > 0) {
            throw new AmplifyUserError('MultipleSingletonResourcesError', {
                message: 'Multiple `defineAuth` calls are not allowed within an Amplify backend',
                resolution: 'Remove all but one `defineAuth` call',
            });
        }
        AmplifyAuthFactory.factoryCount++;
    }
    /**
     * Get a singleton instance of AmplifyAuth
     */
    getInstance = (getInstanceProps) => {
        const { constructContainer, importPathVerifier, resourceNameValidator } = getInstanceProps;
        importPathVerifier?.verify(this.importStack, path.join('amplify', 'auth', 'resource'), 'Amplify Auth must be defined in amplify/auth/resource.ts');
        if (this.props.name) {
            resourceNameValidator?.validate(this.props.name);
        }
        if (!this.generator) {
            this.generator = new AmplifyAuthGenerator(this.props, getInstanceProps);
        }
        return constructContainer.getOrCompute(this.generator);
    };
}
class AmplifyAuthGenerator {
    props;
    getInstanceProps;
    authAccessBuilder;
    authAccessPolicyArbiterFactory;
    resourceGroupName = 'auth';
    name;
    constructor(props, getInstanceProps, authAccessBuilder = _authAccessBuilder, authAccessPolicyArbiterFactory = new AuthAccessPolicyArbiterFactory()) {
        this.props = props;
        this.getInstanceProps = getInstanceProps;
        this.authAccessBuilder = authAccessBuilder;
        this.authAccessPolicyArbiterFactory = authAccessPolicyArbiterFactory;
        this.name = props.name ?? 'amplifyAuth';
    }
    generateContainerEntry = ({ scope, backendSecretResolver, ssmEnvironmentEntriesGenerator, stableBackendIdentifiers, }) => {
        const authProps = {
            ...this.props,
            loginWith: translateToAuthConstructLoginWith(this.props.loginWith, backendSecretResolver),
            outputStorageStrategy: this.getInstanceProps.outputStorageStrategy,
        };
        if (authProps.loginWith.externalProviders) {
            authProps.loginWith.externalProviders.domainPrefix =
                stableBackendIdentifiers.getStableBackendHash();
        }
        let authConstruct;
        try {
            authConstruct = new AmplifyAuth(scope, this.name, authProps);
        }
        catch (error) {
            throw new AmplifyUserError('AmplifyAuthConstructInitializationError', {
                message: 'Failed to instantiate auth construct',
                resolution: 'See the underlying error message for more details.',
            }, error);
        }
        Tags.of(authConstruct).add(TagName.FRIENDLY_NAME, this.name);
        Object.entries(this.props.triggers || {}).forEach(([triggerEvent, handlerFactory]) => {
            authConstruct.resources.userPool.addTrigger(UserPoolOperation.of(triggerEvent), handlerFactory.getInstance(this.getInstanceProps).resources.lambda);
        });
        const authConstructMixin = {
            ...authConstruct,
            /**
             * Returns a resourceAccessAcceptor for the given role
             * @param roleIdentifier Either the auth or unauth role name or the name of a UserPool group
             */
            getResourceAccessAcceptor: (roleIdentifier) => ({
                identifier: `${roleIdentifier}ResourceAccessAcceptor`,
                acceptResourceAccess: (policy) => {
                    const role = roleNameIsAuthRoleName(roleIdentifier)
                        ? authConstruct.resources[roleIdentifier]
                        : authConstruct.resources.groups?.[roleIdentifier]?.role;
                    if (!role) {
                        throw new AmplifyUserError('InvalidResourceAccessConfig', {
                            message: `No auth IAM role found for "${roleIdentifier}".`,
                            resolution: `If you are trying to configure UserPool group access, ensure that the group name is specified correctly.`,
                        });
                    }
                    policy.attachToRole(role);
                },
            }),
        };
        if (!this.props.access) {
            return authConstructMixin;
        }
        // props.access is the access callback defined by the customer
        // here we inject the authAccessBuilder into the callback and run it
        // this produces the access definition that will be used to create the auth access policies
        const accessDefinition = this.props.access(this.authAccessBuilder);
        const ssmEnvironmentEntries = ssmEnvironmentEntriesGenerator.generateSsmEnvironmentEntries({
            [`${this.name}_USERPOOL_ID`]: authConstructMixin.resources.userPool.userPoolId,
        });
        const authPolicyArbiter = this.authAccessPolicyArbiterFactory.getInstance(accessDefinition, this.getInstanceProps, ssmEnvironmentEntries, new UserPoolAccessPolicyFactory(authConstruct.resources.userPool));
        authPolicyArbiter.arbitratePolicies();
        return authConstructMixin;
    };
}
const roleNameIsAuthRoleName = (roleName) => {
    return (roleName === 'authenticatedUserIamRole' ||
        roleName === 'unauthenticatedUserIamRole');
};
/**
 * Provide the settings that will be used for authentication.
 */
export const defineAuth = (props) => new AmplifyAuthFactory(props, new Error().stack);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBRTdCLE9BQU8sRUFBWSxpQkFBaUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3RFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxPQUFPLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN2RSxPQUFPLEVBQ0wsV0FBVyxHQUdaLE1BQU0sNkJBQTZCLENBQUM7QUFhckMsT0FBTyxFQUFFLGlDQUFpQyxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDOUUsT0FBTyxFQUFFLGlCQUFpQixJQUFJLGtCQUFrQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDOUUsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFNakYsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDbEYsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGFBQWEsQ0FBQztBQThCbkM7Ozs7R0FJRztBQUNILE1BQU0sT0FBTyxrQkFBa0I7SUFZVjtJQUNBO0lBWm5CLGdEQUFnRDtJQUNoRCxNQUFNLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQztJQUVmLFFBQVEsR0FBRyxlQUFlLENBQUM7SUFFNUIsU0FBUyxDQUFtQztJQUVwRDs7T0FFRztJQUNILFlBQ21CLEtBQXVCLEVBQ3ZCLGNBQWMsSUFBSSxLQUFLLEVBQUUsQ0FBQyxLQUFLO1FBRC9CLFVBQUssR0FBTCxLQUFLLENBQWtCO1FBQ3ZCLGdCQUFXLEdBQVgsV0FBVyxDQUFvQjtRQUVoRCxJQUFJLGtCQUFrQixDQUFDLFlBQVksR0FBRyxDQUFDLEVBQUU7WUFDdkMsTUFBTSxJQUFJLGdCQUFnQixDQUFDLGlDQUFpQyxFQUFFO2dCQUM1RCxPQUFPLEVBQ0wsdUVBQXVFO2dCQUN6RSxVQUFVLEVBQUUsc0NB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LElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBRW5FLE1BQU0scUJBQXFCLEdBQ3pCLDhCQUE4QixDQUFDLDZCQUE2QixDQUFDO1lBQzNELENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxjQUFjLENBQUMsRUFDMUIsa0JBQWtCLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxVQUFVO1NBQ25ELENBQUMsQ0FBQztRQUVMLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLDhCQUE4QixDQUFDLFdBQVcsQ0FDdkUsZ0JBQWdCLEVBQ2hCLElBQUksQ0FBQyxnQkFBZ0IsRUFDckIscUJBQXFCLEVBQ3JCLElBQUksMkJBQTJCLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FDbEUsQ0FBQztRQUVGLGlCQUFpQixDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFFdEMsT0FBTyxrQkFBa0IsQ0FBQztJQUM1QixDQUFDLENBQUM7Q0FDSDtBQUVELE1BQU0sc0JBQXNCLEdBQUcsQ0FBQyxRQUFnQixFQUE0QixFQUFFO0lBQzVFLE9BQU8sQ0FDTCxRQUFRLEtBQUssMEJBQTBCO1FBQ3ZDLFFBQVEsS0FBSyw0QkFBNEIsQ0FDMUMsQ0FBQztBQUNKLENBQUMsQ0FBQztBQUVGOztHQUVHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sVUFBVSxHQUFHLENBQ3hCLEtBQXVCLEVBQ1EsRUFBRSxDQUNqQyxJQUFJLGtCQUFrQixDQUFDLEtBQUssRUFBRSxJQUFJLEtBQUssRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IFBvbGljeSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0IHsgVXNlclBvb2wsIFVzZXJQb29sT3BlcmF0aW9uIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWNvZ25pdG8nO1xuaW1wb3J0IHsgQW1wbGlmeVVzZXJFcnJvciwgVGFnTmFtZSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7XG4gIEFtcGxpZnlBdXRoLFxuICBBdXRoUHJvcHMsXG4gIFRyaWdnZXJFdmVudCxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2F1dGgtY29uc3RydWN0JztcbmltcG9ydCB7XG4gIEF1dGhSZXNvdXJjZXMsXG4gIEF1dGhSb2xlTmFtZSxcbiAgQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3IsXG4gIENvbnN0cnVjdEZhY3RvcnksXG4gIENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzLFxuICBGdW5jdGlvblJlc291cmNlcyxcbiAgR2VuZXJhdGVDb250YWluZXJFbnRyeVByb3BzLFxuICBSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yLFxuICBSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yRmFjdG9yeSxcbiAgUmVzb3VyY2VQcm92aWRlcixcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQgeyB0cmFuc2xhdGVUb0F1dGhDb25zdHJ1Y3RMb2dpbldpdGggfSBmcm9tICcuL3RyYW5zbGF0ZV9hdXRoX3Byb3BzLmpzJztcbmltcG9ydCB7IGF1dGhBY2Nlc3NCdWlsZGVyIGFzIF9hdXRoQWNjZXNzQnVpbGRlciB9IGZyb20gJy4vYWNjZXNzX2J1aWxkZXIuanMnO1xuaW1wb3J0IHsgQXV0aEFjY2Vzc1BvbGljeUFyYml0ZXJGYWN0b3J5IH0gZnJvbSAnLi9hdXRoX2FjY2Vzc19wb2xpY3lfYXJiaXRlci5qcyc7XG5pbXBvcnQge1xuICBBdXRoQWNjZXNzR2VuZXJhdG9yLFxuICBBdXRoTG9naW5XaXRoRmFjdG9yeVByb3BzLFxuICBFeHBhbmQsXG59IGZyb20gJy4vdHlwZXMuanMnO1xuaW1wb3J0IHsgVXNlclBvb2xBY2Nlc3NQb2xpY3lGYWN0b3J5IH0gZnJvbSAnLi91c2VycG9vbF9hY2Nlc3NfcG9saWN5X2ZhY3RvcnkuanMnO1xuaW1wb3J0IHsgVGFncyB9IGZyb20gJ2F3cy1jZGstbGliJztcblxuZXhwb3J0IHR5cGUgQmFja2VuZEF1dGggPSBSZXNvdXJjZVByb3ZpZGVyPEF1dGhSZXNvdXJjZXM+ICZcbiAgUmVzb3VyY2VBY2Nlc3NBY2NlcHRvckZhY3Rvcnk8QXV0aFJvbGVOYW1lIHwgc3RyaW5nPjtcblxuZXhwb3J0IHR5cGUgQW1wbGlmeUF1dGhQcm9wcyA9IEV4cGFuZDxcbiAgT21pdDxBdXRoUHJvcHMsICdvdXRwdXRTdG9yYWdlU3RyYXRlZ3knIHwgJ2xvZ2luV2l0aCc+ICYge1xuICAgIC8qKlxuICAgICAqIFNwZWNpZnkgaG93IHlvdSB3b3VsZCBsaWtlIHVzZXJzIHRvIGxvZyBpbi4gWW91IGNhbiBjaG9vc2UgZnJvbSBlbWFpbCwgcGhvbmUsIGFuZCBldmVuIGV4dGVybmFsIHByb3ZpZGVycyBzdWNoIGFzIExvZ2luV2l0aEFtYXpvbi5cbiAgICAgKi9cbiAgICBsb2dpbldpdGg6IEV4cGFuZDxBdXRoTG9naW5XaXRoRmFjdG9yeVByb3BzPjtcbiAgICAvKipcbiAgICAgKiBDb25maWd1cmUgY3VzdG9tIGF1dGggdHJpZ2dlcnNcbiAgICAgKi9cbiAgICB0cmlnZ2Vycz86IFBhcnRpYWw8XG4gICAgICBSZWNvcmQ8XG4gICAgICAgIFRyaWdnZXJFdmVudCxcbiAgICAgICAgQ29uc3RydWN0RmFjdG9yeTxSZXNvdXJjZVByb3ZpZGVyPEZ1bmN0aW9uUmVzb3VyY2VzPj5cbiAgICAgID5cbiAgICA+O1xuICAgIC8qKlxuICAgICAqICFFWFBFUklNRU5UQUwhXG4gICAgICpcbiAgICAgKiBBY2Nlc3MgY29udHJvbCBpcyB1bmRlciBhY3RpdmUgZGV2ZWxvcG1lbnQgYW5kIGlzIHN1YmplY3QgdG8gY2hhbmdlIHdpdGhvdXQgbm90aWNlLlxuICAgICAqIFVzZSBhdCB5b3VyIG93biByaXNrIGFuZCBkbyBub3QgdXNlIGluIHByb2R1Y3Rpb25cbiAgICAgKi9cbiAgICBhY2Nlc3M/OiBBdXRoQWNjZXNzR2VuZXJhdG9yO1xuICB9XG4+O1xuXG4vKipcbiAqIFNpbmdsZXRvbiBmYWN0b3J5IGZvciBBbXBsaWZ5QXV0aCB0aGF0IGNhbiBiZSB1c2VkIGluIEFtcGxpZnkgcHJvamVjdCBmaWxlcy5cbiAqXG4gKiBFeHBvcnRlZCBmb3IgdGVzdGluZyBwdXJwb3NlIG9ubHkgJiBzaG91bGQgTk9UIGJlIGV4cG9ydGVkIG91dCBvZiB0aGUgcGFja2FnZS5cbiAqL1xuZXhwb3J0IGNsYXNzIEFtcGxpZnlBdXRoRmFjdG9yeSBpbXBsZW1lbnRzIENvbnN0cnVjdEZhY3Rvcnk8QmFja2VuZEF1dGg+IHtcbiAgLy8gcHVibGljbHkgYWNjZXNzaWJsZSBmb3IgdGVzdGluZyBwdXJwb3NlIG9ubHkuXG4gIHN0YXRpYyBmYWN0b3J5Q291bnQgPSAwO1xuXG4gIHJlYWRvbmx5IHByb3ZpZGVzID0gJ0F1dGhSZXNvdXJjZXMnO1xuXG4gIHByaXZhdGUgZ2VuZXJhdG9yOiBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvcjtcblxuICAvKipcbiAgICogU2V0IHRoZSBwcm9wZXJ0aWVzIHRoYXQgd2lsbCBiZSB1c2VkIHRvIGluaXRpYWxpemUgQW1wbGlmeUF1dGhcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJvcHM6IEFtcGxpZnlBdXRoUHJvcHMsXG4gICAgcHJpdmF0ZSByZWFkb25seSBpbXBvcnRTdGFjayA9IG5ldyBFcnJvcigpLnN0YWNrXG4gICkge1xuICAgIGlmIChBbXBsaWZ5QXV0aEZhY3RvcnkuZmFjdG9yeUNvdW50ID4gMCkge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ011bHRpcGxlU2luZ2xldG9uUmVzb3VyY2VzRXJyb3InLCB7XG4gICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgJ011bHRpcGxlIGBkZWZpbmVBdXRoYCBjYWxscyBhcmUgbm90IGFsbG93ZWQgd2l0aGluIGFuIEFtcGxpZnkgYmFja2VuZCcsXG4gICAgICAgIHJlc29sdXRpb246ICdSZW1vdmUgYWxsIGJ1dCBvbmUgYGRlZmluZUF1dGhgIGNhbGwnLFxuICAgICAgfSk7XG4gICAgfVxuICAgIEFtcGxpZnlBdXRoRmFjdG9yeS5mYWN0b3J5Q291bnQrKztcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYSBzaW5nbGV0b24gaW5zdGFuY2Ugb2YgQW1wbGlmeUF1dGhcbiAgICovXG4gIGdldEluc3RhbmNlID0gKFxuICAgIGdldEluc3RhbmNlUHJvcHM6IENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzXG4gICk6IEJhY2tlbmRBdXRoID0+IHtcbiAgICBjb25zdCB7IGNvbnN0cnVjdENvbnRhaW5lciwgaW1wb3J0UGF0aFZlcmlmaWVyLCByZXNvdXJjZU5hbWVWYWxpZGF0b3IgfSA9XG4gICAgICBnZXRJbnN0YW5jZVByb3BzO1xuICAgIGltcG9ydFBhdGhWZXJpZmllcj8udmVyaWZ5KFxuICAgICAgdGhpcy5pbXBvcnRTdGFjayxcbiAgICAgIHBhdGguam9pbignYW1wbGlmeScsICdhdXRoJywgJ3Jlc291cmNlJyksXG4gICAgICAnQW1wbGlmeSBBdXRoIG11c3QgYmUgZGVmaW5lZCBpbiBhbXBsaWZ5L2F1dGgvcmVzb3VyY2UudHMnXG4gICAgKTtcbiAgICBpZiAodGhpcy5wcm9wcy5uYW1lKSB7XG4gICAgICByZXNvdXJjZU5hbWVWYWxpZGF0b3I/LnZhbGlkYXRlKHRoaXMucHJvcHMubmFtZSk7XG4gICAgfVxuICAgIGlmICghdGhpcy5nZW5lcmF0b3IpIHtcbiAgICAgIHRoaXMuZ2VuZXJhdG9yID0gbmV3IEFtcGxpZnlBdXRoR2VuZXJhdG9yKHRoaXMucHJvcHMsIGdldEluc3RhbmNlUHJvcHMpO1xuICAgIH1cbiAgICByZXR1cm4gY29uc3RydWN0Q29udGFpbmVyLmdldE9yQ29tcHV0ZSh0aGlzLmdlbmVyYXRvcikgYXMgQmFja2VuZEF1dGg7XG4gIH07XG59XG5cbmNsYXNzIEFtcGxpZnlBdXRoR2VuZXJhdG9yIGltcGxlbWVudHMgQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3Ige1xuICByZWFkb25seSByZXNvdXJjZUdyb3VwTmFtZSA9ICdhdXRoJztcbiAgcHJpdmF0ZSByZWFkb25seSBuYW1lOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9wczogQW1wbGlmeUF1dGhQcm9wcyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGdldEluc3RhbmNlUHJvcHM6IENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYXV0aEFjY2Vzc0J1aWxkZXIgPSBfYXV0aEFjY2Vzc0J1aWxkZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBhdXRoQWNjZXNzUG9saWN5QXJiaXRlckZhY3RvcnkgPSBuZXcgQXV0aEFjY2Vzc1BvbGljeUFyYml0ZXJGYWN0b3J5KClcbiAgKSB7XG4gICAgdGhpcy5uYW1lID0gcHJvcHMubmFtZSA/PyAnYW1wbGlmeUF1dGgnO1xuICB9XG5cbiAgZ2VuZXJhdGVDb250YWluZXJFbnRyeSA9ICh7XG4gICAgc2NvcGUsXG4gICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgIHNzbUVudmlyb25tZW50RW50cmllc0dlbmVyYXRvcixcbiAgICBzdGFibGVCYWNrZW5kSWRlbnRpZmllcnMsXG4gIH06IEdlbmVyYXRlQ29udGFpbmVyRW50cnlQcm9wcykgPT4ge1xuICAgIGNvbnN0IGF1dGhQcm9wczogQXV0aFByb3BzID0ge1xuICAgICAgLi4udGhpcy5wcm9wcyxcbiAgICAgIGxvZ2luV2l0aDogdHJhbnNsYXRlVG9BdXRoQ29uc3RydWN0TG9naW5XaXRoKFxuICAgICAgICB0aGlzLnByb3BzLmxvZ2luV2l0aCxcbiAgICAgICAgYmFja2VuZFNlY3JldFJlc29sdmVyXG4gICAgICApLFxuICAgICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiB0aGlzLmdldEluc3RhbmNlUHJvcHMub3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICAgIH07XG4gICAgaWYgKGF1dGhQcm9wcy5sb2dpbldpdGguZXh0ZXJuYWxQcm92aWRlcnMpIHtcbiAgICAgIGF1dGhQcm9wcy5sb2dpbldpdGguZXh0ZXJuYWxQcm92aWRlcnMuZG9tYWluUHJlZml4ID1cbiAgICAgICAgc3RhYmxlQmFja2VuZElkZW50aWZpZXJzLmdldFN0YWJsZUJhY2tlbmRIYXNoKCk7XG4gICAgfVxuXG4gICAgbGV0IGF1dGhDb25zdHJ1Y3Q6IEFtcGxpZnlBdXRoO1xuICAgIHRyeSB7XG4gICAgICBhdXRoQ29uc3RydWN0ID0gbmV3IEFtcGxpZnlBdXRoKHNjb3BlLCB0aGlzLm5hbWUsIGF1dGhQcm9wcyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAnQW1wbGlmeUF1dGhDb25zdHJ1Y3RJbml0aWFsaXphdGlvbkVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gaW5zdGFudGlhdGUgYXV0aCBjb25zdHJ1Y3QnLFxuICAgICAgICAgIHJlc29sdXRpb246ICdTZWUgdGhlIHVuZGVybHlpbmcgZXJyb3IgbWVzc2FnZSBmb3IgbW9yZSBkZXRhaWxzLicsXG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yIGFzIEVycm9yXG4gICAgICApO1xuICAgIH1cblxuICAgIFRhZ3Mub2YoYXV0aENvbnN0cnVjdCkuYWRkKFRhZ05hbWUuRlJJRU5ETFlfTkFNRSwgdGhpcy5uYW1lKTtcblxuICAgIE9iamVjdC5lbnRyaWVzKHRoaXMucHJvcHMudHJpZ2dlcnMgfHwge30pLmZvckVhY2goXG4gICAgICAoW3RyaWdnZXJFdmVudCwgaGFuZGxlckZhY3RvcnldKSA9PiB7XG4gICAgICAgIChhdXRoQ29uc3RydWN0LnJlc291cmNlcy51c2VyUG9vbCBhcyBVc2VyUG9vbCkuYWRkVHJpZ2dlcihcbiAgICAgICAgICBVc2VyUG9vbE9wZXJhdGlvbi5vZih0cmlnZ2VyRXZlbnQpLFxuICAgICAgICAgIGhhbmRsZXJGYWN0b3J5LmdldEluc3RhbmNlKHRoaXMuZ2V0SW5zdGFuY2VQcm9wcykucmVzb3VyY2VzLmxhbWJkYVxuICAgICAgICApO1xuICAgICAgfVxuICAgICk7XG5cbiAgICBjb25zdCBhdXRoQ29uc3RydWN0TWl4aW46IEJhY2tlbmRBdXRoID0ge1xuICAgICAgLi4uYXV0aENvbnN0cnVjdCxcbiAgICAgIC8qKlxuICAgICAgICogUmV0dXJucyBhIHJlc291cmNlQWNjZXNzQWNjZXB0b3IgZm9yIHRoZSBnaXZlbiByb2xlXG4gICAgICAgKiBAcGFyYW0gcm9sZUlkZW50aWZpZXIgRWl0aGVyIHRoZSBhdXRoIG9yIHVuYXV0aCByb2xlIG5hbWUgb3IgdGhlIG5hbWUgb2YgYSBVc2VyUG9vbCBncm91cFxuICAgICAgICovXG4gICAgICBnZXRSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yOiAoXG4gICAgICAgIHJvbGVJZGVudGlmaWVyOiBBdXRoUm9sZU5hbWUgfCBzdHJpbmdcbiAgICAgICk6IFJlc291cmNlQWNjZXNzQWNjZXB0b3IgPT4gKHtcbiAgICAgICAgaWRlbnRpZmllcjogYCR7cm9sZUlkZW50aWZpZXJ9UmVzb3VyY2VBY2Nlc3NBY2NlcHRvcmAsXG4gICAgICAgIGFjY2VwdFJlc291cmNlQWNjZXNzOiAocG9saWN5OiBQb2xpY3kpID0+IHtcbiAgICAgICAgICBjb25zdCByb2xlID0gcm9sZU5hbWVJc0F1dGhSb2xlTmFtZShyb2xlSWRlbnRpZmllcilcbiAgICAgICAgICAgID8gYXV0aENvbnN0cnVjdC5yZXNvdXJjZXNbcm9sZUlkZW50aWZpZXJdXG4gICAgICAgICAgICA6IGF1dGhDb25zdHJ1Y3QucmVzb3VyY2VzLmdyb3Vwcz8uW3JvbGVJZGVudGlmaWVyXT8ucm9sZTtcbiAgICAgICAgICBpZiAoIXJvbGUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkUmVzb3VyY2VBY2Nlc3NDb25maWcnLCB7XG4gICAgICAgICAgICAgIG1lc3NhZ2U6IGBObyBhdXRoIElBTSByb2xlIGZvdW5kIGZvciBcIiR7cm9sZUlkZW50aWZpZXJ9XCIuYCxcbiAgICAgICAgICAgICAgcmVzb2x1dGlvbjogYElmIHlvdSBhcmUgdHJ5aW5nIHRvIGNvbmZpZ3VyZSBVc2VyUG9vbCBncm91cCBhY2Nlc3MsIGVuc3VyZSB0aGF0IHRoZSBncm91cCBuYW1lIGlzIHNwZWNpZmllZCBjb3JyZWN0bHkuYCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBwb2xpY3kuYXR0YWNoVG9Sb2xlKHJvbGUpO1xuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgfTtcbiAgICBpZiAoIXRoaXMucHJvcHMuYWNjZXNzKSB7XG4gICAgICByZXR1cm4gYXV0aENvbnN0cnVjdE1peGluO1xuICAgIH1cbiAgICAvLyBwcm9wcy5hY2Nlc3MgaXMgdGhlIGFjY2VzcyBjYWxsYmFjayBkZWZpbmVkIGJ5IHRoZSBjdXN0b21lclxuICAgIC8vIGhlcmUgd2UgaW5qZWN0IHRoZSBhdXRoQWNjZXNzQnVpbGRlciBpbnRvIHRoZSBjYWxsYmFjayBhbmQgcnVuIGl0XG4gICAgLy8gdGhpcyBwcm9kdWNlcyB0aGUgYWNjZXNzIGRlZmluaXRpb24gdGhhdCB3aWxsIGJlIHVzZWQgdG8gY3JlYXRlIHRoZSBhdXRoIGFjY2VzcyBwb2xpY2llc1xuICAgIGNvbnN0IGFjY2Vzc0RlZmluaXRpb24gPSB0aGlzLnByb3BzLmFjY2Vzcyh0aGlzLmF1dGhBY2Nlc3NCdWlsZGVyKTtcblxuICAgIGNvbnN0IHNzbUVudmlyb25tZW50RW50cmllcyA9XG4gICAgICBzc21FbnZpcm9ubWVudEVudHJpZXNHZW5lcmF0b3IuZ2VuZXJhdGVTc21FbnZpcm9ubWVudEVudHJpZXMoe1xuICAgICAgICBbYCR7dGhpcy5uYW1lfV9VU0VSUE9PTF9JRGBdOlxuICAgICAgICAgIGF1dGhDb25zdHJ1Y3RNaXhpbi5yZXNvdXJjZXMudXNlclBvb2wudXNlclBvb2xJZCxcbiAgICAgIH0pO1xuXG4gICAgY29uc3QgYXV0aFBvbGljeUFyYml0ZXIgPSB0aGlzLmF1dGhBY2Nlc3NQb2xpY3lBcmJpdGVyRmFjdG9yeS5nZXRJbnN0YW5jZShcbiAgICAgIGFjY2Vzc0RlZmluaXRpb24sXG4gICAgICB0aGlzLmdldEluc3RhbmNlUHJvcHMsXG4gICAgICBzc21FbnZpcm9ubWVudEVudHJpZXMsXG4gICAgICBuZXcgVXNlclBvb2xBY2Nlc3NQb2xpY3lGYWN0b3J5KGF1dGhDb25zdHJ1Y3QucmVzb3VyY2VzLnVzZXJQb29sKVxuICAgICk7XG5cbiAgICBhdXRoUG9saWN5QXJiaXRlci5hcmJpdHJhdGVQb2xpY2llcygpO1xuXG4gICAgcmV0dXJuIGF1dGhDb25zdHJ1Y3RNaXhpbjtcbiAgfTtcbn1cblxuY29uc3Qgcm9sZU5hbWVJc0F1dGhSb2xlTmFtZSA9IChyb2xlTmFtZTogc3RyaW5nKTogcm9sZU5hbWUgaXMgQXV0aFJvbGVOYW1lID0+IHtcbiAgcmV0dXJuIChcbiAgICByb2xlTmFtZSA9PT0gJ2F1dGhlbnRpY2F0ZWRVc2VySWFtUm9sZScgfHxcbiAgICByb2xlTmFtZSA9PT0gJ3VuYXV0aGVudGljYXRlZFVzZXJJYW1Sb2xlJ1xuICApO1xufTtcblxuLyoqXG4gKiBQcm92aWRlIHRoZSBzZXR0aW5ncyB0aGF0IHdpbGwgYmUgdXNlZCBmb3IgYXV0aGVudGljYXRpb24uXG4gKi9cbmV4cG9ydCBjb25zdCBkZWZpbmVBdXRoID0gKFxuICBwcm9wczogQW1wbGlmeUF1dGhQcm9wc1xuKTogQ29uc3RydWN0RmFjdG9yeTxCYWNrZW5kQXV0aD4gPT5cbiAgbmV3IEFtcGxpZnlBdXRoRmFjdG9yeShwcm9wcywgbmV3IEVycm9yKCkuc3RhY2spO1xuIl19