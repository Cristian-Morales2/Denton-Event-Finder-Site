import { BackendIdentifierConversions } from '@aws-amplify/platform-core';
import { BackendOutputClientErrorType, } from './backend_output_client_factory.js';
import { DeleteStackCommand, DescribeStacksCommand, ListStackResourcesCommand, ListStacksCommand, StackStatus, } from '@aws-sdk/client-cloudformation';
import { GetObjectCommand } from '@aws-sdk/client-s3';
import { authOutputKey, functionOutputKey, graphqlOutputKey, platformOutputKey, storageOutputKey, } from '@aws-amplify/backend-output-schemas';
/**
 * Deployment Client
 */
export class DefaultDeployedBackendClient {
    cfnClient;
    s3Client;
    backendOutputClient;
    deployedResourcesEnumerator;
    stackStatusMapper;
    arnParser;
    /**
     * Constructor for deployment client
     */
    constructor(cfnClient, s3Client, backendOutputClient, deployedResourcesEnumerator, stackStatusMapper, arnParser) {
        this.cfnClient = cfnClient;
        this.s3Client = s3Client;
        this.backendOutputClient = backendOutputClient;
        this.deployedResourcesEnumerator = deployedResourcesEnumerator;
        this.stackStatusMapper = stackStatusMapper;
        this.arnParser = arnParser;
    }
    /**
     * Deletes a sandbox with the specified id
     */
    deleteSandbox = async (sandboxBackendIdentifier) => {
        const stackName = BackendIdentifierConversions.toStackName({
            ...sandboxBackendIdentifier,
            type: 'sandbox',
        });
        await this.cfnClient.send(new DeleteStackCommand({ StackName: stackName }));
    };
    /**
     * Fetches all backend metadata for a specified backend
     */
    getBackendMetadata = async (backendId) => {
        const stackName = BackendIdentifierConversions.toStackName(backendId);
        return this.buildBackendMetadata(stackName);
    };
    listBackends = (listBackendsRequest) => {
        const backends = this.listBackendsInternal(listBackendsRequest);
        return {
            getBackendSummaryByPage: () => backends,
        };
    };
    /**
     * Returns a list of stacks for specific deployment type and status
     * @yields
     */
    async *listBackendsInternal(listBackendsRequest) {
        const stackMetadata = [];
        let nextToken;
        const deploymentType = listBackendsRequest?.deploymentType;
        const statusFilter = listBackendsRequest?.backendStatusFilters
            ? listBackendsRequest?.backendStatusFilters
            : [];
        do {
            const listStacksResponse = await this.listStacks(nextToken, statusFilter);
            const stackMetadataPromises = listStacksResponse.stackSummaries
                .filter((stackSummary) => {
                return (this.getBackendStackType(stackSummary.StackName) === deploymentType);
            })
                .map(async (stackSummary) => {
                const deploymentType = await this.tryGetDeploymentType(stackSummary);
                return {
                    name: stackSummary.StackName,
                    backendId: BackendIdentifierConversions.fromStackName(stackSummary.StackName),
                    lastUpdated: stackSummary.LastUpdatedTime ?? stackSummary.CreationTime,
                    status: this.stackStatusMapper.translateStackStatus(stackSummary.StackStatus),
                    deploymentType,
                };
            });
            const stackMetadataResolvedPromises = await Promise.all(stackMetadataPromises);
            const filteredMetadata = stackMetadataResolvedPromises.filter((stackMetadata) => stackMetadata.deploymentType === deploymentType);
            stackMetadata.push(...filteredMetadata);
            nextToken = listStacksResponse.nextToken;
            if (stackMetadata.length !== 0) {
                yield stackMetadata;
            }
        } while (stackMetadata.length === 0 && nextToken);
    }
    getBackendStackType = (stackName) => {
        const backendIdentifier = BackendIdentifierConversions.fromStackName(stackName);
        return backendIdentifier?.type;
    };
    tryGetDeploymentType = async (stackSummary) => {
        const backendIdentifier = {
            stackName: stackSummary.StackName,
        };
        try {
            const backendOutput = await this.backendOutputClient.getOutput(backendIdentifier);
            return backendOutput[platformOutputKey].payload
                .deploymentType;
        }
        catch (error) {
            if (error.code ===
                BackendOutputClientErrorType.METADATA_RETRIEVAL_ERROR) {
                // Ignore stacks where metadata cannot be retrieved. These are not Amplify stacks, or not compatible with this library.
                return;
            }
            throw error;
        }
    };
    listStacks = async (nextToken, stackStatusFilter) => {
        const stacks = await this.cfnClient.send(new ListStacksCommand({
            NextToken: nextToken,
            StackStatusFilter: stackStatusFilter.length > 0
                ? stackStatusFilter
                : Object.values(StackStatus).filter((status) => status !== StackStatus.DELETE_COMPLETE),
        }));
        nextToken = stacks.NextToken;
        return { stackSummaries: stacks.StackSummaries ?? [], nextToken };
    };
    buildBackendMetadata = async (stackName) => {
        const stackBackendIdentifier = {
            stackName,
        };
        const backendOutput = await this.backendOutputClient.getOutput(stackBackendIdentifier);
        const stackDescription = await this.cfnClient.send(new DescribeStacksCommand({ StackName: stackName }));
        const stack = stackDescription?.Stacks?.[0];
        const status = this.stackStatusMapper.translateStackStatus(stack?.StackStatus);
        const lastUpdated = stack?.LastUpdatedTime ?? stack?.CreationTime;
        const stackResources = await this.cfnClient.send(new ListStackResourcesCommand({
            StackName: stackName,
        }));
        const childStackPromises = stackResources.StackResourceSummaries?.filter((stackResourceSummary) => {
            return (stackResourceSummary.ResourceType === 'AWS::CloudFormation::Stack');
        }).map(async (stackResourceSummary) => {
            // arn:aws:{service}:{region}:{account}:stack/{stackName}/{additionalFields}
            const arnParts = stackResourceSummary.PhysicalResourceId?.split('/');
            const childStackName = arnParts?.[1];
            if (!childStackName) {
                return;
            }
            const stackDescription = await this.cfnClient.send(new DescribeStacksCommand({ StackName: childStackName }));
            const stack = stackDescription?.Stacks?.[0];
            return stack;
        }) ?? [];
        const childStacks = await Promise.all(childStackPromises);
        const authStack = childStacks.find((nestedStack) => nestedStack?.StackName?.includes('auth'));
        const storageStack = childStacks.find((nestedStack) => nestedStack?.StackName?.includes('storage'));
        const apiStack = childStacks.find((nestedStack) => nestedStack?.StackName?.includes('data'));
        const functionStack = childStacks.find((nestedStack) => nestedStack?.StackName?.includes('function'));
        // stack?.StackId is the ARN of the stack
        const { accountId, region } = this.arnParser.tryParseArn(stack?.StackId);
        const resources = await this.deployedResourcesEnumerator.listDeployedResources(this.cfnClient, stackName, accountId, region);
        const backendMetadataObject = {
            deploymentType: backendOutput[platformOutputKey].payload
                .deploymentType,
            lastUpdated,
            status,
            name: stackName,
            resources,
        };
        if (authStack) {
            backendMetadataObject.authConfiguration = {
                status: this.stackStatusMapper.translateStackStatus(authStack.StackStatus),
                lastUpdated: authStack.LastUpdatedTime ?? authStack.CreationTime,
                userPoolId: backendOutput[authOutputKey]?.payload.userPoolId,
            };
        }
        if (storageStack) {
            backendMetadataObject.storageConfiguration = {
                status: this.stackStatusMapper.translateStackStatus(storageStack.StackStatus),
                lastUpdated: storageStack.LastUpdatedTime ?? storageStack.CreationTime,
                s3BucketName: backendOutput[storageOutputKey]?.payload
                    .bucketName,
            };
        }
        if (apiStack) {
            const additionalAuthTypesString = backendOutput[graphqlOutputKey]?.payload
                .awsAppsyncAdditionalAuthenticationTypes;
            const additionalAuthTypes = additionalAuthTypesString
                ? additionalAuthTypesString.split(',')
                : [];
            backendMetadataObject.apiConfiguration = {
                status: this.stackStatusMapper.translateStackStatus(apiStack.StackStatus),
                lastUpdated: apiStack.LastUpdatedTime ?? apiStack.CreationTime,
                graphqlEndpoint: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncApiEndpoint,
                defaultAuthType: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncAuthenticationType,
                additionalAuthTypes,
                conflictResolutionMode: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncConflictResolutionMode,
                apiId: backendOutput[graphqlOutputKey]?.payload
                    .awsAppsyncApiId,
                modelSchemaS3Uri: backendOutput[graphqlOutputKey]?.payload
                    .amplifyApiModelSchemaS3Uri,
            };
        }
        if (functionStack) {
            const functionResources = resources.filter((resource) => resource.resourceType === 'AWS::Lambda::Function');
            const functionConfigurations = [];
            const definedFunctionsString = backendOutput[functionOutputKey]?.payload.definedFunctions;
            const customerFunctionNames = definedFunctionsString
                ? JSON.parse(definedFunctionsString)
                : [];
            customerFunctionNames.forEach((functionName) => {
                const resource = functionResources.find((func) => func.physicalResourceId === functionName);
                if (resource) {
                    functionConfigurations.push({
                        status: this.stackStatusMapper.translateStackStatus(resource.resourceStatus),
                        lastUpdated: resource.lastUpdated ??
                            functionStack.LastUpdatedTime ??
                            functionStack.CreationTime,
                        functionName,
                    });
                }
            });
            backendMetadataObject.functionConfigurations = functionConfigurations;
        }
        return backendMetadataObject;
    };
    fetchSchema = async (schemaS3Uri) => {
        if (!schemaS3Uri) {
            throw new Error('schemaS3Uri output is not available');
        }
        // s3://{bucketName}/{fileName}
        const uriParts = schemaS3Uri.split('/');
        const bucketName = uriParts[2];
        const objectPath = uriParts.slice(3, uriParts.length).join('/');
        if (!bucketName || !objectPath) {
            throw new Error('schemaS3Uri is not valid');
        }
        const s3Response = await this.s3Client.send(new GetObjectCommand({ Bucket: bucketName, Key: objectPath }));
        if (!s3Response.Body) {
            throw new Error(`s3Response from ${schemaS3Uri} does not contain a Body`);
        }
        return await s3Response.Body?.transformToString();
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVwbG95ZWRfYmFja2VuZF9jbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZGVwbG95ZWRfYmFja2VuZF9jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBZ0JBLE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzFFLE9BQU8sRUFHTCw0QkFBNEIsR0FDN0IsTUFBTSxvQ0FBb0MsQ0FBQztBQUM1QyxPQUFPLEVBRUwsa0JBQWtCLEVBQ2xCLHFCQUFxQixFQUNyQix5QkFBeUIsRUFDekIsaUJBQWlCLEVBSWpCLFdBQVcsR0FFWixNQUFNLGdDQUFnQyxDQUFDO0FBRXhDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBWSxNQUFNLG9CQUFvQixDQUFDO0FBQ2hFLE9BQU8sRUFDTCxhQUFhLEVBQ2IsaUJBQWlCLEVBQ2pCLGdCQUFnQixFQUNoQixpQkFBaUIsRUFDakIsZ0JBQWdCLEdBQ2pCLE1BQU0scUNBQXFDLENBQUM7QUFLN0M7O0dBRUc7QUFDSCxNQUFNLE9BQU8sNEJBQTRCO0lBS3BCO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQVRuQjs7T0FFRztJQUNILFlBQ21CLFNBQStCLEVBQy9CLFFBQWtCLEVBQ2xCLG1CQUF3QyxFQUN4QywyQkFBd0QsRUFDeEQsaUJBQW9DLEVBQ3BDLFNBQW9CO1FBTHBCLGNBQVMsR0FBVCxTQUFTLENBQXNCO1FBQy9CLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQUN4QyxnQ0FBMkIsR0FBM0IsMkJBQTJCLENBQTZCO1FBQ3hELHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFDcEMsY0FBUyxHQUFULFNBQVMsQ0FBVztJQUNwQyxDQUFDO0lBRUo7O09BRUc7SUFDSCxhQUFhLEdBQUcsS0FBSyxFQUNuQix3QkFBeUQsRUFDMUMsRUFBRTtRQUNqQixNQUFNLFNBQVMsR0FBRyw0QkFBNEIsQ0FBQyxXQUFXLENB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LE1BQU0sVUFBVSxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFaEUsSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUM5QixNQUFNLElBQUksS0FBSyxDQUFDLDBCQUEwQixDQUFDLENBQUM7U0FDN0M7UUFFRCxNQUFNLFVBQVUsR0FBRyxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUN6QyxJQUFJLGdCQUFnQixDQUFDLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFLENBQUMsQ0FDOUQsQ0FBQztRQUVGLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFO1lBQ3BCLE1BQU0sSUFBSSxLQUFLLENBQUMsbUJBQW1CLFdBQVcsMEJBQTBCLENBQUMsQ0FBQztTQUMzRTtRQUVELE9BQU8sTUFBTSxVQUFVLENBQUMsSUFBSSxFQUFFLGlCQUFpQixFQUFFLENBQUM7SUFDcEQsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBCYWNrZW5kSWRlbnRpZmllcixcbiAgQmFja2VuZE91dHB1dCxcbiAgRGVwbG95bWVudFR5cGUsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHtcbiAgQXBpQXV0aFR5cGUsXG4gIEJhY2tlbmRNZXRhZGF0YSxcbiAgQmFja2VuZFN0YXR1cyxcbiAgQmFja2VuZFN1bW1hcnlNZXRhZGF0YSxcbiAgQ29uZmxpY3RSZXNvbHV0aW9uTW9kZSxcbiAgRGVwbG95ZWRCYWNrZW5kQ2xpZW50LFxuICBGdW5jdGlvbkNvbmZpZ3VyYXRpb24sXG4gIExpc3RCYWNrZW5kc1JlcXVlc3QsXG4gIExpc3RCYWNrZW5kc1Jlc3BvbnNlLFxufSBmcm9tICcuL2RlcGxveWVkX2JhY2tlbmRfY2xpZW50X2ZhY3RvcnkuanMnO1xuaW1wb3J0IHsgQmFja2VuZElkZW50aWZpZXJDb252ZXJzaW9ucyB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7XG4gIEJhY2tlbmRPdXRwdXRDbGllbnQsXG4gIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvcixcbiAgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZSxcbn0gZnJvbSAnLi9iYWNrZW5kX291dHB1dF9jbGllbnRfZmFjdG9yeS5qcyc7XG5pbXBvcnQge1xuICBDbG91ZEZvcm1hdGlvbkNsaWVudCxcbiAgRGVsZXRlU3RhY2tDb21tYW5kLFxuICBEZXNjcmliZVN0YWNrc0NvbW1hbmQsXG4gIExpc3RTdGFja1Jlc291cmNlc0NvbW1hbmQsXG4gIExpc3RTdGFja3NDb21tYW5kLFxuICBMaXN0U3RhY2tzQ29tbWFuZE91dHB1dCxcbiAgU3RhY2ssXG4gIFN0YWNrUmVzb3VyY2VTdW1tYXJ5LFxuICBTdGFja1N0YXR1cyxcbiAgU3RhY2tTdW1tYXJ5LFxufSBmcm9tICdAYXdzLXNkay9jbGllbnQtY2xvdWRmb3JtYXRpb24nO1xuXG5pbXBvcnQgeyBHZXRPYmplY3RDb21tYW5kLCBTM0NsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XG5pbXBvcnQge1xuICBhdXRoT3V0cHV0S2V5LFxuICBmdW5jdGlvbk91dHB1dEtleSxcbiAgZ3JhcGhxbE91dHB1dEtleSxcbiAgcGxhdGZvcm1PdXRwdXRLZXksXG4gIHN0b3JhZ2VPdXRwdXRLZXksXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zY2hlbWFzJztcbmltcG9ydCB7IERlcGxveWVkUmVzb3VyY2VzRW51bWVyYXRvciB9IGZyb20gJy4vZGVwbG95ZWQtYmFja2VuZC1jbGllbnQvZGVwbG95ZWRfcmVzb3VyY2VzX2VudW1lcmF0b3IuanMnO1xuaW1wb3J0IHsgU3RhY2tTdGF0dXNNYXBwZXIgfSBmcm9tICcuL2RlcGxveWVkLWJhY2tlbmQtY2xpZW50L3N0YWNrX3N0YXR1c19tYXBwZXIuanMnO1xuaW1wb3J0IHsgQXJuUGFyc2VyIH0gZnJvbSAnLi9kZXBsb3llZC1iYWNrZW5kLWNsaWVudC9hcm5fcGFyc2VyLmpzJztcblxuLyoqXG4gKiBEZXBsb3ltZW50IENsaWVudFxuICovXG5leHBvcnQgY2xhc3MgRGVmYXVsdERlcGxveWVkQmFja2VuZENsaWVudCBpbXBsZW1lbnRzIERlcGxveWVkQmFja2VuZENsaWVudCB7XG4gIC8qKlxuICAgKiBDb25zdHJ1Y3RvciBmb3IgZGVwbG95bWVudCBjbGllbnRcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY2ZuQ2xpZW50OiBDbG91ZEZvcm1hdGlvbkNsaWVudCxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHMzQ2xpZW50OiBTM0NsaWVudCxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGJhY2tlbmRPdXRwdXRDbGllbnQ6IEJhY2tlbmRPdXRwdXRDbGllbnQsXG4gICAgcHJpdmF0ZSByZWFkb25seSBkZXBsb3llZFJlc291cmNlc0VudW1lcmF0b3I6IERlcGxveWVkUmVzb3VyY2VzRW51bWVyYXRvcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN0YWNrU3RhdHVzTWFwcGVyOiBTdGFja1N0YXR1c01hcHBlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGFyblBhcnNlcjogQXJuUGFyc2VyXG4gICkge31cblxuICAvKipcbiAgICogRGVsZXRlcyBhIHNhbmRib3ggd2l0aCB0aGUgc3BlY2lmaWVkIGlkXG4gICAqL1xuICBkZWxldGVTYW5kYm94ID0gYXN5bmMgKFxuICAgIHNhbmRib3hCYWNrZW5kSWRlbnRpZmllcjogT21pdDxCYWNrZW5kSWRlbnRpZmllciwgJ3R5cGUnPlxuICApOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBjb25zdCBzdGFja05hbWUgPSBCYWNrZW5kSWRlbnRpZmllckNvbnZlcnNpb25zLnRvU3RhY2tOYW1lKHtcbiAgICAgIC4uLnNhbmRib3hCYWNrZW5kSWRlbnRpZmllcixcbiAgICAgIHR5cGU6ICdzYW5kYm94JyxcbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLmNmbkNsaWVudC5zZW5kKG5ldyBEZWxldGVTdGFja0NvbW1hbmQoeyBTdGFja05hbWU6IHN0YWNrTmFtZSB9KSk7XG4gIH07XG4gIC8qKlxuICAgKiBGZXRjaGVzIGFsbCBiYWNrZW5kIG1ldGFkYXRhIGZvciBhIHNwZWNpZmllZCBiYWNrZW5kXG4gICAqL1xuICBnZXRCYWNrZW5kTWV0YWRhdGEgPSBhc3luYyAoXG4gICAgYmFja2VuZElkOiBCYWNrZW5kSWRlbnRpZmllclxuICApOiBQcm9taXNlPEJhY2tlbmRNZXRhZGF0YT4gPT4ge1xuICAgIGNvbnN0IHN0YWNrTmFtZSA9IEJhY2tlbmRJZGVudGlmaWVyQ29udmVyc2lvbnMudG9TdGFja05hbWUoYmFja2VuZElkKTtcbiAgICByZXR1cm4gdGhpcy5idWlsZEJhY2tlbmRNZXRhZGF0YShzdGFja05hbWUpO1xuICB9O1xuXG4gIGxpc3RCYWNrZW5kcyA9IChcbiAgICBsaXN0QmFja2VuZHNSZXF1ZXN0PzogTGlzdEJhY2tlbmRzUmVxdWVzdFxuICApOiBMaXN0QmFja2VuZHNSZXNwb25zZSA9PiB7XG4gICAgY29uc3QgYmFja2VuZHMgPSB0aGlzLmxpc3RCYWNrZW5kc0ludGVybmFsKGxpc3RCYWNrZW5kc1JlcXVlc3QpO1xuICAgIHJldHVybiB7XG4gICAgICBnZXRCYWNrZW5kU3VtbWFyeUJ5UGFnZTogKCkgPT4gYmFja2VuZHMsXG4gICAgfTtcbiAgfTtcblxuICAvKipcbiAgICogUmV0dXJucyBhIGxpc3Qgb2Ygc3RhY2tzIGZvciBzcGVjaWZpYyBkZXBsb3ltZW50IHR5cGUgYW5kIHN0YXR1c1xuICAgKiBAeWllbGRzXG4gICAqL1xuICBwcml2YXRlIGFzeW5jICpsaXN0QmFja2VuZHNJbnRlcm5hbChcbiAgICBsaXN0QmFja2VuZHNSZXF1ZXN0PzogTGlzdEJhY2tlbmRzUmVxdWVzdFxuICApIHtcbiAgICBjb25zdCBzdGFja01ldGFkYXRhOiBCYWNrZW5kU3VtbWFyeU1ldGFkYXRhW10gPSBbXTtcbiAgICBsZXQgbmV4dFRva2VuO1xuICAgIGNvbnN0IGRlcGxveW1lbnRUeXBlID0gbGlzdEJhY2tlbmRzUmVxdWVzdD8uZGVwbG95bWVudFR5cGU7XG4gICAgY29uc3Qgc3RhdHVzRmlsdGVyID0gbGlzdEJhY2tlbmRzUmVxdWVzdD8uYmFja2VuZFN0YXR1c0ZpbHRlcnNcbiAgICAgID8gbGlzdEJhY2tlbmRzUmVxdWVzdD8uYmFja2VuZFN0YXR1c0ZpbHRlcnNcbiAgICAgIDogW107XG4gICAgZG8ge1xuICAgICAgY29uc3QgbGlzdFN0YWNrc1Jlc3BvbnNlID0gYXdhaXQgdGhpcy5saXN0U3RhY2tzKG5leHRUb2tlbiwgc3RhdHVzRmlsdGVyKTtcblxuICAgICAgY29uc3Qgc3RhY2tNZXRhZGF0YVByb21pc2VzID0gbGlzdFN0YWNrc1Jlc3BvbnNlLnN0YWNrU3VtbWFyaWVzXG4gICAgICAgIC5maWx0ZXIoKHN0YWNrU3VtbWFyeTogU3RhY2tTdW1tYXJ5KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIHRoaXMuZ2V0QmFja2VuZFN0YWNrVHlwZShzdGFja1N1bW1hcnkuU3RhY2tOYW1lKSA9PT0gZGVwbG95bWVudFR5cGVcbiAgICAgICAgICApO1xuICAgICAgICB9KVxuICAgICAgICAubWFwKGFzeW5jIChzdGFja1N1bW1hcnk6IFN0YWNrU3VtbWFyeSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGRlcGxveW1lbnRUeXBlID0gYXdhaXQgdGhpcy50cnlHZXREZXBsb3ltZW50VHlwZShzdGFja1N1bW1hcnkpO1xuXG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG5hbWU6IHN0YWNrU3VtbWFyeS5TdGFja05hbWUgYXMgc3RyaW5nLFxuICAgICAgICAgICAgYmFja2VuZElkOiBCYWNrZW5kSWRlbnRpZmllckNvbnZlcnNpb25zLmZyb21TdGFja05hbWUoXG4gICAgICAgICAgICAgIHN0YWNrU3VtbWFyeS5TdGFja05hbWVcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICBsYXN0VXBkYXRlZDpcbiAgICAgICAgICAgICAgc3RhY2tTdW1tYXJ5Lkxhc3RVcGRhdGVkVGltZSA/PyBzdGFja1N1bW1hcnkuQ3JlYXRpb25UaW1lLFxuICAgICAgICAgICAgc3RhdHVzOiB0aGlzLnN0YWNrU3RhdHVzTWFwcGVyLnRyYW5zbGF0ZVN0YWNrU3RhdHVzKFxuICAgICAgICAgICAgICBzdGFja1N1bW1hcnkuU3RhY2tTdGF0dXNcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICBkZXBsb3ltZW50VHlwZSxcbiAgICAgICAgICB9O1xuICAgICAgICB9KTtcblxuICAgICAgY29uc3Qgc3RhY2tNZXRhZGF0YVJlc29sdmVkUHJvbWlzZXMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgc3RhY2tNZXRhZGF0YVByb21pc2VzXG4gICAgICApO1xuICAgICAgY29uc3QgZmlsdGVyZWRNZXRhZGF0YSA9IHN0YWNrTWV0YWRhdGFSZXNvbHZlZFByb21pc2VzLmZpbHRlcihcbiAgICAgICAgKHN0YWNrTWV0YWRhdGEpID0+IHN0YWNrTWV0YWRhdGEuZGVwbG95bWVudFR5cGUgPT09IGRlcGxveW1lbnRUeXBlXG4gICAgICApO1xuXG4gICAgICBzdGFja01ldGFkYXRhLnB1c2goLi4uZmlsdGVyZWRNZXRhZGF0YSk7XG4gICAgICBuZXh0VG9rZW4gPSBsaXN0U3RhY2tzUmVzcG9uc2UubmV4dFRva2VuO1xuXG4gICAgICBpZiAoc3RhY2tNZXRhZGF0YS5sZW5ndGggIT09IDApIHtcbiAgICAgICAgeWllbGQgc3RhY2tNZXRhZGF0YTtcbiAgICAgIH1cbiAgICB9IHdoaWxlIChzdGFja01ldGFkYXRhLmxlbmd0aCA9PT0gMCAmJiBuZXh0VG9rZW4pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRCYWNrZW5kU3RhY2tUeXBlID0gKFxuICAgIHN0YWNrTmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkXG4gICk6IHN0cmluZyB8IHVuZGVmaW5lZCA9PiB7XG4gICAgY29uc3QgYmFja2VuZElkZW50aWZpZXIgPVxuICAgICAgQmFja2VuZElkZW50aWZpZXJDb252ZXJzaW9ucy5mcm9tU3RhY2tOYW1lKHN0YWNrTmFtZSk7XG4gICAgcmV0dXJuIGJhY2tlbmRJZGVudGlmaWVyPy50eXBlO1xuICB9O1xuXG4gIHByaXZhdGUgdHJ5R2V0RGVwbG95bWVudFR5cGUgPSBhc3luYyAoXG4gICAgc3RhY2tTdW1tYXJ5OiBTdGFja1N1bW1hcnlcbiAgKTogUHJvbWlzZTxEZXBsb3ltZW50VHlwZSB8IHVuZGVmaW5lZD4gPT4ge1xuICAgIGNvbnN0IGJhY2tlbmRJZGVudGlmaWVyID0ge1xuICAgICAgc3RhY2tOYW1lOiBzdGFja1N1bW1hcnkuU3RhY2tOYW1lIGFzIHN0cmluZyxcbiAgICB9O1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGJhY2tlbmRPdXRwdXQ6IEJhY2tlbmRPdXRwdXQgPVxuICAgICAgICBhd2FpdCB0aGlzLmJhY2tlbmRPdXRwdXRDbGllbnQuZ2V0T3V0cHV0KGJhY2tlbmRJZGVudGlmaWVyKTtcblxuICAgICAgcmV0dXJuIGJhY2tlbmRPdXRwdXRbcGxhdGZvcm1PdXRwdXRLZXldLnBheWxvYWRcbiAgICAgICAgLmRlcGxveW1lbnRUeXBlIGFzIERlcGxveW1lbnRUeXBlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoXG4gICAgICAgIChlcnJvciBhcyBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IpLmNvZGUgPT09XG4gICAgICAgIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUuTUVUQURBVEFfUkVUUklFVkFMX0VSUk9SXG4gICAgICApIHtcbiAgICAgICAgLy8gSWdub3JlIHN0YWNrcyB3aGVyZSBtZXRhZGF0YSBjYW5ub3QgYmUgcmV0cmlldmVkLiBUaGVzZSBhcmUgbm90IEFtcGxpZnkgc3RhY2tzLCBvciBub3QgY29tcGF0aWJsZSB3aXRoIHRoaXMgbGlicmFyeS5cbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgbGlzdFN0YWNrcyA9IGFzeW5jIChcbiAgICBuZXh0VG9rZW46IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgICBzdGFja1N0YXR1c0ZpbHRlcjogQmFja2VuZFN0YXR1c1tdXG4gICk6IFByb21pc2U8e1xuICAgIHN0YWNrU3VtbWFyaWVzOiBTdGFja1N1bW1hcnlbXTtcbiAgICBuZXh0VG9rZW46IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgfT4gPT4ge1xuICAgIGNvbnN0IHN0YWNrczogTGlzdFN0YWNrc0NvbW1hbmRPdXRwdXQgPSBhd2FpdCB0aGlzLmNmbkNsaWVudC5zZW5kKFxuICAgICAgbmV3IExpc3RTdGFja3NDb21tYW5kKHtcbiAgICAgICAgTmV4dFRva2VuOiBuZXh0VG9rZW4sXG4gICAgICAgIFN0YWNrU3RhdHVzRmlsdGVyOlxuICAgICAgICAgIHN0YWNrU3RhdHVzRmlsdGVyLmxlbmd0aCA+IDBcbiAgICAgICAgICAgID8gc3RhY2tTdGF0dXNGaWx0ZXJcbiAgICAgICAgICAgIDogT2JqZWN0LnZhbHVlcyhTdGFja1N0YXR1cykuZmlsdGVyKFxuICAgICAgICAgICAgICAgIChzdGF0dXMpID0+IHN0YXR1cyAhPT0gU3RhY2tTdGF0dXMuREVMRVRFX0NPTVBMRVRFXG4gICAgICAgICAgICAgICksXG4gICAgICB9KVxuICAgICk7XG4gICAgbmV4dFRva2VuID0gc3RhY2tzLk5leHRUb2tlbjtcbiAgICByZXR1cm4geyBzdGFja1N1bW1hcmllczogc3RhY2tzLlN0YWNrU3VtbWFyaWVzID8/IFtdLCBuZXh0VG9rZW4gfTtcbiAgfTtcblxuICBwcml2YXRlIGJ1aWxkQmFja2VuZE1ldGFkYXRhID0gYXN5bmMgKFxuICAgIHN0YWNrTmFtZTogc3RyaW5nXG4gICk6IFByb21pc2U8QmFja2VuZE1ldGFkYXRhPiA9PiB7XG4gICAgY29uc3Qgc3RhY2tCYWNrZW5kSWRlbnRpZmllciA9IHtcbiAgICAgIHN0YWNrTmFtZSxcbiAgICB9O1xuXG4gICAgY29uc3QgYmFja2VuZE91dHB1dDogQmFja2VuZE91dHB1dCA9XG4gICAgICBhd2FpdCB0aGlzLmJhY2tlbmRPdXRwdXRDbGllbnQuZ2V0T3V0cHV0KHN0YWNrQmFja2VuZElkZW50aWZpZXIpO1xuICAgIGNvbnN0IHN0YWNrRGVzY3JpcHRpb24gPSBhd2FpdCB0aGlzLmNmbkNsaWVudC5zZW5kKFxuICAgICAgbmV3IERlc2NyaWJlU3RhY2tzQ29tbWFuZCh7IFN0YWNrTmFtZTogc3RhY2tOYW1lIH0pXG4gICAgKTtcbiAgICBjb25zdCBzdGFjayA9IHN0YWNrRGVzY3JpcHRpb24/LlN0YWNrcz8uWzBdO1xuICAgIGNvbnN0IHN0YXR1cyA9IHRoaXMuc3RhY2tTdGF0dXNNYXBwZXIudHJhbnNsYXRlU3RhY2tTdGF0dXMoXG4gICAgICBzdGFjaz8uU3RhY2tTdGF0dXNcbiAgICApO1xuICAgIGNvbnN0IGxhc3RVcGRhdGVkID0gc3RhY2s/Lkxhc3RVcGRhdGVkVGltZSA/PyBzdGFjaz8uQ3JlYXRpb25UaW1lO1xuXG4gICAgY29uc3Qgc3RhY2tSZXNvdXJjZXMgPSBhd2FpdCB0aGlzLmNmbkNsaWVudC5zZW5kKFxuICAgICAgbmV3IExpc3RTdGFja1Jlc291cmNlc0NvbW1hbmQoe1xuICAgICAgICBTdGFja05hbWU6IHN0YWNrTmFtZSxcbiAgICAgIH0pXG4gICAgKTtcbiAgICBjb25zdCBjaGlsZFN0YWNrUHJvbWlzZXM6IFByb21pc2U8U3RhY2sgfCB1bmRlZmluZWQ+W10gPVxuICAgICAgc3RhY2tSZXNvdXJjZXMuU3RhY2tSZXNvdXJjZVN1bW1hcmllcz8uZmlsdGVyKFxuICAgICAgICAoc3RhY2tSZXNvdXJjZVN1bW1hcnk6IFN0YWNrUmVzb3VyY2VTdW1tYXJ5KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIHN0YWNrUmVzb3VyY2VTdW1tYXJ5LlJlc291cmNlVHlwZSA9PT0gJ0FXUzo6Q2xvdWRGb3JtYXRpb246OlN0YWNrJ1xuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICkubWFwKGFzeW5jIChzdGFja1Jlc291cmNlU3VtbWFyeTogU3RhY2tSZXNvdXJjZVN1bW1hcnkpID0+IHtcbiAgICAgICAgLy8gYXJuOmF3czp7c2VydmljZX06e3JlZ2lvbn06e2FjY291bnR9OnN0YWNrL3tzdGFja05hbWV9L3thZGRpdGlvbmFsRmllbGRzfVxuICAgICAgICBjb25zdCBhcm5QYXJ0cyA9IHN0YWNrUmVzb3VyY2VTdW1tYXJ5LlBoeXNpY2FsUmVzb3VyY2VJZD8uc3BsaXQoJy8nKTtcbiAgICAgICAgY29uc3QgY2hpbGRTdGFja05hbWUgPSBhcm5QYXJ0cz8uWzFdO1xuICAgICAgICBpZiAoIWNoaWxkU3RhY2tOYW1lKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHN0YWNrRGVzY3JpcHRpb24gPSBhd2FpdCB0aGlzLmNmbkNsaWVudC5zZW5kKFxuICAgICAgICAgIG5ldyBEZXNjcmliZVN0YWNrc0NvbW1hbmQoeyBTdGFja05hbWU6IGNoaWxkU3RhY2tOYW1lIH0pXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3Qgc3RhY2sgPSBzdGFja0Rlc2NyaXB0aW9uPy5TdGFja3M/LlswXTtcbiAgICAgICAgcmV0dXJuIHN0YWNrO1xuICAgICAgfSkgPz8gW107XG5cbiAgICBjb25zdCBjaGlsZFN0YWNrcyA9IGF3YWl0IFByb21pc2UuYWxsKGNoaWxkU3RhY2tQcm9taXNlcyk7XG4gICAgY29uc3QgYXV0aFN0YWNrID0gY2hpbGRTdGFja3MuZmluZChcbiAgICAgIChuZXN0ZWRTdGFjazogU3RhY2tTdW1tYXJ5IHwgdW5kZWZpbmVkKSA9PlxuICAgICAgICBuZXN0ZWRTdGFjaz8uU3RhY2tOYW1lPy5pbmNsdWRlcygnYXV0aCcpXG4gICAgKTtcbiAgICBjb25zdCBzdG9yYWdlU3RhY2sgPSBjaGlsZFN0YWNrcy5maW5kKFxuICAgICAgKG5lc3RlZFN0YWNrOiBTdGFja1N1bW1hcnkgfCB1bmRlZmluZWQpID0+XG4gICAgICAgIG5lc3RlZFN0YWNrPy5TdGFja05hbWU/LmluY2x1ZGVzKCdzdG9yYWdlJylcbiAgICApO1xuICAgIGNvbnN0IGFwaVN0YWNrID0gY2hpbGRTdGFja3MuZmluZCgobmVzdGVkU3RhY2s6IFN0YWNrU3VtbWFyeSB8IHVuZGVmaW5lZCkgPT5cbiAgICAgIG5lc3RlZFN0YWNrPy5TdGFja05hbWU/LmluY2x1ZGVzKCdkYXRhJylcbiAgICApO1xuICAgIGNvbnN0IGZ1bmN0aW9uU3RhY2sgPSBjaGlsZFN0YWNrcy5maW5kKFxuICAgICAgKG5lc3RlZFN0YWNrOiBTdGFja1N1bW1hcnkgfCB1bmRlZmluZWQpID0+XG4gICAgICAgIG5lc3RlZFN0YWNrPy5TdGFja05hbWU/LmluY2x1ZGVzKCdmdW5jdGlvbicpXG4gICAgKTtcblxuICAgIC8vIHN0YWNrPy5TdGFja0lkIGlzIHRoZSBBUk4gb2YgdGhlIHN0YWNrXG4gICAgY29uc3QgeyBhY2NvdW50SWQsIHJlZ2lvbiB9ID0gdGhpcy5hcm5QYXJzZXIudHJ5UGFyc2VBcm4oXG4gICAgICBzdGFjaz8uU3RhY2tJZCBhcyBzdHJpbmdcbiAgICApO1xuICAgIGNvbnN0IHJlc291cmNlcyA9XG4gICAgICBhd2FpdCB0aGlzLmRlcGxveWVkUmVzb3VyY2VzRW51bWVyYXRvci5saXN0RGVwbG95ZWRSZXNvdXJjZXMoXG4gICAgICAgIHRoaXMuY2ZuQ2xpZW50LFxuICAgICAgICBzdGFja05hbWUsXG4gICAgICAgIGFjY291bnRJZCxcbiAgICAgICAgcmVnaW9uXG4gICAgICApO1xuXG4gICAgY29uc3QgYmFja2VuZE1ldGFkYXRhT2JqZWN0OiBCYWNrZW5kTWV0YWRhdGEgPSB7XG4gICAgICBkZXBsb3ltZW50VHlwZTogYmFja2VuZE91dHB1dFtwbGF0Zm9ybU91dHB1dEtleV0ucGF5bG9hZFxuICAgICAgICAuZGVwbG95bWVudFR5cGUgYXMgRGVwbG95bWVudFR5cGUsXG4gICAgICBsYXN0VXBkYXRlZCxcbiAgICAgIHN0YXR1cyxcbiAgICAgIG5hbWU6IHN0YWNrTmFtZSxcbiAgICAgIHJlc291cmNlcyxcbiAgICB9O1xuXG4gICAgaWYgKGF1dGhTdGFjaykge1xuICAgICAgYmFja2VuZE1ldGFkYXRhT2JqZWN0LmF1dGhDb25maWd1cmF0aW9uID0ge1xuICAgICAgICBzdGF0dXM6IHRoaXMuc3RhY2tTdGF0dXNNYXBwZXIudHJhbnNsYXRlU3RhY2tTdGF0dXMoXG4gICAgICAgICAgYXV0aFN0YWNrLlN0YWNrU3RhdHVzXG4gICAgICAgICksXG4gICAgICAgIGxhc3RVcGRhdGVkOiBhdXRoU3RhY2suTGFzdFVwZGF0ZWRUaW1lID8/IGF1dGhTdGFjay5DcmVhdGlvblRpbWUsXG4gICAgICAgIHVzZXJQb29sSWQ6IGJhY2tlbmRPdXRwdXRbYXV0aE91dHB1dEtleV0/LnBheWxvYWQudXNlclBvb2xJZCBhcyBzdHJpbmcsXG4gICAgICB9O1xuICAgIH1cblxuICAgIGlmIChzdG9yYWdlU3RhY2spIHtcbiAgICAgIGJhY2tlbmRNZXRhZGF0YU9iamVjdC5zdG9yYWdlQ29uZmlndXJhdGlvbiA9IHtcbiAgICAgICAgc3RhdHVzOiB0aGlzLnN0YWNrU3RhdHVzTWFwcGVyLnRyYW5zbGF0ZVN0YWNrU3RhdHVzKFxuICAgICAgICAgIHN0b3JhZ2VTdGFjay5TdGFja1N0YXR1c1xuICAgICAgICApLFxuICAgICAgICBsYXN0VXBkYXRlZDogc3RvcmFnZVN0YWNrLkxhc3RVcGRhdGVkVGltZSA/PyBzdG9yYWdlU3RhY2suQ3JlYXRpb25UaW1lLFxuICAgICAgICBzM0J1Y2tldE5hbWU6IGJhY2tlbmRPdXRwdXRbc3RvcmFnZU91dHB1dEtleV0/LnBheWxvYWRcbiAgICAgICAgICAuYnVja2V0TmFtZSBhcyBzdHJpbmcsXG4gICAgICB9O1xuICAgIH1cblxuICAgIGlmIChhcGlTdGFjaykge1xuICAgICAgY29uc3QgYWRkaXRpb25hbEF1dGhUeXBlc1N0cmluZyA9XG4gICAgICAgIGJhY2tlbmRPdXRwdXRbZ3JhcGhxbE91dHB1dEtleV0/LnBheWxvYWRcbiAgICAgICAgICAuYXdzQXBwc3luY0FkZGl0aW9uYWxBdXRoZW50aWNhdGlvblR5cGVzO1xuICAgICAgY29uc3QgYWRkaXRpb25hbEF1dGhUeXBlcyA9IGFkZGl0aW9uYWxBdXRoVHlwZXNTdHJpbmdcbiAgICAgICAgPyAoYWRkaXRpb25hbEF1dGhUeXBlc1N0cmluZy5zcGxpdCgnLCcpIGFzIEFwaUF1dGhUeXBlW10pXG4gICAgICAgIDogW107XG4gICAgICBiYWNrZW5kTWV0YWRhdGFPYmplY3QuYXBpQ29uZmlndXJhdGlvbiA9IHtcbiAgICAgICAgc3RhdHVzOiB0aGlzLnN0YWNrU3RhdHVzTWFwcGVyLnRyYW5zbGF0ZVN0YWNrU3RhdHVzKFxuICAgICAgICAgIGFwaVN0YWNrLlN0YWNrU3RhdHVzXG4gICAgICAgICksXG4gICAgICAgIGxhc3RVcGRhdGVkOiBhcGlTdGFjay5MYXN0VXBkYXRlZFRpbWUgPz8gYXBpU3RhY2suQ3JlYXRpb25UaW1lLFxuICAgICAgICBncmFwaHFsRW5kcG9pbnQ6IGJhY2tlbmRPdXRwdXRbZ3JhcGhxbE91dHB1dEtleV0/LnBheWxvYWRcbiAgICAgICAgICAuYXdzQXBwc3luY0FwaUVuZHBvaW50IGFzIHN0cmluZyxcbiAgICAgICAgZGVmYXVsdEF1dGhUeXBlOiBiYWNrZW5kT3V0cHV0W2dyYXBocWxPdXRwdXRLZXldPy5wYXlsb2FkXG4gICAgICAgICAgLmF3c0FwcHN5bmNBdXRoZW50aWNhdGlvblR5cGUgYXMgQXBpQXV0aFR5cGUsXG4gICAgICAgIGFkZGl0aW9uYWxBdXRoVHlwZXMsXG4gICAgICAgIGNvbmZsaWN0UmVzb2x1dGlvbk1vZGU6IGJhY2tlbmRPdXRwdXRbZ3JhcGhxbE91dHB1dEtleV0/LnBheWxvYWRcbiAgICAgICAgICAuYXdzQXBwc3luY0NvbmZsaWN0UmVzb2x1dGlvbk1vZGUgYXMgQ29uZmxpY3RSZXNvbHV0aW9uTW9kZSxcbiAgICAgICAgYXBpSWQ6IGJhY2tlbmRPdXRwdXRbZ3JhcGhxbE91dHB1dEtleV0/LnBheWxvYWRcbiAgICAgICAgICAuYXdzQXBwc3luY0FwaUlkIGFzIHN0cmluZyxcbiAgICAgICAgbW9kZWxTY2hlbWFTM1VyaTogYmFja2VuZE91dHB1dFtncmFwaHFsT3V0cHV0S2V5XT8ucGF5bG9hZFxuICAgICAgICAgIC5hbXBsaWZ5QXBpTW9kZWxTY2hlbWFTM1VyaSBhcyBzdHJpbmcsXG4gICAgICB9O1xuICAgIH1cblxuICAgIGlmIChmdW5jdGlvblN0YWNrKSB7XG4gICAgICBjb25zdCBmdW5jdGlvblJlc291cmNlcyA9IHJlc291cmNlcy5maWx0ZXIoXG4gICAgICAgIChyZXNvdXJjZSkgPT4gcmVzb3VyY2UucmVzb3VyY2VUeXBlID09PSAnQVdTOjpMYW1iZGE6OkZ1bmN0aW9uJ1xuICAgICAgKTtcbiAgICAgIGNvbnN0IGZ1bmN0aW9uQ29uZmlndXJhdGlvbnM6IEZ1bmN0aW9uQ29uZmlndXJhdGlvbltdID0gW107XG4gICAgICBjb25zdCBkZWZpbmVkRnVuY3Rpb25zU3RyaW5nID1cbiAgICAgICAgYmFja2VuZE91dHB1dFtmdW5jdGlvbk91dHB1dEtleV0/LnBheWxvYWQuZGVmaW5lZEZ1bmN0aW9ucztcbiAgICAgIGNvbnN0IGN1c3RvbWVyRnVuY3Rpb25OYW1lcyA9IGRlZmluZWRGdW5jdGlvbnNTdHJpbmdcbiAgICAgICAgPyAoSlNPTi5wYXJzZShkZWZpbmVkRnVuY3Rpb25zU3RyaW5nKSBhcyBzdHJpbmdbXSlcbiAgICAgICAgOiBbXTtcblxuICAgICAgY3VzdG9tZXJGdW5jdGlvbk5hbWVzLmZvckVhY2goKGZ1bmN0aW9uTmFtZSkgPT4ge1xuICAgICAgICBjb25zdCByZXNvdXJjZSA9IGZ1bmN0aW9uUmVzb3VyY2VzLmZpbmQoXG4gICAgICAgICAgKGZ1bmMpID0+IGZ1bmMucGh5c2ljYWxSZXNvdXJjZUlkID09PSBmdW5jdGlvbk5hbWVcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAocmVzb3VyY2UpIHtcbiAgICAgICAgICBmdW5jdGlvbkNvbmZpZ3VyYXRpb25zLnB1c2goe1xuICAgICAgICAgICAgc3RhdHVzOiB0aGlzLnN0YWNrU3RhdHVzTWFwcGVyLnRyYW5zbGF0ZVN0YWNrU3RhdHVzKFxuICAgICAgICAgICAgICByZXNvdXJjZS5yZXNvdXJjZVN0YXR1c1xuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIGxhc3RVcGRhdGVkOlxuICAgICAgICAgICAgICByZXNvdXJjZS5sYXN0VXBkYXRlZCA/P1xuICAgICAgICAgICAgICBmdW5jdGlvblN0YWNrLkxhc3RVcGRhdGVkVGltZSA/P1xuICAgICAgICAgICAgICBmdW5jdGlvblN0YWNrLkNyZWF0aW9uVGltZSxcbiAgICAgICAgICAgIGZ1bmN0aW9uTmFtZSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGJhY2tlbmRNZXRhZGF0YU9iamVjdC5mdW5jdGlvbkNvbmZpZ3VyYXRpb25zID0gZnVuY3Rpb25Db25maWd1cmF0aW9ucztcbiAgICB9XG5cbiAgICByZXR1cm4gYmFja2VuZE1ldGFkYXRhT2JqZWN0O1xuICB9O1xuXG4gIHByaXZhdGUgZmV0Y2hTY2hlbWEgPSBhc3luYyAoXG4gICAgc2NoZW1hUzNVcmk6IHN0cmluZyB8IHVuZGVmaW5lZFxuICApOiBQcm9taXNlPHN0cmluZz4gPT4ge1xuICAgIGlmICghc2NoZW1hUzNVcmkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignc2NoZW1hUzNVcmkgb3V0cHV0IGlzIG5vdCBhdmFpbGFibGUnKTtcbiAgICB9XG5cbiAgICAvLyBzMzovL3tidWNrZXROYW1lfS97ZmlsZU5hbWV9XG4gICAgY29uc3QgdXJpUGFydHMgPSBzY2hlbWFTM1VyaS5zcGxpdCgnLycpO1xuICAgIGNvbnN0IGJ1Y2tldE5hbWUgPSB1cmlQYXJ0c1syXTtcbiAgICBjb25zdCBvYmplY3RQYXRoID0gdXJpUGFydHMuc2xpY2UoMywgdXJpUGFydHMubGVuZ3RoKS5qb2luKCcvJyk7XG5cbiAgICBpZiAoIWJ1Y2tldE5hbWUgfHwgIW9iamVjdFBhdGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignc2NoZW1hUzNVcmkgaXMgbm90IHZhbGlkJyk7XG4gICAgfVxuXG4gICAgY29uc3QgczNSZXNwb25zZSA9IGF3YWl0IHRoaXMuczNDbGllbnQuc2VuZChcbiAgICAgIG5ldyBHZXRPYmplY3RDb21tYW5kKHsgQnVja2V0OiBidWNrZXROYW1lLCBLZXk6IG9iamVjdFBhdGggfSlcbiAgICApO1xuXG4gICAgaWYgKCFzM1Jlc3BvbnNlLkJvZHkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgczNSZXNwb25zZSBmcm9tICR7c2NoZW1hUzNVcml9IGRvZXMgbm90IGNvbnRhaW4gYSBCb2R5YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IHMzUmVzcG9uc2UuQm9keT8udHJhbnNmb3JtVG9TdHJpbmcoKTtcbiAgfTtcbn1cbiJdfQ==