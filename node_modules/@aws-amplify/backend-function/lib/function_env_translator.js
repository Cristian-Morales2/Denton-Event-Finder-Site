import { Arn, Lazy, Stack } from 'aws-cdk-lib';
import { Effect, PolicyStatement } from 'aws-cdk-lib/aws-iam';
import { AmplifyUserError } from '@aws-amplify/platform-core';
/**
 * Translates function environment props into appropriate environment records and builds a policy statement
 * in order to resolve secrets in environment props.
 */
export class FunctionEnvironmentTranslator {
    lambda;
    functionEnvironmentProp;
    backendSecretResolver;
    functionEnvironmentTypeGenerator;
    ssmPaths = [];
    ssmEnvVars = {};
    amplifySsmEnvConfigKey = 'AMPLIFY_SSM_ENV_CONFIG';
    ssmValuePlaceholderText = '<value will be resolved during runtime>';
    // List of environment variable names for typed shim generation
    amplifyBackendEnvVarNames = [];
    /**
     * Initialize translated environment variable records
     */
    constructor(lambda, // we need to use a specific type here so that we have all the method goodies
    functionEnvironmentProp, backendSecretResolver, functionEnvironmentTypeGenerator) {
        this.lambda = lambda;
        this.functionEnvironmentProp = functionEnvironmentProp;
        this.backendSecretResolver = backendSecretResolver;
        this.functionEnvironmentTypeGenerator = functionEnvironmentTypeGenerator;
        for (const [key, value] of Object.entries(this.functionEnvironmentProp)) {
            if (key === this.amplifySsmEnvConfigKey) {
                throw new Error(`${this.amplifySsmEnvConfigKey} is a reserved environment variable name`);
            }
            if (typeof value === 'undefined') {
                throw new AmplifyUserError('InvalidFunctionConfiguration', {
                    message: `The value of environment variable ${key} is undefined.`,
                    resolution: `Ensure that all defineFunction environment variables are defined.`,
                });
            }
            else if (typeof value === 'string') {
                this.lambda.addEnvironment(key, value);
            }
            else {
                const { branchSecretPath, sharedSecretPath } = this.backendSecretResolver.resolvePath(value);
                this.lambda.addEnvironment(key, this.ssmValuePlaceholderText);
                this.ssmEnvVars[branchSecretPath] = {
                    name: key,
                    sharedPath: sharedSecretPath,
                };
                this.ssmPaths.push(branchSecretPath, sharedSecretPath);
            }
            this.amplifyBackendEnvVarNames.push(key);
        }
        // add an environment variable for ssm parameter metadata that is resolved after initialization but before synth is finalized
        this.lambda.addEnvironment(this.amplifySsmEnvConfigKey, Lazy.string({
            produce: () => JSON.stringify(this.ssmEnvVars),
        }));
        this.lambda.node.addValidation({
            validate: () => {
                // only add the ssm access policy if there are ssm paths
                if (this.ssmPaths.length > 0) {
                    const ssmAccessPolicy = new PolicyStatement({
                        effect: Effect.ALLOW,
                        actions: ['ssm:GetParameters'],
                        resources: this.ssmPaths
                            .map((path) => (path.startsWith('/') ? path.slice(1) : path)) // the Arn formatter will add a leading slash between the resource and resourceName
                            .map((path) => Arn.format({
                            service: 'ssm',
                            resource: 'parameter',
                            resourceName: path,
                        }, Stack.of(this.lambda))),
                    });
                    this.lambda.grantPrincipal.addToPrincipalPolicy(ssmAccessPolicy);
                }
                return [];
            },
        });
        // Using CDK validation mechanism as a way to generate a typed process.env shim file at the end of synthesis
        this.lambda.node.addValidation({
            validate: () => {
                this.functionEnvironmentTypeGenerator.generateTypedProcessEnvShim(this.amplifyBackendEnvVarNames);
                return [];
            },
        });
    }
    /**
     * Adds an environment variable to the lambda whose value will be fetched from SSM at runtime
     * @param name The environment variable name
     * @param ssmPath The SSM path where the value is stored
     */
    addSsmEnvironmentEntry = (name, ssmPath) => {
        this.lambda.addEnvironment(name, this.ssmValuePlaceholderText);
        this.ssmPaths.push(ssmPath);
        this.ssmEnvVars[ssmPath] = { name };
        this.amplifyBackendEnvVarNames.push(name);
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVuY3Rpb25fZW52X3RyYW5zbGF0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZnVuY3Rpb25fZW52X3RyYW5zbGF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRy9DLE9BQU8sRUFBRSxNQUFNLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFOUQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFFOUQ7OztHQUdHO0FBQ0gsTUFBTSxPQUFPLDZCQUE2QjtJQWVyQjtJQUNBO0lBQ0E7SUFDQTtJQWpCRixRQUFRLEdBQWEsRUFBRSxDQUFDO0lBQ3hCLFVBQVUsR0FBZSxFQUFFLENBQUM7SUFFNUIsc0JBQXNCLEdBQUcsd0JBQXdCLENBQUM7SUFDbEQsdUJBQXVCLEdBQ3RDLHlDQUF5QyxDQUFDO0lBRTVDLCtEQUErRDtJQUM5Qyx5QkFBeUIsR0FBYSxFQUFFLENBQUM7SUFFMUQ7O09BRUc7SUFDSCxZQUNtQixNQUFzQixFQUFFLDZFQUE2RTtJQUNyRyx1QkFBK0QsRUFDL0QscUJBQTRDLEVBQzVDLGdDQUFrRTtRQUhsRSxXQUFNLEdBQU4sTUFBTSxDQUFnQjtRQUN0Qiw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQXdDO1FBQy9ELDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBdUI7UUFDNUMscUNBQWdDLEdBQWhDLGdDQUFnQyxDQUFrQztRQUVuRixLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsRUFBRTtZQUN2RSxJQUFJLEdBQUcsS0FBSyxJQUFJLENBQUMsc0JBQXNCLEVBQUU7Z0JBQ3ZDLE1BQU0sSUFBSSxLQUFLLENBQ2IsR0FBRyxJQUFJLENBQUMsc0JBQXNCLDBDQUEwQyxD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QUFDO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxzQkFBc0IsR0FBRyxDQUFDLElBQVksRUFBRSxPQUFlLEVBQUUsRUFBRTtRQUN6RCxJQUFJLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFDL0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDNUIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxDQUFDO1FBQ3BDLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDNUMsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCYWNrZW5kU2VjcmV0UmVzb2x2ZXIgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IEFybiwgTGF6eSwgU3RhY2sgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBGdW5jdGlvblByb3BzIH0gZnJvbSAnLi9mYWN0b3J5LmpzJztcbmltcG9ydCB7IE5vZGVqc0Z1bmN0aW9uIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYS1ub2RlanMnO1xuaW1wb3J0IHsgRWZmZWN0LCBQb2xpY3lTdGF0ZW1lbnQgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7IEZ1bmN0aW9uRW52aXJvbm1lbnRUeXBlR2VuZXJhdG9yIH0gZnJvbSAnLi9mdW5jdGlvbl9lbnZfdHlwZV9nZW5lcmF0b3IuanMnO1xuaW1wb3J0IHsgQW1wbGlmeVVzZXJFcnJvciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcblxuLyoqXG4gKiBUcmFuc2xhdGVzIGZ1bmN0aW9uIGVudmlyb25tZW50IHByb3BzIGludG8gYXBwcm9wcmlhdGUgZW52aXJvbm1lbnQgcmVjb3JkcyBhbmQgYnVpbGRzIGEgcG9saWN5IHN0YXRlbWVudFxuICogaW4gb3JkZXIgdG8gcmVzb2x2ZSBzZWNyZXRzIGluIGVudmlyb25tZW50IHByb3BzLlxuICovXG5leHBvcnQgY2xhc3MgRnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3Ige1xuICBwcml2YXRlIHJlYWRvbmx5IHNzbVBhdGhzOiBzdHJpbmdbXSA9IFtdO1xuICBwcml2YXRlIHJlYWRvbmx5IHNzbUVudlZhcnM6IFNzbUVudlZhcnMgPSB7fTtcblxuICBwcml2YXRlIHJlYWRvbmx5IGFtcGxpZnlTc21FbnZDb25maWdLZXkgPSAnQU1QTElGWV9TU01fRU5WX0NPTkZJRyc7XG4gIHByaXZhdGUgcmVhZG9ubHkgc3NtVmFsdWVQbGFjZWhvbGRlclRleHQgPVxuICAgICc8dmFsdWUgd2lsbCBiZSByZXNvbHZlZCBkdXJpbmcgcnVudGltZT4nO1xuXG4gIC8vIExpc3Qgb2YgZW52aXJvbm1lbnQgdmFyaWFibGUgbmFtZXMgZm9yIHR5cGVkIHNoaW0gZ2VuZXJhdGlvblxuICBwcml2YXRlIHJlYWRvbmx5IGFtcGxpZnlCYWNrZW5kRW52VmFyTmFtZXM6IHN0cmluZ1tdID0gW107XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemUgdHJhbnNsYXRlZCBlbnZpcm9ubWVudCB2YXJpYWJsZSByZWNvcmRzXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGxhbWJkYTogTm9kZWpzRnVuY3Rpb24sIC8vIHdlIG5lZWQgdG8gdXNlIGEgc3BlY2lmaWMgdHlwZSBoZXJlIHNvIHRoYXQgd2UgaGF2ZSBhbGwgdGhlIG1ldGhvZCBnb29kaWVzXG4gICAgcHJpdmF0ZSByZWFkb25seSBmdW5jdGlvbkVudmlyb25tZW50UHJvcDogUmVxdWlyZWQ8RnVuY3Rpb25Qcm9wcz5bJ2Vudmlyb25tZW50J10sXG4gICAgcHJpdmF0ZSByZWFkb25seSBiYWNrZW5kU2VjcmV0UmVzb2x2ZXI6IEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGZ1bmN0aW9uRW52aXJvbm1lbnRUeXBlR2VuZXJhdG9yOiBGdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvclxuICApIHtcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLmZ1bmN0aW9uRW52aXJvbm1lbnRQcm9wKSkge1xuICAgICAgaWYgKGtleSA9PT0gdGhpcy5hbXBsaWZ5U3NtRW52Q29uZmlnS2V5KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgJHt0aGlzLmFtcGxpZnlTc21FbnZDb25maWdLZXl9IGlzIGEgcmVzZXJ2ZWQgZW52aXJvbm1lbnQgdmFyaWFibGUgbmFtZWBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkRnVuY3Rpb25Db25maWd1cmF0aW9uJywge1xuICAgICAgICAgIG1lc3NhZ2U6IGBUaGUgdmFsdWUgb2YgZW52aXJvbm1lbnQgdmFyaWFibGUgJHtrZXl9IGlzIHVuZGVmaW5lZC5gLFxuICAgICAgICAgIHJlc29sdXRpb246IGBFbnN1cmUgdGhhdCBhbGwgZGVmaW5lRnVuY3Rpb24gZW52aXJvbm1lbnQgdmFyaWFibGVzIGFyZSBkZWZpbmVkLmAsXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHRoaXMubGFtYmRhLmFkZEVudmlyb25tZW50KGtleSwgdmFsdWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgeyBicmFuY2hTZWNyZXRQYXRoLCBzaGFyZWRTZWNyZXRQYXRoIH0gPVxuICAgICAgICAgIHRoaXMuYmFja2VuZFNlY3JldFJlc29sdmVyLnJlc29sdmVQYXRoKHZhbHVlKTtcbiAgICAgICAgdGhpcy5sYW1iZGEuYWRkRW52aXJvbm1lbnQoa2V5LCB0aGlzLnNzbVZhbHVlUGxhY2Vob2xkZXJUZXh0KTtcbiAgICAgICAgdGhpcy5zc21FbnZWYXJzW2JyYW5jaFNlY3JldFBhdGhdID0ge1xuICAgICAgICAgIG5hbWU6IGtleSxcbiAgICAgICAgICBzaGFyZWRQYXRoOiBzaGFyZWRTZWNyZXRQYXRoLFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnNzbVBhdGhzLnB1c2goYnJhbmNoU2VjcmV0UGF0aCwgc2hhcmVkU2VjcmV0UGF0aCk7XG4gICAgICB9XG4gICAgICB0aGlzLmFtcGxpZnlCYWNrZW5kRW52VmFyTmFtZXMucHVzaChrZXkpO1xuICAgIH1cblxuICAgIC8vIGFkZCBhbiBlbnZpcm9ubWVudCB2YXJpYWJsZSBmb3Igc3NtIHBhcmFtZXRlciBtZXRhZGF0YSB0aGF0IGlzIHJlc29sdmVkIGFmdGVyIGluaXRpYWxpemF0aW9uIGJ1dCBiZWZvcmUgc3ludGggaXMgZmluYWxpemVkXG4gICAgdGhpcy5sYW1iZGEuYWRkRW52aXJvbm1lbnQoXG4gICAgICB0aGlzLmFtcGxpZnlTc21FbnZDb25maWdLZXksXG4gICAgICBMYXp5LnN0cmluZyh7XG4gICAgICAgIHByb2R1Y2U6ICgpID0+IEpTT04uc3RyaW5naWZ5KHRoaXMuc3NtRW52VmFycyksXG4gICAgICB9KVxuICAgICk7XG5cbiAgICB0aGlzLmxhbWJkYS5ub2RlLmFkZFZhbGlkYXRpb24oe1xuICAgICAgdmFsaWRhdGU6ICgpID0+IHtcbiAgICAgICAgLy8gb25seSBhZGQgdGhlIHNzbSBhY2Nlc3MgcG9saWN5IGlmIHRoZXJlIGFyZSBzc20gcGF0aHNcbiAgICAgICAgaWYgKHRoaXMuc3NtUGF0aHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGNvbnN0IHNzbUFjY2Vzc1BvbGljeSA9IG5ldyBQb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgZWZmZWN0OiBFZmZlY3QuQUxMT1csXG4gICAgICAgICAgICBhY3Rpb25zOiBbJ3NzbTpHZXRQYXJhbWV0ZXJzJ10sXG4gICAgICAgICAgICByZXNvdXJjZXM6IHRoaXMuc3NtUGF0aHNcbiAgICAgICAgICAgICAgLm1hcCgocGF0aCkgPT4gKHBhdGguc3RhcnRzV2l0aCgnLycpID8gcGF0aC5zbGljZSgxKSA6IHBhdGgpKSAvLyB0aGUgQXJuIGZvcm1hdHRlciB3aWxsIGFkZCBhIGxlYWRpbmcgc2xhc2ggYmV0d2VlbiB0aGUgcmVzb3VyY2UgYW5kIHJlc291cmNlTmFtZVxuICAgICAgICAgICAgICAubWFwKChwYXRoKSA9PlxuICAgICAgICAgICAgICAgIEFybi5mb3JtYXQoXG4gICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHNlcnZpY2U6ICdzc20nLFxuICAgICAgICAgICAgICAgICAgICByZXNvdXJjZTogJ3BhcmFtZXRlcicsXG4gICAgICAgICAgICAgICAgICAgIHJlc291cmNlTmFtZTogcGF0aCxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICBTdGFjay5vZih0aGlzLmxhbWJkYSlcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICksXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgdGhpcy5sYW1iZGEuZ3JhbnRQcmluY2lwYWwuYWRkVG9QcmluY2lwYWxQb2xpY3koc3NtQWNjZXNzUG9saWN5KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW107XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gVXNpbmcgQ0RLIHZhbGlkYXRpb24gbWVjaGFuaXNtIGFzIGEgd2F5IHRvIGdlbmVyYXRlIGEgdHlwZWQgcHJvY2Vzcy5lbnYgc2hpbSBmaWxlIGF0IHRoZSBlbmQgb2Ygc3ludGhlc2lzXG4gICAgdGhpcy5sYW1iZGEubm9kZS5hZGRWYWxpZGF0aW9uKHtcbiAgICAgIHZhbGlkYXRlOiAoKTogc3RyaW5nW10gPT4ge1xuICAgICAgICB0aGlzLmZ1bmN0aW9uRW52aXJvbm1lbnRUeXBlR2VuZXJhdG9yLmdlbmVyYXRlVHlwZWRQcm9jZXNzRW52U2hpbShcbiAgICAgICAgICB0aGlzLmFtcGxpZnlCYWNrZW5kRW52VmFyTmFtZXNcbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRzIGFuIGVudmlyb25tZW50IHZhcmlhYmxlIHRvIHRoZSBsYW1iZGEgd2hvc2UgdmFsdWUgd2lsbCBiZSBmZXRjaGVkIGZyb20gU1NNIGF0IHJ1bnRpbWVcbiAgICogQHBhcmFtIG5hbWUgVGhlIGVudmlyb25tZW50IHZhcmlhYmxlIG5hbWVcbiAgICogQHBhcmFtIHNzbVBhdGggVGhlIFNTTSBwYXRoIHdoZXJlIHRoZSB2YWx1ZSBpcyBzdG9yZWRcbiAgICovXG4gIGFkZFNzbUVudmlyb25tZW50RW50cnkgPSAobmFtZTogc3RyaW5nLCBzc21QYXRoOiBzdHJpbmcpID0+IHtcbiAgICB0aGlzLmxhbWJkYS5hZGRFbnZpcm9ubWVudChuYW1lLCB0aGlzLnNzbVZhbHVlUGxhY2Vob2xkZXJUZXh0KTtcbiAgICB0aGlzLnNzbVBhdGhzLnB1c2goc3NtUGF0aCk7XG4gICAgdGhpcy5zc21FbnZWYXJzW3NzbVBhdGhdID0geyBuYW1lIH07XG4gICAgdGhpcy5hbXBsaWZ5QmFja2VuZEVudlZhck5hbWVzLnB1c2gobmFtZSk7XG4gIH07XG59XG5cbi8qKlxuICogRGVmaW5lcyBtZXRhZGF0YSBhcm91bmQgZW52aXJvbm1lbnQgdmFyaWFibGUgdmFsdWVzIHRoYXQgYXJlIGZldGNoZWQgZnJvbSBTU00gZHVyaW5nIHJ1bnRpbWUgb2YgdGhlIGxhbWJkYSBmdW5jdGlvblxuICovXG5leHBvcnQgdHlwZSBTc21FbnZWYXJzID0ge1xuICAvKipcbiAgICogVGhlIHJlY29yZCBrZXkgbmFtZXMgYXJlIHRoZSBicmFuY2gtc3BlY2lmaWMgU1NNIHBhdGhzIHRvIGZldGNoIHRoZSB2YWx1ZSBmcm9tXG4gICAqL1xuICBbYnJhbmNoUGF0aDogc3RyaW5nXToge1xuICAgIC8qKlxuICAgICAqIFRoZSBlbnZpcm9ubWVudCB2YXJpYWJsZSBuYW1lIHRvIHBsYWNlIHRoZSByZXNvbHZlZCB2YWx1ZSBpblxuICAgICAqL1xuICAgIG5hbWU6IHN0cmluZztcbiAgICAvKipcbiAgICAgKiBBbiBvcHRpb25hbCBcImZhbGxiYWNrXCIgU1NNIHBhdGggd2hlcmUgdGhlIHZhbHVlIHdpbGwgYmUgbG9va2VkIHVwIGlmIG5vdCBmb3VuZCBhdCB0aGUgYnJhbmNoLXNwZWNpZmljIHBhdGhcbiAgICAgKi9cbiAgICBzaGFyZWRQYXRoPzogc3RyaW5nO1xuICB9O1xufTtcbiJdfQ==