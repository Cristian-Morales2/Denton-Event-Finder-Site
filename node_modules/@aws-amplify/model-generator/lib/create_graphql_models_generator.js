import { BackendOutputClientFactory, } from '@aws-amplify/deployed-backend-client';
import { graphqlOutputKey } from '@aws-amplify/backend-output-schemas';
import { AppsyncGraphqlGenerationResult } from './appsync_graphql_generation_result.js';
import { StackMetadataGraphqlModelsGenerator } from './graphql_models_generator.js';
import { S3StringObjectFetcher } from './s3_string_object_fetcher.js';
/**
 * Factory function to compose a model generator.
 */
export const createGraphqlModelsGenerator = (params) => {
    if ('backendIdentifier' in params) {
        return createGraphqlModelsGeneratorFromBackendIdentifier(params);
    }
    return createGraphqlModelsFromS3UriGenerator(params);
};
/**
 * Factory function to compose a model generator from a backend identifier.
 */
const createGraphqlModelsGeneratorFromBackendIdentifier = ({ backendIdentifier, awsClientProvider, }) => {
    if (!backendIdentifier) {
        throw new Error('`backendIdentifier` must be defined');
    }
    if (!awsClientProvider) {
        throw new Error('`awsClientProvider` must be defined');
    }
    return new StackMetadataGraphqlModelsGenerator(() => getModelSchema(backendIdentifier, awsClientProvider), (fileMap) => new AppsyncGraphqlGenerationResult(fileMap));
};
/**
 * Factory function to compose a model generator from an s3 uri.
 */
export const createGraphqlModelsFromS3UriGenerator = ({ modelSchemaS3Uri, awsClientProvider, }) => {
    if (!modelSchemaS3Uri) {
        throw new Error('`modelSchemaS3Uri` must be defined');
    }
    if (!awsClientProvider) {
        throw new Error('`awsClientProvider` must be defined');
    }
    return new StackMetadataGraphqlModelsGenerator(() => getModelSchemaFromS3Uri(modelSchemaS3Uri, awsClientProvider), (fileMap) => new AppsyncGraphqlGenerationResult(fileMap));
};
const getModelSchema = async (backendIdentifier, awsClientProvider) => {
    const backendOutputClient = BackendOutputClientFactory.getInstance(awsClientProvider);
    const output = await backendOutputClient.getOutput(backendIdentifier);
    const modelSchemaS3Uri = output[graphqlOutputKey]?.payload.amplifyApiModelSchemaS3Uri;
    if (!modelSchemaS3Uri) {
        throw new Error(`Cannot find model schema at amplifyApiModelSchemaS3Uri`);
    }
    return await getModelSchemaFromS3Uri(modelSchemaS3Uri, awsClientProvider);
};
const getModelSchemaFromS3Uri = async (modelSchemaS3Uri, awsClientProvider) => {
    const schemaFetcher = new S3StringObjectFetcher(awsClientProvider.getS3Client());
    return await schemaFetcher.fetch(modelSchemaS3Uri);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlX2dyYXBocWxfbW9kZWxzX2dlbmVyYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jcmVhdGVfZ3JhcGhxbF9tb2RlbHNfZ2VuZXJhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCwwQkFBMEIsR0FFM0IsTUFBTSxzQ0FBc0MsQ0FBQztBQUU5QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUN2RSxPQUFPLEVBQUUsOEJBQThCLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUN4RixPQUFPLEVBQUUsbUNBQW1DLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUVwRixPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQXdCdEU7O0dBRUc7QUFDSCxNQUFNLENBQUMsTUFBTSw0QkFBNEIsR0FBRyxDQUMxQyxNQUEyQyxFQUNuQixFQUFFO0lBQzFCLElBQUksbUJBQW1CLElBQUksTUFBTSxFQUFFO1FBQ2pDLE9BQU8saURBQWlELENBQUMsTUFBTSxDQUFDLENBQUM7S0FDbEU7SUFDRCxPQUFPLHFDQUFxQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3ZELENBQUMsQ0FBQztBQVdGOztHQUVHO0FBQ0gsTUFBTSxpREFBaUQsR0FBRyxDQUFDLEVBQ3pELGlCQUFpQixFQUNqQixpQkFBaUIsR0FDd0IsRUFBMEIsRUFBRTtJQUNyRSxJQUFJLENBQUMsaUJBQWlCLEVBQUU7UUFDdEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO0tBQ3hEO0lBQ0QsSUFBSSxDQUFDLGlCQUFpQixFQUFFO1FBQ3RCLE1BQU0sSUFBSSxLQUFLLENBQUMscUNBQXFDLENBQUMsQ0FBQztLQUN4RDtJQUVELE9BQU8sSUFBSSxtQ0FBbUMsQ0FDNUMsR0FBRyxFQUFFLENBQUMsY0FBYyxDQUFDLGlCQUFpQixFQUFFLGlCQUFpQixDQUFDLEVBQzFELENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxJQUFJLDhCQUE4QixDQUFDLE9BQU8sQ0FBQyxDQUN6RCxDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBV0Y7O0dBRUc7QUFDSCxNQUFNLENBQUMsTUFBTSxxQ0FBcUMsR0FBRyxDQUFDLEVBQ3BELGdCQUFnQixFQUNoQixpQkFBaUIsR0FDNEIsRUFBMEIsRUFBRTtJQUN6RSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7UUFDckIsTUFBTSxJQUFJLEtBQUssQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO0tBQ3ZEO0lBQ0QsSUFBSSxDQUFDLGlCQUFpQixFQUFFO1FBQ3RCLE1BQU0sSUFBSSxLQUFLLENBQUMscUNBQXFDLENBQUMsQ0FBQztLQUN4RDtJQUNELE9BQU8sSUFBSSxtQ0FBbUMsQ0FDNUMsR0FBRyxFQUFFLENBQUMsdUJBQXVCLENBQUMsZ0JBQWdCLEVBQUUsaUJBQWlCLENBQUMsRUFDbEUsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLElBQUksOEJBQThCLENBQUMsT0FBTyxDQUFDLENBQ3pELENBQUM7QUFDSixDQUFDLENBQUM7QUFFRixNQUFNLGNBQWMsR0FBRyxLQUFLLEVBQzFCLGlCQUE0QyxFQUM1QyxpQkFJRSxFQUNlLEVBQUU7SUFDbkIsTUFBTSxtQkFBbUIsR0FDdkIsMEJBQTBCLENBQUMsV0FBVyxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFDNUQsTUFBTSxNQUFNLEdBQUcsTUFBTSxtQkFBbUIsQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQUMsQ0FBQztJQUN0RSxNQUFNLGdCQUFnQixHQUNwQixNQUFNLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxPQUFPLENBQUMsMEJBQTBCLENBQUM7SUFDL0QsSUFBSSxDQUFDLGdCQUFnQixFQUFFO1FBQ3JCLE1BQU0sSUFBSSxLQUFLLENBQUMsd0RBQXdELENBQUMsQ0FBQztLQUMzRTtJQUVELE9BQU8sTUFBTSx1QkFBdUIsQ0FBQyxnQkFBZ0IsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO0FBQzVFLENBQUMsQ0FBQztBQUVGLE1BQU0sdUJBQXVCLEdBQUcsS0FBSyxFQUNuQyxnQkFBd0IsRUFDeEIsaUJBRUUsRUFDZSxFQUFFO0lBQ25CLE1BQU0sYUFBYSxHQUFHLElBQUkscUJBQXFCLENBQzdDLGlCQUFpQixDQUFDLFdBQVcsRUFBRSxDQUNoQyxDQUFDO0lBQ0YsT0FBTyxNQUFNLGFBQWEsQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUNyRCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBCYWNrZW5kT3V0cHV0Q2xpZW50RmFjdG9yeSxcbiAgRGVwbG95ZWRCYWNrZW5kSWRlbnRpZmllcixcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2RlcGxveWVkLWJhY2tlbmQtY2xpZW50JztcblxuaW1wb3J0IHsgZ3JhcGhxbE91dHB1dEtleSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zY2hlbWFzJztcbmltcG9ydCB7IEFwcHN5bmNHcmFwaHFsR2VuZXJhdGlvblJlc3VsdCB9IGZyb20gJy4vYXBwc3luY19ncmFwaHFsX2dlbmVyYXRpb25fcmVzdWx0LmpzJztcbmltcG9ydCB7IFN0YWNrTWV0YWRhdGFHcmFwaHFsTW9kZWxzR2VuZXJhdG9yIH0gZnJvbSAnLi9ncmFwaHFsX21vZGVsc19nZW5lcmF0b3IuanMnO1xuaW1wb3J0IHsgR3JhcGhxbE1vZGVsc0dlbmVyYXRvciB9IGZyb20gJy4vbW9kZWxfZ2VuZXJhdG9yLmpzJztcbmltcG9ydCB7IFMzU3RyaW5nT2JqZWN0RmV0Y2hlciB9IGZyb20gJy4vczNfc3RyaW5nX29iamVjdF9mZXRjaGVyLmpzJztcbmltcG9ydCB7IEFXU0NsaWVudFByb3ZpZGVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQgeyBTM0NsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XG5pbXBvcnQgeyBBbXBsaWZ5Q2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWFtcGxpZnknO1xuaW1wb3J0IHsgQ2xvdWRGb3JtYXRpb25DbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtY2xvdWRmb3JtYXRpb24nO1xuXG5leHBvcnQgdHlwZSBHcmFwaHFsTW9kZWxzR2VuZXJhdG9yRmFjdG9yeVBhcmFtcyA9XG4gIHwge1xuICAgICAgYmFja2VuZElkZW50aWZpZXI6IERlcGxveWVkQmFja2VuZElkZW50aWZpZXI7XG4gICAgICBhd3NDbGllbnRQcm92aWRlcjogQVdTQ2xpZW50UHJvdmlkZXI8e1xuICAgICAgICBnZXRTM0NsaWVudDogUzNDbGllbnQ7XG4gICAgICAgIGdldEFtcGxpZnlDbGllbnQ6IEFtcGxpZnlDbGllbnQ7XG4gICAgICAgIGdldENsb3VkRm9ybWF0aW9uQ2xpZW50OiBDbG91ZEZvcm1hdGlvbkNsaWVudDtcbiAgICAgIH0+O1xuICAgIH1cbiAgfCB7XG4gICAgICBtb2RlbFNjaGVtYVMzVXJpOiBzdHJpbmc7XG4gICAgICBhd3NDbGllbnRQcm92aWRlcjogQVdTQ2xpZW50UHJvdmlkZXI8e1xuICAgICAgICBnZXRTM0NsaWVudDogUzNDbGllbnQ7XG4gICAgICAgIGdldEFtcGxpZnlDbGllbnQ6IEFtcGxpZnlDbGllbnQ7XG4gICAgICAgIGdldENsb3VkRm9ybWF0aW9uQ2xpZW50OiBDbG91ZEZvcm1hdGlvbkNsaWVudDtcbiAgICAgIH0+O1xuICAgIH07XG5cbi8qKlxuICogRmFjdG9yeSBmdW5jdGlvbiB0byBjb21wb3NlIGEgbW9kZWwgZ2VuZXJhdG9yLlxuICovXG5leHBvcnQgY29uc3QgY3JlYXRlR3JhcGhxbE1vZGVsc0dlbmVyYXRvciA9IChcbiAgcGFyYW1zOiBHcmFwaHFsTW9kZWxzR2VuZXJhdG9yRmFjdG9yeVBhcmFtc1xuKTogR3JhcGhxbE1vZGVsc0dlbmVyYXRvciA9PiB7XG4gIGlmICgnYmFja2VuZElkZW50aWZpZXInIGluIHBhcmFtcykge1xuICAgIHJldHVybiBjcmVhdGVHcmFwaHFsTW9kZWxzR2VuZXJhdG9yRnJvbUJhY2tlbmRJZGVudGlmaWVyKHBhcmFtcyk7XG4gIH1cbiAgcmV0dXJuIGNyZWF0ZUdyYXBocWxNb2RlbHNGcm9tUzNVcmlHZW5lcmF0b3IocGFyYW1zKTtcbn07XG5cbmV4cG9ydCB0eXBlIEdyYXBocWxNb2RlbHNGcm9tQmFja2VuZElkZW50aWZpZXJQYXJhbXMgPSB7XG4gIGJhY2tlbmRJZGVudGlmaWVyOiBEZXBsb3llZEJhY2tlbmRJZGVudGlmaWVyO1xuICBhd3NDbGllbnRQcm92aWRlcjogQVdTQ2xpZW50UHJvdmlkZXI8e1xuICAgIGdldFMzQ2xpZW50OiBTM0NsaWVudDtcbiAgICBnZXRBbXBsaWZ5Q2xpZW50OiBBbXBsaWZ5Q2xpZW50O1xuICAgIGdldENsb3VkRm9ybWF0aW9uQ2xpZW50OiBDbG91ZEZvcm1hdGlvbkNsaWVudDtcbiAgfT47XG59O1xuXG4vKipcbiAqIEZhY3RvcnkgZnVuY3Rpb24gdG8gY29tcG9zZSBhIG1vZGVsIGdlbmVyYXRvciBmcm9tIGEgYmFja2VuZCBpZGVudGlmaWVyLlxuICovXG5jb25zdCBjcmVhdGVHcmFwaHFsTW9kZWxzR2VuZXJhdG9yRnJvbUJhY2tlbmRJZGVudGlmaWVyID0gKHtcbiAgYmFja2VuZElkZW50aWZpZXIsXG4gIGF3c0NsaWVudFByb3ZpZGVyLFxufTogR3JhcGhxbE1vZGVsc0Zyb21CYWNrZW5kSWRlbnRpZmllclBhcmFtcyk6IEdyYXBocWxNb2RlbHNHZW5lcmF0b3IgPT4ge1xuICBpZiAoIWJhY2tlbmRJZGVudGlmaWVyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdgYmFja2VuZElkZW50aWZpZXJgIG11c3QgYmUgZGVmaW5lZCcpO1xuICB9XG4gIGlmICghYXdzQ2xpZW50UHJvdmlkZXIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ2Bhd3NDbGllbnRQcm92aWRlcmAgbXVzdCBiZSBkZWZpbmVkJyk7XG4gIH1cblxuICByZXR1cm4gbmV3IFN0YWNrTWV0YWRhdGFHcmFwaHFsTW9kZWxzR2VuZXJhdG9yKFxuICAgICgpID0+IGdldE1vZGVsU2NoZW1hKGJhY2tlbmRJZGVudGlmaWVyLCBhd3NDbGllbnRQcm92aWRlciksXG4gICAgKGZpbGVNYXApID0+IG5ldyBBcHBzeW5jR3JhcGhxbEdlbmVyYXRpb25SZXN1bHQoZmlsZU1hcClcbiAgKTtcbn07XG5cbmV4cG9ydCB0eXBlIEdyYXBocWxNb2RlbHNGcm9tUzNVcmlHZW5lcmF0b3JGYWN0b3J5UGFyYW1zID0ge1xuICBtb2RlbFNjaGVtYVMzVXJpOiBzdHJpbmc7XG4gIGF3c0NsaWVudFByb3ZpZGVyOiBBV1NDbGllbnRQcm92aWRlcjx7XG4gICAgZ2V0UzNDbGllbnQ6IFMzQ2xpZW50O1xuICAgIGdldEFtcGxpZnlDbGllbnQ6IEFtcGxpZnlDbGllbnQ7XG4gICAgZ2V0Q2xvdWRGb3JtYXRpb25DbGllbnQ6IENsb3VkRm9ybWF0aW9uQ2xpZW50O1xuICB9Pjtcbn07XG5cbi8qKlxuICogRmFjdG9yeSBmdW5jdGlvbiB0byBjb21wb3NlIGEgbW9kZWwgZ2VuZXJhdG9yIGZyb20gYW4gczMgdXJpLlxuICovXG5leHBvcnQgY29uc3QgY3JlYXRlR3JhcGhxbE1vZGVsc0Zyb21TM1VyaUdlbmVyYXRvciA9ICh7XG4gIG1vZGVsU2NoZW1hUzNVcmksXG4gIGF3c0NsaWVudFByb3ZpZGVyLFxufTogR3JhcGhxbE1vZGVsc0Zyb21TM1VyaUdlbmVyYXRvckZhY3RvcnlQYXJhbXMpOiBHcmFwaHFsTW9kZWxzR2VuZXJhdG9yID0+IHtcbiAgaWYgKCFtb2RlbFNjaGVtYVMzVXJpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdgbW9kZWxTY2hlbWFTM1VyaWAgbXVzdCBiZSBkZWZpbmVkJyk7XG4gIH1cbiAgaWYgKCFhd3NDbGllbnRQcm92aWRlcikge1xuICAgIHRocm93IG5ldyBFcnJvcignYGF3c0NsaWVudFByb3ZpZGVyYCBtdXN0IGJlIGRlZmluZWQnKTtcbiAgfVxuICByZXR1cm4gbmV3IFN0YWNrTWV0YWRhdGFHcmFwaHFsTW9kZWxzR2VuZXJhdG9yKFxuICAgICgpID0+IGdldE1vZGVsU2NoZW1hRnJvbVMzVXJpKG1vZGVsU2NoZW1hUzNVcmksIGF3c0NsaWVudFByb3ZpZGVyKSxcbiAgICAoZmlsZU1hcCkgPT4gbmV3IEFwcHN5bmNHcmFwaHFsR2VuZXJhdGlvblJlc3VsdChmaWxlTWFwKVxuICApO1xufTtcblxuY29uc3QgZ2V0TW9kZWxTY2hlbWEgPSBhc3luYyAoXG4gIGJhY2tlbmRJZGVudGlmaWVyOiBEZXBsb3llZEJhY2tlbmRJZGVudGlmaWVyLFxuICBhd3NDbGllbnRQcm92aWRlcjogQVdTQ2xpZW50UHJvdmlkZXI8e1xuICAgIGdldFMzQ2xpZW50OiBTM0NsaWVudDtcbiAgICBnZXRBbXBsaWZ5Q2xpZW50OiBBbXBsaWZ5Q2xpZW50O1xuICAgIGdldENsb3VkRm9ybWF0aW9uQ2xpZW50OiBDbG91ZEZvcm1hdGlvbkNsaWVudDtcbiAgfT5cbik6IFByb21pc2U8c3RyaW5nPiA9PiB7XG4gIGNvbnN0IGJhY2tlbmRPdXRwdXRDbGllbnQgPVxuICAgIEJhY2tlbmRPdXRwdXRDbGllbnRGYWN0b3J5LmdldEluc3RhbmNlKGF3c0NsaWVudFByb3ZpZGVyKTtcbiAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgYmFja2VuZE91dHB1dENsaWVudC5nZXRPdXRwdXQoYmFja2VuZElkZW50aWZpZXIpO1xuICBjb25zdCBtb2RlbFNjaGVtYVMzVXJpID1cbiAgICBvdXRwdXRbZ3JhcGhxbE91dHB1dEtleV0/LnBheWxvYWQuYW1wbGlmeUFwaU1vZGVsU2NoZW1hUzNVcmk7XG4gIGlmICghbW9kZWxTY2hlbWFTM1VyaSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGZpbmQgbW9kZWwgc2NoZW1hIGF0IGFtcGxpZnlBcGlNb2RlbFNjaGVtYVMzVXJpYCk7XG4gIH1cblxuICByZXR1cm4gYXdhaXQgZ2V0TW9kZWxTY2hlbWFGcm9tUzNVcmkobW9kZWxTY2hlbWFTM1VyaSwgYXdzQ2xpZW50UHJvdmlkZXIpO1xufTtcblxuY29uc3QgZ2V0TW9kZWxTY2hlbWFGcm9tUzNVcmkgPSBhc3luYyAoXG4gIG1vZGVsU2NoZW1hUzNVcmk6IHN0cmluZyxcbiAgYXdzQ2xpZW50UHJvdmlkZXI6IEFXU0NsaWVudFByb3ZpZGVyPHtcbiAgICBnZXRTM0NsaWVudDogUzNDbGllbnQ7XG4gIH0+XG4pOiBQcm9taXNlPHN0cmluZz4gPT4ge1xuICBjb25zdCBzY2hlbWFGZXRjaGVyID0gbmV3IFMzU3RyaW5nT2JqZWN0RmV0Y2hlcihcbiAgICBhd3NDbGllbnRQcm92aWRlci5nZXRTM0NsaWVudCgpXG4gICk7XG4gIHJldHVybiBhd2FpdCBzY2hlbWFGZXRjaGVyLmZldGNoKG1vZGVsU2NoZW1hUzNVcmkpO1xufTtcbiJdfQ==